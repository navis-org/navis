<!DOCTYPE html><html lang="en" class="no-js"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Python library for analysis of neuroanatomical data."><link href="../plotting/plotly/graph_objs/" rel="prev"><link href="align/" rel="next"><link rel="icon" href="../../../assets/images/favicon.png"><meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.3"><title>transforms - navis</title><link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css"><link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css"><link rel="stylesheet" href="../../../assets/external/fonts.googleapis.com/css.49ea35f2.css"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel="stylesheet" href="../../../assets/_markdown_exec_pyodide.css"><link rel="stylesheet" href="../../../assets/_mkdocstrings.css"><link rel="stylesheet" href="../../../stylesheets/extra.css"><link rel="stylesheet" href="../../../assets/external/unpkg.com/katex@0/dist/katex.min.css"><link rel="stylesheet" href="../../../sg_gallery.css"><link rel="stylesheet" href="../../../sg_gallery-rendered-html.css"><link rel="stylesheet" href="../../../sg_gallery-binder.css"><link rel="stylesheet" href="../../../sg_gallery-dataframe.css"><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head> <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo"> <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off"> <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off"> <label class="md-overlay" for="__drawer"></label> <div data-md-component="skip"> <a href="#navis.transforms.AffineTransform" class="md-skip"> Skip to content </a> </div> <div data-md-component="announce"> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component="header"> <nav class="md-header__inner md-grid" aria-label="Header"> <a href="../../.." title="navis" class="md-header__button md-logo" aria-label="navis" data-md-component="logo"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg> </a> <label class="md-header__button md-icon" for="__drawer"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg> </label> <div class="md-header__title" data-md-component="header-title"> <div class="md-header__ellipsis"> <div class="md-header__topic"> <span class="md-ellipsis"> navis </span> </div> <div class="md-header__topic" data-md-component="header-topic"> <span class="md-ellipsis"> transforms </span> </div> </div> </div> <form class="md-header__option" data-md-component="palette"> <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo" aria-label="Switch to dark mode" type="radio" name="__palette" id="__palette_0"> <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M296.5 291.1C321 265.2 336 230.4 336 192c0-79.5-64.5-144-144-144S48 112.5 48 192c0 38.4 15 73.2 39.5 99.1 21.3 22.4 44.9 54 53.3 92.9h102.4c8.4-39 32-70.5 53.3-92.9m34.8 33C307.7 349 288 379.4 288 413.7V432c0 44.2-35.8 80-80 80h-32c-44.2 0-80-35.8-80-80v-18.3c0-34.3-19.7-64.7-43.3-89.6C20 289.7 0 243.2 0 192 0 86 86 0 192 0s192 86 192 192c0 51.2-20 97.7-52.7 132.1M144 184c0 13.3-10.7 24-24 24s-24-10.7-24-24c0-48.6 39.4-88 88-88 13.3 0 24 10.7 24 24s-10.7 24-24 24c-22.1 0-40 17.9-40 40"></path></svg> </label> <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="white" data-md-color-accent="pink" aria-label="Switch to light mode" type="radio" name="__palette" id="__palette_1"> <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M292.9 384c7.3-22.3 21.9-42.5 38.4-59.9C364 289.7 384 243.2 384 192 384 86 298 0 192 0S0 86 0 192c0 51.2 20 97.7 52.7 132.1 16.5 17.4 31.2 37.6 38.4 59.9h201.7zm-4.9 48H96v16c0 44.2 35.8 80 80 80h32c44.2 0 80-35.8 80-80zM184 112c-39.8 0-72 32.2-72 72 0 13.3-10.7 24-24 24s-24-10.7-24-24c0-66.3 53.7-120 120-120 13.3 0 24 10.7 24 24s-10.7 24-24 24"></path></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for="__search"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg> </label> <div class="md-search" data-md-component="search" role="dialog"> <label class="md-search__overlay" for="__search"></label> <div class="md-search__inner" role="search"> <form class="md-search__form" name="search"> <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required> <label class="md-search__icon md-icon" for="__search"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg> </label> <nav class="md-search__options" aria-label="Search"> <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg> </button> </nav> </form> <div class="md-search__output"> <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix> <div class="md-search-result" data-md-component="search-result"> <div class="md-search-result__meta"> Initializing search </div> <ol class="md-search-result__list" role="presentation"></ol> </div> </div> </div> </div> </div> <div class="md-header__source"> <a href="https://github.com/navis-org/navis" title="Go to repository" class="md-source" data-md-component="source"> <div class="md-source__icon md-icon"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg> </div> <div class="md-source__repository"> navis-org/navis </div> </a> </div> </nav> <nav class="md-tabs" aria-label="Tabs" data-md-component="tabs"> <div class="md-grid"> <ul class="md-tabs__list"> <li class="md-tabs__item"> <a href="../../.." class="md-tabs__link"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg> Home </a> </li> <li class="md-tabs__item"> <a href="../../../installation/" class="md-tabs__link"> Installation </a> </li> <li class="md-tabs__item"> <a href="../../../quickstart/" class="md-tabs__link"> Quickstart </a> </li> <li class="md-tabs__item"> <a href="../../../generated/gallery/" class="md-tabs__link"> Tutorials </a> </li> <li class="md-tabs__item"> <a href="../../../ecosystem/" class="md-tabs__link"> <span style="color:rgb(250,175,3)">NAVis</span> &amp; Friends </a> </li> <li class="md-tabs__item"> <a href="../../../publications/" class="md-tabs__link"> Publications </a> </li> <li class="md-tabs__item"> <a href="../../../changelog/" class="md-tabs__link"> Changelog </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href="../../../api/" class="md-tabs__link"> API Documentation </a> </li> </ul> </div> </nav> </header> <div class="md-container" data-md-component="container"> <main class="md-main" data-md-component="main"> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation"> <div class="md-sidebar__scrollwrap"> <div class="md-sidebar__inner"> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0"> <label class="md-nav__title" for="__drawer"> <a href="../../.." title="navis" class="md-nav__button md-logo" aria-label="navis" data-md-component="logo"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg> </a> navis </label> <div class="md-nav__source"> <a href="https://github.com/navis-org/navis" title="Go to repository" class="md-source" data-md-component="source"> <div class="md-source__icon md-icon"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg> </div> <div class="md-source__repository"> navis-org/navis </div> </a> </div> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../.." class="md-nav__link"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg> <span class="md-ellipsis"> Home </span> </a> </li> <li class="md-nav__item"> <a href="../../../installation/" class="md-nav__link"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m21.71 20.29-1.42 1.42a1 1 0 0 1-1.41 0L7 9.85A3.8 3.8 0 0 1 6 10a4 4 0 0 1-3.78-5.3l2.54 2.54.53-.53 1.42-1.42.53-.53L4.7 2.22A4 4 0 0 1 10 6a3.8 3.8 0 0 1-.15 1l11.86 11.88a1 1 0 0 1 0 1.41M2.29 18.88a1 1 0 0 0 0 1.41l1.42 1.42a1 1 0 0 0 1.41 0l5.47-5.46-2.83-2.83M20 2l-4 2v2l-2.17 2.17 2 2L18 8h2l2-4Z"></path></svg> <span class="md-ellipsis"> Installation </span> </a> </li> <li class="md-nav__item"> <a href="../../../quickstart/" class="md-nav__link"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m13.13 22.19-1.63-3.83c1.57-.58 3.04-1.36 4.4-2.27zM5.64 12.5l-3.83-1.63 6.1-2.77C7 9.46 6.22 10.93 5.64 12.5M21.61 2.39S16.66.269 11 5.93c-2.19 2.19-3.5 4.6-4.35 6.71-.28.75-.09 1.57.46 2.13l2.13 2.12c.55.56 1.37.74 2.12.46A19.1 19.1 0 0 0 18.07 13c5.66-5.66 3.54-10.61 3.54-10.61m-7.07 7.07c-.78-.78-.78-2.05 0-2.83s2.05-.78 2.83 0c.77.78.78 2.05 0 2.83s-2.05.78-2.83 0m-5.66 7.07-1.41-1.41zM6.24 22l3.64-3.64c-.34-.09-.67-.24-.97-.45L4.83 22zM2 22h1.41l4.77-4.76-1.42-1.41L2 20.59zm0-2.83 4.09-4.08c-.21-.3-.36-.62-.45-.97L2 17.76z"></path></svg> <span class="md-ellipsis"> Quickstart </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4"> <div class="md-nav__link md-nav__container"> <a href="../../../generated/gallery/" class="md-nav__link "> <span class="md-ellipsis"> Tutorials </span> </a> <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_4"> <span class="md-nav__icon md-icon"></span> Tutorials </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2"> <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0"> <span class="md-ellipsis"> General Tutorials </span> <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_4_2"> <span class="md-nav__icon md-icon"></span> General Tutorials </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../../generated/gallery/tutorial_basic_00_basics/" class="md-nav__link"> <span class="md-ellipsis"> The Basics </span> </a> </li> <li class="md-nav__item"> <a href="../../../generated/gallery/tutorial_basic_01_neurons/" class="md-nav__link"> <span class="md-ellipsis"> Neuron Types </span> </a> </li> <li class="md-nav__item"> <a href="../../../generated/gallery/tutorial_basic_02_neuronlists/" class="md-nav__link"> <span class="md-ellipsis"> Lists of Neurons </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3"> <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0"> <span class="md-ellipsis"> Import / Export </span> <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_4_3"> <span class="md-nav__icon md-icon"></span> Import / Export </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../../generated/gallery/0_io/tutorial_io_00_skeletons/" class="md-nav__link"> <span class="md-ellipsis"> Skeletons </span> </a> </li> <li class="md-nav__item"> <a href="../../../generated/gallery/0_io/tutorial_io_01_meshes/" class="md-nav__link"> <span class="md-ellipsis"> Meshes </span> </a> </li> <li class="md-nav__item"> <a href="../../../generated/gallery/0_io/tutorial_io_02_dotprops/" class="md-nav__link"> <span class="md-ellipsis"> Dotprops </span> </a> </li> <li class="md-nav__item"> <a href="../../../generated/gallery/0_io/tutorial_io_04_pickle/" class="md-nav__link"> <span class="md-ellipsis"> Pickling </span> </a> </li> <li class="md-nav__item"> <a href="../../../generated/gallery/0_io/zzz_tutorial_io_05_skeletonize/" class="md-nav__link"> <span class="md-ellipsis"> Skeletons from light-level data </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4"> <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0"> <span class="md-ellipsis"> Plotting </span> <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_4_4"> <span class="md-nav__icon md-icon"></span> Plotting </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../../generated/gallery/1_plotting/tutorial_plotting_00_intro/" class="md-nav__link"> <span class="md-ellipsis"> Plotting Overview </span> </a> </li> <li class="md-nav__item"> <a href="../../../generated/gallery/1_plotting/tutorial_plotting_01_colors/" class="md-nav__link"> <span class="md-ellipsis"> Coloring </span> </a> </li> <li class="md-nav__item"> <a href="../../../generated/gallery/1_plotting/tutorial_plotting_02_1d/" class="md-nav__link"> <span class="md-ellipsis"> Neuron "Barcodes" </span> </a> </li> <li class="md-nav__item"> <a href="../../../generated/gallery/1_plotting/tutorial_plotting_03_dend/" class="md-nav__link"> <span class="md-ellipsis"> Neuron Topology </span> </a> </li> <li class="md-nav__item"> <a href="../../../generated/gallery/1_plotting/tutorial_plotting_04_skeletons/" class="md-nav__link"> <span class="md-ellipsis"> Fine-tuning Skeletons </span> </a> </li> <li class="md-nav__item"> <a href="../../../generated/gallery/1_plotting/tutorial_plotting_05_depth/" class="md-nav__link"> <span class="md-ellipsis"> Depth-coloring </span> </a> </li> <li class="md-nav__item"> <a href="../../../generated/gallery/1_plotting/tutorial_plotting_06_cortex/" class="md-nav__link"> <span class="md-ellipsis"> Cortical Neurons </span> </a> </li> <li class="md-nav__item"> <a href="../../../generated/gallery/1_plotting/tutorial_plotting_07_xkcd/" class="md-nav__link"> <span class="md-ellipsis"> XKCD Style </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_5"> <label class="md-nav__link" for="__nav_4_5" id="__nav_4_5_label" tabindex="0"> <span class="md-ellipsis"> Morphology </span> <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_5_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_4_5"> <span class="md-nav__icon md-icon"></span> Morphology </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../../generated/gallery/2_morpho/tutorial_morpho_00_manipulate/" class="md-nav__link"> <span class="md-ellipsis"> Manipulate Morphology </span> </a> </li> <li class="md-nav__item"> <a href="../../../generated/gallery/2_morpho/tutorial_morpho_01_analyze/" class="md-nav__link"> <span class="md-ellipsis"> Analyzing Neuron Morphology </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_6"> <label class="md-nav__link" for="__nav_4_6" id="__nav_4_6_label" tabindex="0"> <span class="md-ellipsis"> Interfaces </span> <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_6_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_4_6"> <span class="md-nav__icon md-icon"></span> Interfaces </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../../generated/gallery/3_interfaces/tutorial_interfaces_00_neuron/" class="md-nav__link"> <span class="md-ellipsis"> NEURON simulator </span> </a> </li> <li class="md-nav__item"> <a href="../../../generated/gallery/3_interfaces/tutorial_interfaces_01_neuron2/" class="md-nav__link"> <span class="md-ellipsis"> Visualize NEURON model </span> </a> </li> <li class="md-nav__item"> <a href="../../../generated/gallery/3_interfaces/tutorial_interfaces_02_blender/" class="md-nav__link"> <span class="md-ellipsis"> Blender 3D </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_7"> <label class="md-nav__link" for="__nav_4_7" id="__nav_4_7_label" tabindex="0"> <span class="md-ellipsis"> Remote Data Sources </span> <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_7_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_4_7"> <span class="md-nav__icon md-icon"></span> Remote Data Sources </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../../generated/gallery/4_remote/tutorial_remote_00_neuprint/" class="md-nav__link"> <span class="md-ellipsis"> neuPrint </span> </a> </li> <li class="md-nav__item"> <a href="../../../generated/gallery/4_remote/tutorial_remote_01_cloudvolume/" class="md-nav__link"> <span class="md-ellipsis"> Neuroglancer &amp; CloudVolume </span> </a> </li> <li class="md-nav__item"> <a href="../../../generated/gallery/4_remote/tutorial_remote_02_microns/" class="md-nav__link"> <span class="md-ellipsis"> The MICrONS Datasets </span> </a> </li> <li class="md-nav__item"> <a href="../../../generated/gallery/4_remote/tutorial_remote_03_insect_db/" class="md-nav__link"> <span class="md-ellipsis"> Insect Brain DB </span> </a> </li> <li class="md-nav__item"> <a href="../../../generated/gallery/4_remote/tutorial_remote_04_h01/" class="md-nav__link"> <span class="md-ellipsis"> H01 Dataset </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_8"> <label class="md-nav__link" for="__nav_4_8" id="__nav_4_8_label" tabindex="0"> <span class="md-ellipsis"> NBLAST </span> <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_8_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_4_8"> <span class="md-nav__icon md-icon"></span> NBLAST </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../../generated/gallery/5_nblast/tutorial_nblast_00_intro/" class="md-nav__link"> <span class="md-ellipsis"> NBLAST </span> </a> </li> <li class="md-nav__item"> <a href="../../../generated/gallery/5_nblast/tutorial_nblast_03_smat/" class="md-nav__link"> <span class="md-ellipsis"> Custom score matrices </span> </a> </li> <li class="md-nav__item"> <a href="../../../generated/gallery/5_nblast/zzz_tutorial_nblast_01_flycircuit/" class="md-nav__link"> <span class="md-ellipsis"> NBLAST against FlyCircuit </span> </a> </li> <li class="md-nav__item"> <a href="../../../generated/gallery/5_nblast/zzz_tutorial_nblast_02_hemibrain/" class="md-nav__link"> <span class="md-ellipsis"> NBLAST using light-level data </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_9"> <label class="md-nav__link" for="__nav_4_9" id="__nav_4_9_label" tabindex="0"> <span class="md-ellipsis"> Misc </span> <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_9_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_4_9"> <span class="md-nav__icon md-icon"></span> Misc </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../../../generated/gallery/6_misc/tutorial_misc_00_multiprocess/" class="md-nav__link"> <span class="md-ellipsis"> Multiprocessing </span> </a> </li> <li class="md-nav__item"> <a href="../../../generated/gallery/6_misc/tutorial_misc_01_transforms/" class="md-nav__link"> <span class="md-ellipsis"> Transformations </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="../../../ecosystem/" class="md-nav__link"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12 21.35-1.45-1.32C5.4 15.36 2 12.27 2 8.5 2 5.41 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.08C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.41 22 8.5c0 3.77-3.4 6.86-8.55 11.53z"></path></svg> <span class="md-ellipsis"> <span style="color:rgb(250,175,3)">NAVis</span> &amp; Friends </span> </a> </li> <li class="md-nav__item"> <a href="../../../publications/" class="md-nav__link"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 22a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2h-6v7L9.5 7.5 7 9V2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2z"></path></svg> <span class="md-ellipsis"> Publications </span> </a> </li> <li class="md-nav__item"> <a href="../../../changelog/" class="md-nav__link"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.803.179Q8.76.171 7.72.38C5.639.797 3.974 1.828 2.77 3.445 1.232 5.515.367 8.072.049 11.492c-.125 1.353.008 2.711.181 4.216a9.97 9.97 0 0 0 2.144 5.214c.933 1.157 2.004 1.917 3.272 2.324a12 12 0 0 0 3.336.574 6 6 0 0 0 .795-.034l.416-.041a93 93 0 0 0 1.721-.186 21.4 21.4 0 0 0 7.393-2.257c2.007-1.048 3.41-2.594 4.17-4.597.354-.93.523-1.713.523-2.445a4.6 4.6 0 0 0-.064-.762c-.405-2.379-1.235-4.428-2.555-6.264-1.634-2.276-3.288-3.878-5.202-5.045C13.993.86 11.89.193 9.803.18Zm-.439 1.064q1.154-.032 2.376.237h-.001c2.73.597 5.137 2.002 7.154 4.173 2.288 2.46 3.591 5.045 3.988 7.899.071.528-.013 1.114-.096 1.622-.388 2.327-1.663 4.063-3.786 5.16a21 21 0 0 1-7.166 2.182c-.558.066-1.12.123-1.757.187l-.088.01a6.8 6.8 0 0 1-1.658-.03c-.69-.098-1.472-.21-2.224-.389-1.767-.42-3.069-1.622-3.978-3.658-.684-1.538-1.038-3.245-1.081-5.233a17.9 17.9 0 0 1 1.149-6.798c.62-1.641 1.517-3.453 3.462-4.418a8.75 8.75 0 0 1 3.706-.944m1.108 1.47a7.8 7.8 0 0 0-2.24.41c-1.6.525-2.718 1.304-3.523 2.438-1.499 2.118-2.275 4.58-2.31 7.325a10.1 10.1 0 0 0 .803 4.388c1.081 2.569 3.053 4.064 5.707 4.326 2.796.27 5.543-.381 8.178-1.937a8.1 8.1 0 0 0 2.772-2.624 7.1 7.1 0 0 0 1.168-3.86c0-2.162-1.015-4.47-3.049-6.862a6.4 6.4 0 0 0-.704-.707c-2.333-2.006-4.567-2.966-6.802-2.898zm.099 1.035c1.492-.022 3.015.475 4.672 1.508 1.783 1.117 3.161 2.763 4.091 4.909.887 2.02.905 3.938.058 5.696a6.8 6.8 0 0 1-2.907 2.988c-2.253 1.232-4.315 1.776-6.458 1.713h-.022c-1.55.06-2.89-.32-4.098-1.163-.7-.488-1.241-1.202-1.655-2.183a10.9 10.9 0 0 1-.872-4.273A12.7 12.7 0 0 1 4.404 8.09a12 12 0 0 1 .874-1.622l.163-.27c.67-1.108 1.725-1.639 3.103-2.099a6.8 6.8 0 0 1 2.027-.35zm.03 1.62c-1.18.037-2.28.465-3.289 1.283-1.395 1.13-2.23 2.72-2.63 4.993a7.24 7.24 0 0 0 .676 4.613c1.062 2.054 2.8 3.11 5.026 3.05h.008c2.958-.155 5.11-1.249 6.573-3.347a5.6 5.6 0 0 0 1.06-3.245 5.8 5.8 0 0 0-.242-1.639c-.72-2.435-2.161-4.145-4.29-5.085q-1.514-.667-2.892-.624Zm.312 1.064c.77.008 1.547.191 2.35.55 1.862.833 3.073 2.332 3.598 4.462.526 2.13-.27 4.205-2.066 5.423-1.479.999-2.93 1.447-4.438 1.367h-.04c-1.004.08-1.994-.226-2.943-.91a3.67 3.67 0 0 1-1.29-1.72 7.6 7.6 0 0 1-.514-2.727 8.5 8.5 0 0 1 .747-3.38c.676-1.556 1.724-2.503 3.215-2.893q.69-.18 1.38-.172zM9.455 8.758v6.882h1.155v-1.908l1.68 1.908h1.462l-2.273-2.5 1.871-1.958h-1.509l-1.231 1.337V8.758Z"></path></svg> <span class="md-ellipsis"> Changelog </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked> <div class="md-nav__link md-nav__container"> <a href="../../../api/" class="md-nav__link "> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m15.07 11.25-.9.92C13.45 12.89 13 13.5 13 15h-2v-.5c0-1.11.45-2.11 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41a2 2 0 0 0-2-2 2 2 0 0 0-2 2H8a4 4 0 0 1 4-4 4 4 0 0 1 4 4 3.2 3.2 0 0 1-.93 2.25M13 19h-2v-2h2M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10c0-5.53-4.5-10-10-10"></path></svg> <span class="md-ellipsis"> API Documentation </span> </a> <label class="md-nav__link " for="__nav_8" id="__nav_8_label" tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true"> <label class="md-nav__title" for="__nav_8"> <span class="md-nav__icon md-icon"></span> API Documentation </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1" checked> <label class="md-nav__link" for="__nav_8_1" id="__nav_8_1_label" tabindex="0"> <span class="md-ellipsis"> Code References </span> <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_1_label" aria-expanded="true"> <label class="md-nav__title" for="__nav_8_1"> <span class="md-nav__icon md-icon"></span> Code References </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1_1" checked> <div class="md-nav__link md-nav__container"> <a href="../" class="md-nav__link "> <span class="md-ellipsis"> navis </span> </a> <label class="md-nav__link " for="__nav_8_1_1" id="__nav_8_1_1_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_8_1_1_label" aria-expanded="true"> <label class="md-nav__title" for="__nav_8_1_1"> <span class="md-nav__icon md-icon"></span> navis </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../config/" class="md-nav__link"> <span class="md-ellipsis"> config </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1_1_2"> <div class="md-nav__link md-nav__container"> <a href="../connectivity/" class="md-nav__link "> <span class="md-ellipsis"> connectivity </span> </a> <label class="md-nav__link " for="__nav_8_1_1_2" id="__nav_8_1_1_2_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_8_1_1_2_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_8_1_1_2"> <span class="md-nav__icon md-icon"></span> connectivity </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../connectivity/adjacency/" class="md-nav__link"> <span class="md-ellipsis"> adjacency </span> </a> </li> <li class="md-nav__item"> <a href="../connectivity/similarity/" class="md-nav__link"> <span class="md-ellipsis"> similarity </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1_1_3"> <div class="md-nav__link md-nav__container"> <a href="../conversion/" class="md-nav__link "> <span class="md-ellipsis"> conversion </span> </a> <label class="md-nav__link " for="__nav_8_1_1_3" id="__nav_8_1_1_3_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_8_1_1_3_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_8_1_1_3"> <span class="md-nav__icon md-icon"></span> conversion </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../conversion/meshing/" class="md-nav__link"> <span class="md-ellipsis"> meshing </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1_1_4"> <div class="md-nav__link md-nav__container"> <a href="../core/" class="md-nav__link "> <span class="md-ellipsis"> core </span> </a> <label class="md-nav__link " for="__nav_8_1_1_4" id="__nav_8_1_1_4_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_8_1_1_4_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_8_1_1_4"> <span class="md-nav__icon md-icon"></span> core </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../core/base/" class="md-nav__link"> <span class="md-ellipsis"> base </span> </a> </li> <li class="md-nav__item"> <a href="../core/core_utils/" class="md-nav__link"> <span class="md-ellipsis"> core_utils </span> </a> </li> <li class="md-nav__item"> <a href="../core/skeleton/" class="md-nav__link"> <span class="md-ellipsis"> skeleton </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1_1_5"> <div class="md-nav__link md-nav__container"> <a href="../graph/" class="md-nav__link "> <span class="md-ellipsis"> graph </span> </a> <label class="md-nav__link " for="__nav_8_1_1_5" id="__nav_8_1_1_5_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_8_1_1_5_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_8_1_1_5"> <span class="md-nav__icon md-icon"></span> graph </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../graph/graph_utils/" class="md-nav__link"> <span class="md-ellipsis"> graph_utils </span> </a> </li> <li class="md-nav__item"> <a href="../graph/clinic/" class="md-nav__link"> <span class="md-ellipsis"> clinic </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1_1_6"> <div class="md-nav__link md-nav__container"> <a href="../meshes/" class="md-nav__link "> <span class="md-ellipsis"> meshes </span> </a> <label class="md-nav__link " for="__nav_8_1_1_6" id="__nav_8_1_1_6_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_8_1_1_6_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_8_1_1_6"> <span class="md-nav__icon md-icon"></span> meshes </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../meshes/b3d/" class="md-nav__link"> <span class="md-ellipsis"> b3d </span> </a> </li> <li class="md-nav__item"> <a href="../meshes/mesh_utils/" class="md-nav__link"> <span class="md-ellipsis"> mesh_utils </span> </a> </li> <li class="md-nav__item"> <a href="../meshes/o3d/" class="md-nav__link"> <span class="md-ellipsis"> o3d </span> </a> </li> <li class="md-nav__item"> <a href="../meshes/operations/" class="md-nav__link"> <span class="md-ellipsis"> operations </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1_1_7"> <div class="md-nav__link md-nav__container"> <a href="../models/" class="md-nav__link "> <span class="md-ellipsis"> models </span> </a> <label class="md-nav__link " for="__nav_8_1_1_7" id="__nav_8_1_1_7_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_8_1_1_7_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_8_1_1_7"> <span class="md-nav__icon md-icon"></span> models </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../models/network_models/" class="md-nav__link"> <span class="md-ellipsis"> network_models </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1_1_8"> <div class="md-nav__link md-nav__container"> <a href="../morpho/" class="md-nav__link "> <span class="md-ellipsis"> morpho </span> </a> <label class="md-nav__link " for="__nav_8_1_1_8" id="__nav_8_1_1_8_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_8_1_1_8_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_8_1_1_8"> <span class="md-nav__icon md-icon"></span> morpho </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../morpho/ivscc/" class="md-nav__link"> <span class="md-ellipsis"> ivscc </span> </a> </li> <li class="md-nav__item"> <a href="../morpho/mmetrics/" class="md-nav__link"> <span class="md-ellipsis"> mmetrics </span> </a> </li> <li class="md-nav__item"> <a href="../morpho/persistence/" class="md-nav__link"> <span class="md-ellipsis"> persistence </span> </a> </li> <li class="md-nav__item"> <a href="../morpho/subset/" class="md-nav__link"> <span class="md-ellipsis"> subset </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1_1_9"> <div class="md-nav__link md-nav__container"> <a href="../nbl/" class="md-nav__link "> <span class="md-ellipsis"> nbl </span> </a> <label class="md-nav__link " for="__nav_8_1_1_9" id="__nav_8_1_1_9_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_8_1_1_9_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_8_1_1_9"> <span class="md-nav__icon md-icon"></span> nbl </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../nbl/ablast_funcs/" class="md-nav__link"> <span class="md-ellipsis"> ablast_funcs </span> </a> </li> <li class="md-nav__item"> <a href="../nbl/nblast_funcs/" class="md-nav__link"> <span class="md-ellipsis"> nblast_funcs </span> </a> </li> <li class="md-nav__item"> <a href="../nbl/smat/" class="md-nav__link"> <span class="md-ellipsis"> smat </span> </a> </li> <li class="md-nav__item"> <a href="../nbl/synblast_funcs/" class="md-nav__link"> <span class="md-ellipsis"> synblast_funcs </span> </a> </li> <li class="md-nav__item"> <a href="../nbl/utils/" class="md-nav__link"> <span class="md-ellipsis"> utils </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1_1_10"> <div class="md-nav__link md-nav__container"> <a href="../plotting/" class="md-nav__link "> <span class="md-ellipsis"> plotting </span> </a> <label class="md-nav__link " for="__nav_8_1_1_10" id="__nav_8_1_1_10_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_8_1_1_10_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_8_1_1_10"> <span class="md-nav__icon md-icon"></span> plotting </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../plotting/colors/" class="md-nav__link"> <span class="md-ellipsis"> colors </span> </a> </li> <li class="md-nav__item"> <a href="../plotting/dd/" class="md-nav__link"> <span class="md-ellipsis"> dd </span> </a> </li> <li class="md-nav__item"> <a href="../plotting/ddd/" class="md-nav__link"> <span class="md-ellipsis"> ddd </span> </a> </li> <li class="md-nav__item"> <a href="../plotting/plot_utils/" class="md-nav__link"> <span class="md-ellipsis"> plot_utils </span> </a> </li> <li class="md-nav__item"> <a href="../plotting/settings/" class="md-nav__link"> <span class="md-ellipsis"> settings </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1_1_10_6"> <label class="md-nav__link" for="__nav_8_1_1_10_6" id="__nav_8_1_1_10_6_label" tabindex="0"> <span class="md-ellipsis"> vispy </span> <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_8_1_1_10_6_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_8_1_1_10_6"> <span class="md-nav__icon md-icon"></span> vispy </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../plotting/vispy/viewer/" class="md-nav__link"> <span class="md-ellipsis"> viewer </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1_1_10_7"> <label class="md-nav__link" for="__nav_8_1_1_10_7" id="__nav_8_1_1_10_7_label" tabindex="0"> <span class="md-ellipsis"> k3d </span> <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_8_1_1_10_7_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_8_1_1_10_7"> <span class="md-nav__icon md-icon"></span> k3d </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../plotting/k3d/k3d_objects/" class="md-nav__link"> <span class="md-ellipsis"> k3d_objects </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1_1_10_8"> <label class="md-nav__link" for="__nav_8_1_1_10_8" id="__nav_8_1_1_10_8_label" tabindex="0"> <span class="md-ellipsis"> plotly </span> <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_8_1_1_10_8_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_8_1_1_10_8"> <span class="md-nav__icon md-icon"></span> plotly </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../plotting/plotly/graph_objs/" class="md-nav__link"> <span class="md-ellipsis"> graph_objs </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1_1_11" checked> <div class="md-nav__link md-nav__container"> <a href="./" class="md-nav__link md-nav__link--active"> <span class="md-ellipsis"> transforms </span> </a> <label class="md-nav__link md-nav__link--active" for="__nav_8_1_1_11" id="__nav_8_1_1_11_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_8_1_1_11_label" aria-expanded="true"> <label class="md-nav__title" for="__nav_8_1_1_11"> <span class="md-nav__icon md-icon"></span> transforms </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="align/" class="md-nav__link"> <span class="md-ellipsis"> align </span> </a> </li> <li class="md-nav__item"> <a href="affine/" class="md-nav__link"> <span class="md-ellipsis"> affine </span> </a> </li> <li class="md-nav__item"> <a href="base/" class="md-nav__link"> <span class="md-ellipsis"> base </span> </a> </li> <li class="md-nav__item"> <a href="cmtk/" class="md-nav__link"> <span class="md-ellipsis"> cmtk </span> </a> </li> <li class="md-nav__item"> <a href="elastix/" class="md-nav__link"> <span class="md-ellipsis"> elastix </span> </a> </li> <li class="md-nav__item"> <a href="factory/" class="md-nav__link"> <span class="md-ellipsis"> factory </span> </a> </li> <li class="md-nav__item"> <a href="h5reg/" class="md-nav__link"> <span class="md-ellipsis"> h5reg </span> </a> </li> <li class="md-nav__item"> <a href="templates/" class="md-nav__link"> <span class="md-ellipsis"> templates </span> </a> </li> <li class="md-nav__item"> <a href="thinplate/" class="md-nav__link"> <span class="md-ellipsis"> thinplate </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1_1_12"> <div class="md-nav__link md-nav__container"> <a href="../utils/" class="md-nav__link "> <span class="md-ellipsis"> utils </span> </a> <label class="md-nav__link " for="__nav_8_1_1_12" id="__nav_8_1_1_12_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_8_1_1_12_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_8_1_1_12"> <span class="md-nav__icon md-icon"></span> utils </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../utils/cv/" class="md-nav__link"> <span class="md-ellipsis"> cv </span> </a> </li> <li class="md-nav__item"> <a href="../utils/decorators/" class="md-nav__link"> <span class="md-ellipsis"> decorators </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1_1_13"> <label class="md-nav__link" for="__nav_8_1_1_13" id="__nav_8_1_1_13_label" tabindex="0"> <span class="md-ellipsis"> intersection </span> <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_8_1_1_13_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_8_1_1_13"> <span class="md-nav__icon md-icon"></span> intersection </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../intersection/intersect/" class="md-nav__link"> <span class="md-ellipsis"> intersect </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1_1_14"> <label class="md-nav__link" for="__nav_8_1_1_14" id="__nav_8_1_1_14_label" tabindex="0"> <span class="md-ellipsis"> interfaces </span> <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_8_1_1_14_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_8_1_1_14"> <span class="md-nav__icon md-icon"></span> interfaces </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../interfaces/blender/" class="md-nav__link"> <span class="md-ellipsis"> blender </span> </a> </li> <li class="md-nav__item"> <a href="../interfaces/cave_utils/" class="md-nav__link"> <span class="md-ellipsis"> cave_utils </span> </a> </li> <li class="md-nav__item"> <a href="../interfaces/h01/" class="md-nav__link"> <span class="md-ellipsis"> h01 </span> </a> </li> <li class="md-nav__item"> <a href="../interfaces/insectbrain_db/" class="md-nav__link"> <span class="md-ellipsis"> insectbrain_db </span> </a> </li> <li class="md-nav__item"> <a href="../interfaces/microns/" class="md-nav__link"> <span class="md-ellipsis"> microns </span> </a> </li> <li class="md-nav__item"> <a href="../interfaces/neuprint/" class="md-nav__link"> <span class="md-ellipsis"> neuprint </span> </a> </li> <li class="md-nav__item"> <a href="../interfaces/neuromorpho/" class="md-nav__link"> <span class="md-ellipsis"> neuromorpho </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1_1_14_8"> <div class="md-nav__link md-nav__container"> <a href="../interfaces/neuron/" class="md-nav__link "> <span class="md-ellipsis"> neuron </span> </a> <label class="md-nav__link " for="__nav_8_1_1_14_8" id="__nav_8_1_1_14_8_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_8_1_1_14_8_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_8_1_1_14_8"> <span class="md-nav__icon md-icon"></span> neuron </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../interfaces/neuron/comp/" class="md-nav__link"> <span class="md-ellipsis"> comp </span> </a> </li> <li class="md-nav__item"> <a href="../interfaces/neuron/network/" class="md-nav__link"> <span class="md-ellipsis"> network </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1_1_15"> <label class="md-nav__link" for="__nav_8_1_1_15" id="__nav_8_1_1_15_label" tabindex="0"> <span class="md-ellipsis"> io </span> <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_8_1_1_15_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_8_1_1_15"> <span class="md-nav__icon md-icon"></span> io </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../io/base/" class="md-nav__link"> <span class="md-ellipsis"> base </span> </a> </li> <li class="md-nav__item"> <a href="../io/hdf_io/" class="md-nav__link"> <span class="md-ellipsis"> hdf_io </span> </a> </li> <li class="md-nav__item"> <a href="../io/mesh_io/" class="md-nav__link"> <span class="md-ellipsis"> mesh_io </span> </a> </li> <li class="md-nav__item"> <a href="../io/nmx_io/" class="md-nav__link"> <span class="md-ellipsis"> nmx_io </span> </a> </li> <li class="md-nav__item"> <a href="../io/nrrd_io/" class="md-nav__link"> <span class="md-ellipsis"> nrrd_io </span> </a> </li> <li class="md-nav__item"> <a href="../io/precomputed_io/" class="md-nav__link"> <span class="md-ellipsis"> precomputed_io </span> </a> </li> <li class="md-nav__item"> <a href="../io/rda_io/" class="md-nav__link"> <span class="md-ellipsis"> rda_io </span> </a> </li> <li class="md-nav__item"> <a href="../io/swc_io/" class="md-nav__link"> <span class="md-ellipsis"> swc_io </span> </a> </li> <li class="md-nav__item"> <a href="../io/tiff_io/" class="md-nav__link"> <span class="md-ellipsis"> tiff_io </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1_1_16"> <label class="md-nav__link" for="__nav_8_1_1_16" id="__nav_8_1_1_16_label" tabindex="0"> <span class="md-ellipsis"> sampling </span> <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_8_1_1_16_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_8_1_1_16"> <span class="md-nav__icon md-icon"></span> sampling </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../sampling/downsampling/" class="md-nav__link"> <span class="md-ellipsis"> downsampling </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc"> <div class="md-sidebar__scrollwrap"> <div class="md-sidebar__inner"> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class="md-nav__title" for="__toc"> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix> <li class="md-nav__item"> <a href="#navis.transforms.AffineTransform" class="md-nav__link"> <span class="md-ellipsis"> AffineTransform </span> </a> <nav class="md-nav" aria-label="AffineTransform"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#navis.transforms.AffineTransform.__init__" class="md-nav__link"> <span class="md-ellipsis"> __init__ </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.AffineTransform.copy" class="md-nav__link"> <span class="md-ellipsis"> copy </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.AffineTransform.xform" class="md-nav__link"> <span class="md-ellipsis"> xform </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#navis.transforms.AliasTransform" class="md-nav__link"> <span class="md-ellipsis"> AliasTransform </span> </a> <nav class="md-nav" aria-label="AliasTransform"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#navis.transforms.AliasTransform.__init__" class="md-nav__link"> <span class="md-ellipsis"> __init__ </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.AliasTransform.copy" class="md-nav__link"> <span class="md-ellipsis"> copy </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.AliasTransform.xform" class="md-nav__link"> <span class="md-ellipsis"> xform </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#navis.transforms.CMTKtransform" class="md-nav__link"> <span class="md-ellipsis"> CMTKtransform </span> </a> <nav class="md-nav" aria-label="CMTKtransform"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#navis.transforms.CMTKtransform.regargs" class="md-nav__link"> <span class="md-ellipsis"> regargs </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.CMTKtransform.append" class="md-nav__link"> <span class="md-ellipsis"> append </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.CMTKtransform.check_if_possible" class="md-nav__link"> <span class="md-ellipsis"> check_if_possible </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.CMTKtransform.copy" class="md-nav__link"> <span class="md-ellipsis"> copy </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.CMTKtransform.from_file" class="md-nav__link"> <span class="md-ellipsis"> from_file </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.CMTKtransform.make_args" class="md-nav__link"> <span class="md-ellipsis"> make_args </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.CMTKtransform.parse_cmtk_output" class="md-nav__link"> <span class="md-ellipsis"> parse_cmtk_output </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.CMTKtransform.to_dfield" class="md-nav__link"> <span class="md-ellipsis"> to_dfield </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.CMTKtransform.to_grid_transform" class="md-nav__link"> <span class="md-ellipsis"> to_grid_transform </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.CMTKtransform.xform" class="md-nav__link"> <span class="md-ellipsis"> xform </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.CMTKtransform.xform_image" class="md-nav__link"> <span class="md-ellipsis"> xform_image </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#navis.transforms.ElastixTransform" class="md-nav__link"> <span class="md-ellipsis"> ElastixTransform </span> </a> <nav class="md-nav" aria-label="ElastixTransform"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#navis.transforms.ElastixTransform.check_if_possible" class="md-nav__link"> <span class="md-ellipsis"> check_if_possible </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.ElastixTransform.copy" class="md-nav__link"> <span class="md-ellipsis"> copy </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.ElastixTransform.read_output_file" class="md-nav__link"> <span class="md-ellipsis"> read_output_file </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.ElastixTransform.write_input_file" class="md-nav__link"> <span class="md-ellipsis"> write_input_file </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.ElastixTransform.xform" class="md-nav__link"> <span class="md-ellipsis"> xform </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#navis.transforms.FunctionTransform" class="md-nav__link"> <span class="md-ellipsis"> FunctionTransform </span> </a> <nav class="md-nav" aria-label="FunctionTransform"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#navis.transforms.FunctionTransform.__init__" class="md-nav__link"> <span class="md-ellipsis"> __init__ </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.FunctionTransform.copy" class="md-nav__link"> <span class="md-ellipsis"> copy </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.FunctionTransform.xform" class="md-nav__link"> <span class="md-ellipsis"> xform </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#navis.transforms.GridTransform" class="md-nav__link"> <span class="md-ellipsis"> GridTransform </span> </a> <nav class="md-nav" aria-label="GridTransform"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#navis.transforms.GridTransform.affine" class="md-nav__link"> <span class="md-ellipsis"> affine </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.GridTransform.shape" class="md-nav__link"> <span class="md-ellipsis"> shape </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.GridTransform.__init__" class="md-nav__link"> <span class="md-ellipsis"> __init__ </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.GridTransform.calculate_affine" class="md-nav__link"> <span class="md-ellipsis"> calculate_affine </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.GridTransform.copy" class="md-nav__link"> <span class="md-ellipsis"> copy </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.GridTransform.from_file" class="md-nav__link"> <span class="md-ellipsis"> from_file </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.GridTransform.from_warpfield" class="md-nav__link"> <span class="md-ellipsis"> from_warpfield </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.GridTransform.xform" class="md-nav__link"> <span class="md-ellipsis"> xform </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#navis.transforms.H5transform" class="md-nav__link"> <span class="md-ellipsis"> H5transform </span> </a> <nav class="md-nav" aria-label="H5transform"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#navis.transforms.H5transform.quantization_multiplier" class="md-nav__link"> <span class="md-ellipsis"> quantization_multiplier </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.H5transform.shape" class="md-nav__link"> <span class="md-ellipsis"> shape </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.H5transform.spacing" class="md-nav__link"> <span class="md-ellipsis"> spacing </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.H5transform.use_cache" class="md-nav__link"> <span class="md-ellipsis"> use_cache </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.H5transform.__init__" class="md-nav__link"> <span class="md-ellipsis"> __init__ </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.H5transform.copy" class="md-nav__link"> <span class="md-ellipsis"> copy </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.H5transform.from_file" class="md-nav__link"> <span class="md-ellipsis"> from_file </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.H5transform.full_ingest" class="md-nav__link"> <span class="md-ellipsis"> full_ingest </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.H5transform.precache" class="md-nav__link"> <span class="md-ellipsis"> precache </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.H5transform.xform" class="md-nav__link"> <span class="md-ellipsis"> xform </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.H5transform.xform_image" class="md-nav__link"> <span class="md-ellipsis"> xform_image </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#navis.transforms.TPStransform" class="md-nav__link"> <span class="md-ellipsis"> TPStransform </span> </a> <nav class="md-nav" aria-label="TPStransform"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#navis.transforms.TPStransform.matrix_rigid" class="md-nav__link"> <span class="md-ellipsis"> matrix_rigid </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.TPStransform.__init__" class="md-nav__link"> <span class="md-ellipsis"> __init__ </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.TPStransform.copy" class="md-nav__link"> <span class="md-ellipsis"> copy </span> </a> </li> <li class="md-nav__item"> <a href="#navis.transforms.TPStransform.xform" class="md-nav__link"> <span class="md-ellipsis"> xform </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-content" data-md-component="content"> <article class="md-content__inner md-typeset"> <h1>transforms</h1> <div class="doc doc-object doc-class"> <h2 id="navis.transforms.AffineTransform" class="doc doc-heading"> <code>navis.transforms.AffineTransform</code> <a href="#navis.transforms.AffineTransform" class="headerlink" title="Permanent link">#</a></h2> <div class="doc doc-contents first"> <p>Affine transformation of 3D spatial data.</p> <table> <thead> <tr> <th><span class="doc-section-title">PARAMETER</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>matrix</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        Affine matrix.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> (4, 4) np.ndarray</code> </span> </p> </td> </tr> </tbody> </table> <p><span class="doc-section-title">Examples:</span></p> <p>A simple scaling transform</p> <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">navis</span><span class="w"> </span><span class="kn">import</span> <span class="n">transforms</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mf">1e3</span><span class="p">,</span> <span class="mf">1e3</span><span class="p">,</span> <span class="mf">1e3</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">tr</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">affine</span><span class="o">.</span><span class="n">AffineTransform</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">tr</span><span class="o">.</span><span class="n">xform</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
<span class="go">array([[   0.,    0.,    0.],</span>
<span class="go">       [1000., 1000., 1000.]])</span>
</code></pre></div> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/affine.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AffineTransform</span><span class="p">(</span><span class="n">BaseTransform</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Affine transformation of 3D spatial data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    matrix :        (4, 4) np.ndarray</span>
<span class="sd">                    Affine matrix.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    A simple scaling transform</span>

<span class="sd">    &gt;&gt;&gt; from navis import transforms</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; M = np.diag([1e3, 1e3, 1e3, 1])</span>
<span class="sd">    &gt;&gt;&gt; tr = transforms.affine.AffineTransform(M)</span>
<span class="sd">    &gt;&gt;&gt; points = np.array([[0, 0, 0], [1, 1, 1]])</span>
<span class="sd">    &gt;&gt;&gt; tr.xform(points)</span>
<span class="sd">    array([[   0.,    0.,    0.],</span>
<span class="sd">           [1000., 1000., 1000.]])</span>

<span class="sd">    """</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'forward'</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Initialize transform."""</span>
        <span class="k">assert</span> <span class="n">direction</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">'forward'</span><span class="p">,</span> <span class="s1">'inverse'</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span> <span class="o">=</span> <span class="n">matrix</span>

        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">'inverse'</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">'AffineTransform'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Implements equality comparison."""</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">AffineTransform</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">matrix</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Invert direction."""</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Invert affine matrix</span>
        <span class="n">x</span><span class="o">.</span><span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">matrix</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">'AffineTransform'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">'AffineTransform'</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Add two affine transforms."""</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">AffineTransform</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">x</span><span class="o">.</span><span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">matrix</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">x</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'Can only add `AffineTransform` objects.'</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">'AffineTransform'</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return copy of transform."""</span>
        <span class="c1"># Attributes not to copy</span>
        <span class="n">no_copy</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Generate new empty transform</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="c1"># Override with this neuron's data</span>
        <span class="n">x</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">no_copy</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">xform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">invert</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Apply transform to points.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        points :        np.ndarray</span>
<span class="sd">                        (N, 3) array of x/y/z locations.</span>
<span class="sd">        invert :        bool</span>
<span class="sd">                        If True, will invert the transform.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pointsxf :      np.ndarray</span>
<span class="sd">                        The transformed points.</span>

<span class="sd">        """</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">points</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'`points` must be of shape (N, 3)'</span><span class="p">)</span>

        <span class="c1"># Add a fourth column to points</span>
        <span class="n">points_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">points_mat</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">points</span>

        <span class="c1"># Apply transform</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">invert</span><span class="p">:</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">points_mat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
</code></pre></div></td></tr></tbody></table></div> </details> <div class="doc doc-children"> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.AffineTransform.__init__" class="doc doc-heading"> <code class="highlight language-python"><span class="fm">__init__</span></code> <a href="#navis.transforms.AffineTransform.__init__" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Initialize transform.</p> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/affine.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'forward'</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Initialize transform."""</span>
    <span class="k">assert</span> <span class="n">direction</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">'forward'</span><span class="p">,</span> <span class="s1">'inverse'</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span> <span class="o">=</span> <span class="n">matrix</span>

    <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">'inverse'</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.AffineTransform.copy" class="doc doc-heading"> <code class="highlight language-python"><span class="n">copy</span></code> <a href="#navis.transforms.AffineTransform.copy" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Return copy of transform.</p> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/affine.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">'AffineTransform'</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return copy of transform."""</span>
    <span class="c1"># Attributes not to copy</span>
    <span class="n">no_copy</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Generate new empty transform</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="c1"># Override with this neuron's data</span>
    <span class="n">x</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">no_copy</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.AffineTransform.xform" class="doc doc-heading"> <code class="highlight language-python"><span class="n">xform</span></code> <a href="#navis.transforms.AffineTransform.xform" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Apply transform to points.</p> <table> <thead> <tr> <th><span class="doc-section-title">PARAMETER</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>points</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        (N, 3) array of x/y/z locations.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> np.ndarray</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>invert</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        If True, will invert the transform.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> bool</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>False</code> </span> </p> </td> </tr> </tbody> </table> <table> <thead> <tr> <th><span class="doc-section-title">RETURNS</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>pointsxf</code> </td> <td class="doc-returns-details"> <div class="doc-md-description"> <p>The transformed points.</p> </div> <p> <span class="doc-returns-annotation"> <b>TYPE:</b> <code><a class="autorefs autorefs-external" title="numpy" href="https://numpy.org/doc/stable/reference/index.html#module-numpy">np</a>.<a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a></code> </span> </p> </td> </tr> </tbody> </table> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/affine.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">xform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">invert</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Apply transform to points.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    points :        np.ndarray</span>
<span class="sd">                    (N, 3) array of x/y/z locations.</span>
<span class="sd">    invert :        bool</span>
<span class="sd">                    If True, will invert the transform.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pointsxf :      np.ndarray</span>
<span class="sd">                    The transformed points.</span>

<span class="sd">    """</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">points</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'`points` must be of shape (N, 3)'</span><span class="p">)</span>

    <span class="c1"># Add a fourth column to points</span>
    <span class="n">points_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">points_mat</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">points</span>

    <span class="c1"># Apply transform</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">invert</span><span class="p">:</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">points_mat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> </div> </div> </div> <div class="doc doc-object doc-class"> <h2 id="navis.transforms.AliasTransform" class="doc doc-heading"> <code>navis.transforms.AliasTransform</code> <a href="#navis.transforms.AliasTransform" class="headerlink" title="Permanent link">#</a></h2> <div class="doc doc-contents first"> <p>Helper transform that simply passes points through.</p> <p>Useful for defining aliases.</p> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/base.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AliasTransform</span><span class="p">(</span><span class="n">BaseTransform</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Helper transform that simply passes points through.</span>

<span class="sd">    Useful for defining aliases.</span>
<span class="sd">    """</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Initialize."""</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">'AliasTransform'</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Invert transform."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Check if the same."""</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">AliasTransform</span><span class="p">):</span>
            <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Return copy."""</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">AliasTransform</span><span class="p">()</span>
        <span class="n">x</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">xform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Pass through.</span>

<span class="sd">        Note that the returned points are NOT a copy but the originals.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">points</span>
</code></pre></div></td></tr></tbody></table></div> </details> <div class="doc doc-children"> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.AliasTransform.__init__" class="doc doc-heading"> <code class="highlight language-python"><span class="fm">__init__</span></code> <a href="#navis.transforms.AliasTransform.__init__" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Initialize.</p> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/base.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Initialize."""</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.AliasTransform.copy" class="doc doc-heading"> <code class="highlight language-python"><span class="n">copy</span></code> <a href="#navis.transforms.AliasTransform.copy" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Return copy.</p> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/base.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Return copy."""</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">AliasTransform</span><span class="p">()</span>
    <span class="n">x</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.AliasTransform.xform" class="doc doc-heading"> <code class="highlight language-python"><span class="n">xform</span></code> <a href="#navis.transforms.AliasTransform.xform" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Pass through.</p> <p>Note that the returned points are NOT a copy but the originals.</p> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/base.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">xform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Pass through.</span>

<span class="sd">    Note that the returned points are NOT a copy but the originals.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">points</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> </div> </div> </div> <div class="doc doc-object doc-class"> <h2 id="navis.transforms.CMTKtransform" class="doc doc-heading"> <code>navis.transforms.CMTKtransform</code> <a href="#navis.transforms.CMTKtransform" class="headerlink" title="Permanent link">#</a></h2> <div class="doc doc-contents first"> <p>CMTK transforms of 3D spatial data.</p> <p>Requires <a href="https://www.nitrc.org/projects/cmtk/">CMTK</a> to be installed.</p> <table> <thead> <tr> <th><span class="doc-section-title">PARAMETER</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>regs</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        Path(s) to CMTK transformations(s).
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> str | list of str</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>directions</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        Direction of transformation. Must provide one direction per
        `reg`.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> "forward" | "inverse" | list thereof</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>'forward'</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>threads</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        Number of threads to use.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> int</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>None</code> </span> </p> </td> </tr> </tbody> </table> <p><span class="doc-section-title">Examples:</span></p> <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">navis</span><span class="w"> </span><span class="kn">import</span> <span class="n">transforms</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">tr</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">cmtk</span><span class="o">.</span><span class="n">CMTKtransform</span><span class="p">(</span><span class="s1">'/path/to/CMTK_directory.list'</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">tr</span><span class="o">.</span><span class="n">xform</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
</code></pre></div> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/cmtk.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CMTKtransform</span><span class="p">(</span><span class="n">BaseTransform</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""CMTK transforms of 3D spatial data.</span>

<span class="sd">    Requires [CMTK](https://www.nitrc.org/projects/cmtk/) to be installed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    regs :          str | list of str</span>
<span class="sd">                    Path(s) to CMTK transformations(s).</span>
<span class="sd">    directions :    "forward" | "inverse" | list thereof</span>
<span class="sd">                    Direction of transformation. Must provide one direction per</span>
<span class="sd">                    `reg`.</span>
<span class="sd">    threads :       int, optional</span>
<span class="sd">                    Number of threads to use.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from navis import transforms</span>
<span class="sd">    &gt;&gt;&gt; tr = transforms.cmtk.CMTKtransform('/path/to/CMTK_directory.list')</span>
<span class="sd">    &gt;&gt;&gt; tr.xform(points) # doctest: +SKIP</span>

<span class="sd">    """</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regs</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">directions</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"forward"</span><span class="p">,</span> <span class="n">threads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">make_iterable</span><span class="p">(</span><span class="n">directions</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">"forward"</span><span class="p">,</span> <span class="s2">"inverse"</span><span class="p">),</span> <span class="p">(</span>
                <span class="s1">'`direction` must be "foward"'</span> <span class="sa">f</span><span class="s1">'or "inverse", not "</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s1">"'</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">make_iterable</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="s2">"streamxform"</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span> <span class="o">=</span> <span class="n">threads</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">directions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">directions</span> <span class="o">=</span> <span class="n">directions</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Must provide one direction per regs"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">"CMTKtransform"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"CMTKtransform"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Implement addition operator to concatenate transforms."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">CMTKtransform</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Cannot add </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="si">}</span><span class="s2"> to CMTKtransform"</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">command</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Unable to merge CMTKtransforms using different commands."</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">x</span><span class="o">.</span><span class="n">regs</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">regs</span>
        <span class="n">x</span><span class="o">.</span><span class="n">directions</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">directions</span>

        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">"CMTKtransform"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Implement equality comparison."""</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">CMTKtransform</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))]):</span>
                    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">directions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
                        <span class="p">]</span>
                    <span class="p">):</span>
                        <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"CMTKtransform"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Invert direction."""</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Swap directions</span>
        <span class="n">x</span><span class="o">.</span><span class="n">directions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">"forward"</span><span class="p">:</span> <span class="s2">"inverse"</span><span class="p">,</span> <span class="s2">"inverse"</span><span class="p">:</span> <span class="s2">"forward"</span><span class="p">}[</span><span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">directions</span>
        <span class="p">]</span>

        <span class="c1"># Reverse order</span>
        <span class="n">x</span><span class="o">.</span><span class="n">regs</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">regs</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">x</span><span class="o">.</span><span class="n">directions</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">directions</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"CMTKtransform with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2"> transform(s)"</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"CMTKtransform"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Generate CMTKtransform from file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath :  str</span>
<span class="sd">                    Path to CMTK transform.</span>
<span class="sd">        **kwargs</span>
<span class="sd">                    Keyword arguments passed to CMTKtransform.__init__</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        CMTKtransform</span>

<span class="sd">        """</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"directions"</span><span class="p">:</span> <span class="s2">"forward"</span><span class="p">}</span>
        <span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">CMTKtransform</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span> <span class="o">**</span><span class="n">defaults</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">affine_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Generate arguments passed to subprocess."""</span>
        <span class="c1"># Generate the arguments</span>
        <span class="c1"># The actual command (i.e. streamxform)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">_cmtkbin</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">affine_only</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"--affine-only"</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"--threads </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Add the regargs</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regargs</span>

        <span class="k">return</span> <span class="n">args</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">regargs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Generate regargs."""</span>
        <span class="n">regargs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="nb">dir</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">dir</span> <span class="o">==</span> <span class="s2">"inverse"</span><span class="p">:</span>
                <span class="c1"># For the first transform we need to prefix "--inverse" with</span>
                <span class="c1"># a solitary "--"</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">regargs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"--"</span><span class="p">)</span>
                <span class="n">regargs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"--inverse"</span><span class="p">)</span>
            <span class="c1"># Note no double quotes!</span>
            <span class="n">regargs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">reg</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">regargs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transform</span><span class="p">:</span> <span class="s2">"CMTKtransform"</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Add another transform.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        transform :     str | CMTKtransform</span>
<span class="sd">                        Either another CMTKtransform or filepath to registration.</span>
<span class="sd">        direction :     "forward" | "inverse"</span>
<span class="sd">                        Only relevant if transform is filepath.</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">CMTKtransform</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">!=</span> <span class="n">transform</span><span class="o">.</span><span class="n">command</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"Unable to merge CMTKtransforms using "</span> <span class="s2">"different commands."</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">regs</span> <span class="o">+=</span> <span class="n">transform</span><span class="o">.</span><span class="n">regs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">directions</span> <span class="o">+=</span> <span class="n">transform</span><span class="o">.</span><span class="n">directions</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">direction</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Must provide direction along with new transform"</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"Unable to append </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_if_possible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on_error</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"raise"</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Check if this transform is possible."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_cmtkbin</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">"Folder with CMTK binaries not found. Make sure the "</span>
                <span class="s2">"directory is in your PATH environment variable."</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">on_error</span> <span class="o">==</span> <span class="s2">"raise"</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">BaseException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">msg</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"Registration </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2"> not found."</span>
                <span class="k">if</span> <span class="n">on_error</span> <span class="o">==</span> <span class="s2">"raise"</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">BaseException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">msg</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"CMTKtransform"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return copy."""</span>
        <span class="c1"># Attributes not to copy</span>
        <span class="n">no_copy</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Generate new empty transform</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="c1"># Override with this neuron's data</span>
        <span class="n">x</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">no_copy</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse_cmtk_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fail_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">"""Parse CMTK output.</span>

<span class="sd">        Briefly, CMTK output will be a byte literal like this:</span>

<span class="sd">            b'311 63 23 \n275 54 25 \n'</span>

<span class="sd">        In case of failed transforms we will get something like this where the</span>
<span class="sd">        original coordinates are returned with a "FAILED" flag</span>

<span class="sd">            b'343 72 23 \n-10 -10 -10 FAILED \n'</span>

<span class="sd">        Parameter</span>
<span class="sd">        ---------</span>
<span class="sd">        output :        tuple of (b'', None)</span>
<span class="sd">                        Stdout of CMTK call.</span>
<span class="sd">        fail_value</span>
<span class="sd">                        Value to use for points that failed to transform. By</span>
<span class="sd">                        default we use `np.nan`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pointsxf :      (N, 3) numpy array</span>
<span class="sd">                        The parse transformed points.</span>

<span class="sd">        """</span>
        <span class="c1"># The original stout is tuple where we care only about the second one</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">pointsx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Split string into rows - lazily using a generator</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s2">"(.*?) \n"</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">())):</span>
            <span class="c1"># Split into values</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>

            <span class="c1"># If this point failed</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">fail_value</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>

            <span class="n">pointsx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pointsx</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">xform</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">affine_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">affine_fallback</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Xform data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        points :            (N, 3) numpy array | pandas.DataFrame</span>
<span class="sd">                            Points to xform. DataFrame must have x/y/z columns.</span>
<span class="sd">        affine_only :       bool</span>
<span class="sd">                            Whether to apply only the non-rigid affine</span>
<span class="sd">                            transform. This is useful if points are outside</span>
<span class="sd">                            the deformation field and would therefore not</span>
<span class="sd">                            transform properly.</span>
<span class="sd">        affine_fallback :   bool</span>
<span class="sd">                            If True and some points did not transform during the</span>
<span class="sd">                            non-rigid part of the transformation, we will apply</span>
<span class="sd">                            only the affine transformation to those points.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pointsxf :      (N, 3) numpy array</span>
<span class="sd">                        Transformed points. Points that failed to transform will</span>
<span class="sd">                        be `np.nan`.</span>

<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_if_possible</span><span class="p">(</span><span class="n">on_error</span><span class="o">=</span><span class="s2">"raise"</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="c1"># Make sure x/y/z columns are present</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">points</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"z"</span><span class="p">]]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"points DataFrame must have x/y/z columns."</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">points</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="p">):</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"z"</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">"`points` must be numpy array of shape (N, 3) or "</span>
                <span class="s2">"pandas DataFrame with x/y/z columns"</span>
            <span class="p">)</span>

        <span class="c1"># Generate the result</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_args</span><span class="p">(</span><span class="n">affine_only</span><span class="o">=</span><span class="n">affine_only</span><span class="p">)</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>

        <span class="c1"># Pipe in the points</span>
        <span class="n">points_str</span> <span class="o">=</span> <span class="n">points</span><span class="p">[[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"z"</span><span class="p">]]</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Do not use proc.stdin.write to avoid output buffer becoming full</span>
        <span class="c1"># before we finish piping in stdin.</span>
        <span class="c1"># proc.stdin.write(points_str.encode())</span>
        <span class="c1"># output = proc.communicate()</span>

        <span class="c1"># Read out results</span>
        <span class="c1"># This is equivalent to e.g.:</span>
        <span class="c1"># $ streamxform -args &lt;&lt;&lt; "10, 10, 10"</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">points_str</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

        <span class="c1"># If no output, something went wrong</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">CMTKError</span><span class="p">(</span><span class="s2">"CMTK produced no output. Check points?"</span><span class="p">)</span>

        <span class="c1"># Xformed points</span>
        <span class="n">xf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_cmtk_output</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">fail_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1"># Check if any points not xformed</span>
        <span class="k">if</span> <span class="n">affine_fallback</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">affine_only</span><span class="p">:</span>
            <span class="n">not_xf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">xf</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">not_xf</span><span class="p">):</span>
                <span class="n">xf</span><span class="p">[</span><span class="n">not_xf</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xform</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">not_xf</span><span class="p">],</span> <span class="n">affine_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">xf</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_grid_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">absolute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Convert to GridTransform via dense deformation field.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        template :  str | TemplateBrain | (Nx, Ny, Nz, dx, dy, dz) tuple</span>
<span class="sd">                    This defines the bounds and voxel size of the deformation</span>
<span class="sd">                    field. Typically, this would correspond to the source space</span>
<span class="sd">                    (i.e. the moving image). We can work with:</span>
<span class="sd">                      - str: a filepath to a NRRD file</span>
<span class="sd">                      - TemplateBrain: a navis TemplateBrain object</span>
<span class="sd">                      - a tuple/list/array with (Nx, Ny, Nz, dx, dy, dz)</span>
<span class="sd">                        where N is the number of voxels in each dimension</span>
<span class="sd">                        and d is the voxel size.</span>
<span class="sd">        absolute :  bool</span>
<span class="sd">                    Whether to return absolute coordinates or offsets.</span>
<span class="sd">        verbose :   bool</span>
<span class="sd">                    Whether to print CMTK output.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        transform:  GridTransform</span>
<span class="sd">                    A few notes on using the resulting GridTransform:</span>
<span class="sd">                      1. The transform will expect input coordinates in voxel space.</span>
<span class="sd">                         See the returned `voxel_size` array!</span>
<span class="sd">                      2. The transformed coordinates, on the other hand, will already</span>
<span class="sd">                         be in physical space (e.g. microns).</span>
<span class="sd">        voxel_size :   (3,) numpy array</span>
<span class="sd">                    The voxel size of the input space. This is important because</span>
<span class="sd">                    the GridTransform will expect input coordinates in voxel</span>
<span class="sd">                    space.</span>
<span class="sd">        """</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.grid</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridTransform</span>

        <span class="n">dfield</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dfield</span><span class="p">(</span>
            <span class="n">template</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">absolute</span><span class="o">=</span><span class="n">absolute</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
        <span class="p">)</span>

        <span class="c1"># Generate the transform</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">GridTransform</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">dfield</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">"coordinates"</span> <span class="k">if</span> <span class="n">absolute</span> <span class="k">else</span> <span class="s2">"offsets"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Get voxel size from header - note that the first row is for the 4th dimension</span>
        <span class="c1"># (i.e. the vector dimension of the offsets/coordinates) which we don't care about</span>
        <span class="n">space_dir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">"space directions"</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>

        <span class="k">return</span> <span class="n">transform</span><span class="p">,</span> <span class="n">space_dir</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_dfield</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">absolute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Convert transform to dense deformation field.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        template :  str | TemplateBrain | (Nx, Ny, Nz, dx, dy, dz) tuple</span>
<span class="sd">                    This defines the bounds and voxel size of the deformation</span>
<span class="sd">                    field. Typically, this would correspond to the source space</span>
<span class="sd">                    (i.e. the moving image). We can work with:</span>
<span class="sd">                      - str: a filepath to a NRRD file</span>
<span class="sd">                      - TemplateBrain: a navis TemplateBrain object</span>
<span class="sd">                      - a tuple/list/array with (Nx, Ny, Nz, dx, dy, dz)</span>
<span class="sd">                        where N is the number of voxels in each dimension</span>
<span class="sd">                        and d is the voxel size.</span>
<span class="sd">        out :       str, optional</span>
<span class="sd">                    NRRD filepath to save the deformation field. If None (default),</span>
<span class="sd">                    the deformation field will be returned as numpy array.</span>
<span class="sd">        absolute :  bool</span>
<span class="sd">                    Whether to return absolute coordinates or offsets.</span>
<span class="sd">        verbose :   bool</span>
<span class="sd">                    Whether to print CMTK output.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dfield :    np.ndarray</span>
<span class="sd">                    The dense deformation field as (3, Nx, Ny, Nz) numpy array</span>
<span class="sd">                    with either absolute coordinates or offsets where the</span>
<span class="sd">                    first dimension contains the x/y/z coordinates. Note that</span>
<span class="sd">                    the coordinates stored in the field are in physical space</span>
<span class="sd">                    (e.g. microns), not voxel space.</span>
<span class="sd">        header :    dict</span>
<span class="sd">                    The NRRD header associated with the deformation field.</span>


<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        CMTKtransform.to_grid_transform</span>
<span class="sd">                    Method to directly convert to GridTransform. Please see</span>
<span class="sd">                    that method's notes for details on how to handle the</span>
<span class="sd">                    deformation field.</span>

<span class="sd">        """</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.templates</span><span class="w"> </span><span class="kn">import</span> <span class="n">TemplateBrain</span>  <span class="c1"># avoid circular import</span>

        <span class="c1"># Translate template info into shape and voxel size</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">TemplateBrain</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="s2">"dims"</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="s2">"voxdims"</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"TemplateBrain must have `dims` and `voxdims` attributes"</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">voxdims</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"TemplateBrain `dims` and `voxdims` must be of length 3"</span>
                <span class="p">)</span>
            <span class="n">template</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">voxdims</span><span class="p">)</span>

        <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># track temporary files to clean up later</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="c1"># Assume NRRD filepath</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">template</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Template file not found: </span><span class="si">{</span><span class="n">template</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">ref_image</span> <span class="o">=</span> <span class="n">template</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">template</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">"`template` tuple/list/array must be of length 6: "</span>
                        <span class="s2">"(Nx, Ny, Nz, dx, dy, dz)"</span>
                    <span class="p">)</span>

                <span class="c1"># Create a temporary NRRD file to use as reference</span>
                <span class="c1"># (we're using zeros because that's highly compressible)</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">template</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                <span class="n">header</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">"space directions"</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]),</span>
                    <span class="s2">"kinds"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"domain"</span><span class="p">,</span> <span class="s2">"domain"</span><span class="p">,</span> <span class="s2">"domain"</span><span class="p">],</span>
                    <span class="s2">"space units"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"microns"</span><span class="p">,</span> <span class="s2">"microns"</span><span class="p">,</span> <span class="s2">"microns"</span><span class="p">],</span>
                    <span class="s2">"space origin"</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                    <span class="s2">"labels"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"z"</span><span class="p">],</span>
                    <span class="s2">"space dimension"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">".nrrd"</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">tf</span><span class="p">:</span>
                    <span class="n">nrrd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
                    <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">ref_image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">"`template` must be str, TemplateBrain or tuple, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">template</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">outfile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">".nrrd"</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
                <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">)):</span>
                <span class="n">outfile</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Invalid output type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

            <span class="c1"># Compile the command</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">_cmtkbin</span> <span class="o">/</span> <span class="s2">"xform2dfield"</span><span class="p">)]</span>

            <span class="k">if</span> <span class="n">absolute</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">"--output-absolute"</span><span class="p">]</span>

            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">outfile</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">ref_image</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regargs</span>

            <span class="c1"># run the binary</span>
            <span class="c1"># avoid resourcewarnings with null</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">devnull</span><span class="p">:</span>
                <span class="n">startupinfo</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"Windows"</span><span class="p">:</span>
                    <span class="n">startupinfo</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">STARTUPINFO</span><span class="p">()</span>
                    <span class="n">startupinfo</span><span class="o">.</span><span class="n">dwFlags</span> <span class="o">|=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">STARTF_USESHOWWINDOW</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="c1"># in debug mode print the output</span>
                    <span class="n">stdout</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stdout</span> <span class="o">=</span> <span class="n">devnull</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"executing: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>
                <span class="n">check_call</span><span class="p">(</span>
                    <span class="n">args</span><span class="p">,</span>
                    <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span>
                    <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>
                    <span class="n">startupinfo</span><span class="o">=</span><span class="n">startupinfo</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Return transformed image</span>
                <span class="k">return</span> <span class="n">nrrd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">config</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Transformed image saved to </span><span class="si">{</span><span class="n">outfile</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Clean up temporary files</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">xform_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">im</span><span class="p">,</span>
        <span class="n">target</span><span class="p">,</span>
        <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">interpolation</span><span class="o">=</span><span class="s2">"linear"</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">"""Transform an image using CMTK's reformatx.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        im :        3D numpy array | filepath</span>
<span class="sd">                    The floating image to transform.</span>
<span class="sd">        target :    str | TemplateBrain | (Nx, Ny, Nz, dx, dy, dz) | (Nx, Ny, Nz, dx, dy, dz, Ox, Oy, Oz)</span>
<span class="sd">                    Defines the target image: dimensions in voxels (N), the voxel size (d) and optionally</span>
<span class="sd">                    an origin (0) for the target image. Can be provided as a string (name of a template),</span>
<span class="sd">                    a TemplateBrain object, a tuple/list/array with the target specs.</span>
<span class="sd">        out :       str, optional</span>
<span class="sd">                    The filepath to save the transformed image. If None (default), will return the</span>
<span class="sd">                    transformed image as np.ndarray.</span>
<span class="sd">        interpolation : "linear" | "nn" | "cubic" | "pv" | "sinc-cosine" | "sinc-hamming"</span>
<span class="sd">                    The interpolation method to use.</span>
<span class="sd">        verbose :   bool</span>
<span class="sd">                    Whether to print CMTK output.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray | None</span>
<span class="sd">                    If out is None, returns the transformed image as np.ndarray. Otherwise, None.</span>

<span class="sd">        """</span>
        <span class="k">assert</span> <span class="n">interpolation</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">"linear"</span><span class="p">,</span>
            <span class="s2">"nn"</span><span class="p">,</span>
            <span class="s2">"cubic"</span><span class="p">,</span>
            <span class="s2">"pv"</span><span class="p">,</span>
            <span class="s2">"sinc-cosine"</span><span class="p">,</span>
            <span class="s2">"sinc-hamming"</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># `reformatx` expects this format:</span>
        <span class="c1"># ./reformatx --floating {INPUT_FILE} -o {OUTPUT_FILE} {REFERENCE_SPECS} {TRANSFORMS}</span>
        <span class="c1"># where:</span>
        <span class="c1"># - {INPUT_FILE} is the image to transform</span>
        <span class="c1"># - {OUTPUT_FILE} is where the output will be saved</span>
        <span class="c1"># - {REFERENCE_SPECS} defines the target space; this needs to be either a NRRD</span>
        <span class="c1">#   file from which CMTK can extract the target grid or the actual specs:</span>
        <span class="c1">#   "--target-grid Nx,Ny,Nz:dX,dY,dZ:[Ox,Oy,Oz]" where N is the number of</span>
        <span class="c1">#   voxels in each dimension and d is the voxel size. The optional O is the</span>
        <span class="c1">#   origin of the image. If not provided, it is assumed to be (0, 0, 0).</span>
        <span class="c1"># - {TRANSFORMS} are the CMTK transform(s) to apply; prefix with "--inverse" to invert</span>
        <span class="c1"># Below command works to convert JFRC2 to FCWB:</span>
        <span class="c1"># /opt/local/lib/cmtk/bin/reformatx --verbose --floating JFRC2.nrrd -o JFRC2_xf.nrrd FCWB.nrrd ~/flybrain-data/BridgingRegistrations/FCWB_JFRC2.list</span>
        <span class="c1"># This took 2min 28s - should check if that is actually faster than the look-up approach we use in `images.py`</span>
        <span class="c1"># Note that inversion of transforms always comes with an overhead! When using the inverse transform instead, the above command took 2h 40min!</span>

        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">((</span><span class="n">d</span> <span class="o">==</span> <span class="s2">"inverse "</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="p">)):</span>
            <span class="n">config</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">"Using inverse CMTK transforms with reformatx can be very slow! If possible, consider using only forward transforms."</span>
            <span class="p">)</span>

        <span class="n">target_specs</span> <span class="o">=</span> <span class="n">parse_target_specs</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

        <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">)):</span>
            <span class="n">floating</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">im</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Image file not found: </span><span class="si">{</span><span class="n">im</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">im</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span>
            <span class="c1"># Save to temporary file</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">".nrrd"</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">tf</span><span class="p">:</span>
                <span class="n">nrrd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">im</span><span class="p">)</span>
                <span class="n">floating</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">name</span>
                <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Invalid image type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">im</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">".nrrd"</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
            <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">)):</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Invalid output type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Compile the command</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">_cmtkbin</span> <span class="o">/</span> <span class="s2">"reformatx"</span><span class="p">)]</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"-o </span><span class="si">{</span><span class="n">outfile</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"--floating </span><span class="si">{</span><span class="n">floating</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"--</span><span class="si">{</span><span class="n">interpolation</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="n">target_specs</span><span class="p">]</span>

        <span class="c1"># Add the regargs</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regargs</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># run the binary</span>
            <span class="c1"># avoid resourcewarnings with null</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">devnull</span><span class="p">:</span>
                <span class="n">startupinfo</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"Windows"</span><span class="p">:</span>
                    <span class="n">startupinfo</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">STARTUPINFO</span><span class="p">()</span>
                    <span class="n">startupinfo</span><span class="o">.</span><span class="n">dwFlags</span> <span class="o">|=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">STARTF_USESHOWWINDOW</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="c1"># in debug mode print the output</span>
                    <span class="n">stdout</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stdout</span> <span class="o">=</span> <span class="n">devnull</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"executing: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>
                <span class="n">check_call</span><span class="p">(</span>
                    <span class="n">args</span><span class="p">,</span>
                    <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span>
                    <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>
                    <span class="n">startupinfo</span><span class="o">=</span><span class="n">startupinfo</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Return transformed image</span>
                <span class="k">return</span> <span class="n">nrrd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">config</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Transformed image saved to </span><span class="si">{</span><span class="n">outfile</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Clean up temporary files</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div> </details> <div class="doc doc-children"> <div class="doc doc-object doc-attribute"> <h3 id="navis.transforms.CMTKtransform.regargs" class="doc doc-heading"> <code class="highlight language-python"><span class="n">regargs</span><span class="p">:</span> <span class="nb">list</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> </span> <a href="#navis.transforms.CMTKtransform.regargs" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Generate regargs.</p> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.CMTKtransform.append" class="doc doc-heading"> <code class="highlight language-python"><span class="n">append</span></code> <a href="#navis.transforms.CMTKtransform.append" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Add another transform.</p> <table> <thead> <tr> <th><span class="doc-section-title">PARAMETER</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>transform</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        Either another CMTKtransform or filepath to registration.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> str | CMTKtransform</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>direction</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        Only relevant if transform is filepath.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> "forward" | "inverse"</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>None</code> </span> </p> </td> </tr> </tbody> </table> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/cmtk.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transform</span><span class="p">:</span> <span class="s2">"CMTKtransform"</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Add another transform.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    transform :     str | CMTKtransform</span>
<span class="sd">                    Either another CMTKtransform or filepath to registration.</span>
<span class="sd">    direction :     "forward" | "inverse"</span>
<span class="sd">                    Only relevant if transform is filepath.</span>

<span class="sd">    """</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">CMTKtransform</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">!=</span> <span class="n">transform</span><span class="o">.</span><span class="n">command</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">"Unable to merge CMTKtransforms using "</span> <span class="s2">"different commands."</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span> <span class="o">+=</span> <span class="n">transform</span><span class="o">.</span><span class="n">regs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directions</span> <span class="o">+=</span> <span class="n">transform</span><span class="o">.</span><span class="n">directions</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">direction</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Must provide direction along with new transform"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"Unable to append </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
        <span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.CMTKtransform.check_if_possible" class="doc doc-heading"> <code class="highlight language-python"><span class="n">check_if_possible</span></code> <a href="#navis.transforms.CMTKtransform.check_if_possible" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Check if this transform is possible.</p> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/cmtk.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_if_possible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on_error</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"raise"</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Check if this transform is possible."""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_cmtkbin</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">"Folder with CMTK binaries not found. Make sure the "</span>
            <span class="s2">"directory is in your PATH environment variable."</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">on_error</span> <span class="o">==</span> <span class="s2">"raise"</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">BaseException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">msg</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">regs</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"Registration </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2"> not found."</span>
            <span class="k">if</span> <span class="n">on_error</span> <span class="o">==</span> <span class="s2">"raise"</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">BaseException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">msg</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.CMTKtransform.copy" class="doc doc-heading"> <code class="highlight language-python"><span class="n">copy</span></code> <a href="#navis.transforms.CMTKtransform.copy" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Return copy.</p> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/cmtk.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"CMTKtransform"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return copy."""</span>
    <span class="c1"># Attributes not to copy</span>
    <span class="n">no_copy</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Generate new empty transform</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="c1"># Override with this neuron's data</span>
    <span class="n">x</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">no_copy</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.CMTKtransform.from_file" class="doc doc-heading"> <code class="highlight language-python"><span class="n">from_file</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small> </span> <a href="#navis.transforms.CMTKtransform.from_file" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Generate CMTKtransform from file.</p> <table> <thead> <tr> <th><span class="doc-section-title">PARAMETER</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>filepath</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>    Path to CMTK transform.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> str</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>**kwargs</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>    Keyword arguments passed to CMTKtransform.__init__
</code></pre></div> </div> <p> <span class="doc-param-default"> <b>DEFAULT:</b> <code>{}</code> </span> </p> </td> </tr> </tbody> </table> <table> <thead> <tr> <th><span class="doc-section-title">RETURNS</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <span class="doc-returns-annotation"> <code><a class="autorefs autorefs-internal" title="navis.transforms.CMTKtransform (navis.transforms.cmtk.CMTKtransform)" href="#navis.transforms.CMTKtransform">CMTKtransform</a></code> </span> </td> <td class="doc-returns-details"> <div class="doc-md-description"> </div> </td> </tr> </tbody> </table> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/cmtk.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"CMTKtransform"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Generate CMTKtransform from file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filepath :  str</span>
<span class="sd">                Path to CMTK transform.</span>
<span class="sd">    **kwargs</span>
<span class="sd">                Keyword arguments passed to CMTKtransform.__init__</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    CMTKtransform</span>

<span class="sd">    """</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"directions"</span><span class="p">:</span> <span class="s2">"forward"</span><span class="p">}</span>
    <span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">CMTKtransform</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span> <span class="o">**</span><span class="n">defaults</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.CMTKtransform.make_args" class="doc doc-heading"> <code class="highlight language-python"><span class="n">make_args</span></code> <a href="#navis.transforms.CMTKtransform.make_args" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Generate arguments passed to subprocess.</p> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/cmtk.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">affine_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Generate arguments passed to subprocess."""</span>
    <span class="c1"># Generate the arguments</span>
    <span class="c1"># The actual command (i.e. streamxform)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">_cmtkbin</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">affine_only</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"--affine-only"</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"--threads </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Add the regargs</span>
    <span class="n">args</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regargs</span>

    <span class="k">return</span> <span class="n">args</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.CMTKtransform.parse_cmtk_output" class="doc doc-heading"> <code class="highlight language-python"><span class="n">parse_cmtk_output</span></code> <a href="#navis.transforms.CMTKtransform.parse_cmtk_output" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Parse CMTK output.</p> <p>Briefly, CMTK output will be a byte literal like this:</p> <div class="highlight"><pre><span></span><code>b'311 63 23 \n275 54 25 \n'
</code></pre></div> <p>In case of failed transforms we will get something like this where the original coordinates are returned with a "FAILED" flag</p> <div class="highlight"><pre><span></span><code>b'343 72 23 \n-10 -10 -10 FAILED \n'
</code></pre></div> <details class="parameter" open> <summary>Parameter</summary> <p>output : tuple of (b'', None) Stdout of CMTK call. fail_value Value to use for points that failed to transform. By default we use <code>np.nan</code>.</p> </details> <table> <thead> <tr> <th><span class="doc-section-title">RETURNS</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>pointsxf</code> </td> <td class="doc-returns-details"> <div class="doc-md-description"> <p>The parse transformed points.</p> </div> <p> <span class="doc-returns-annotation"> <b>TYPE:</b> <code>(N, 3) numpy array</code> </span> </p> </td> </tr> </tbody> </table> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/cmtk.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">parse_cmtk_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fail_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">"""Parse CMTK output.</span>

<span class="sd">    Briefly, CMTK output will be a byte literal like this:</span>

<span class="sd">        b'311 63 23 \n275 54 25 \n'</span>

<span class="sd">    In case of failed transforms we will get something like this where the</span>
<span class="sd">    original coordinates are returned with a "FAILED" flag</span>

<span class="sd">        b'343 72 23 \n-10 -10 -10 FAILED \n'</span>

<span class="sd">    Parameter</span>
<span class="sd">    ---------</span>
<span class="sd">    output :        tuple of (b'', None)</span>
<span class="sd">                    Stdout of CMTK call.</span>
<span class="sd">    fail_value</span>
<span class="sd">                    Value to use for points that failed to transform. By</span>
<span class="sd">                    default we use `np.nan`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pointsxf :      (N, 3) numpy array</span>
<span class="sd">                    The parse transformed points.</span>

<span class="sd">    """</span>
    <span class="c1"># The original stout is tuple where we care only about the second one</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">pointsx</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Split string into rows - lazily using a generator</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s2">"(.*?) \n"</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">())):</span>
        <span class="c1"># Split into values</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>

        <span class="c1"># If this point failed</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">fail_value</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>

        <span class="n">pointsx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pointsx</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.CMTKtransform.to_dfield" class="doc doc-heading"> <code class="highlight language-python"><span class="n">to_dfield</span></code> <a href="#navis.transforms.CMTKtransform.to_dfield" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Convert transform to dense deformation field.</p> <table> <thead> <tr> <th><span class="doc-section-title">PARAMETER</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>template</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>    This defines the bounds and voxel size of the deformation
    field. Typically, this would correspond to the source space
    (i.e. the moving image). We can work with:
      - str: a filepath to a NRRD file
      - TemplateBrain: a navis TemplateBrain object
      - a tuple/list/array with (Nx, Ny, Nz, dx, dy, dz)
        where N is the number of voxels in each dimension
        and d is the voxel size.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> str | TemplateBrain | (Nx, Ny, Nz, dx, dy, dz) tuple</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>out</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>    NRRD filepath to save the deformation field. If None (default),
    the deformation field will be returned as numpy array.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> str</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>None</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>absolute</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>    Whether to return absolute coordinates or offsets.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> bool</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>True</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>verbose</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>    Whether to print CMTK output.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> bool</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>False</code> </span> </p> </td> </tr> </tbody> </table> <table> <thead> <tr> <th><span class="doc-section-title">RETURNS</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>dfield</code> </td> <td class="doc-returns-details"> <div class="doc-md-description"> <p>The dense deformation field as (3, Nx, Ny, Nz) numpy array with either absolute coordinates or offsets where the first dimension contains the x/y/z coordinates. Note that the coordinates stored in the field are in physical space (e.g. microns), not voxel space.</p> </div> <p> <span class="doc-returns-annotation"> <b>TYPE:</b> <code><a class="autorefs autorefs-external" title="numpy" href="https://numpy.org/doc/stable/reference/index.html#module-numpy">np</a>.<a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a></code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>header</code> </td> <td class="doc-returns-details"> <div class="doc-md-description"> <p>The NRRD header associated with the deformation field.</p> </div> <p> <span class="doc-returns-annotation"> <b>TYPE:</b> <code><a class="autorefs autorefs-external" href="https://docs.python.org/3/library/stdtypes.html#dict">dict</a></code> </span> </p> </td> </tr> </tbody> </table> <details class="see-also" open> <summary>See Also</summary> <p>CMTKtransform.to_grid_transform Method to directly convert to GridTransform. Please see that method's notes for details on how to handle the deformation field.</p> </details> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/cmtk.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_dfield</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">absolute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Convert transform to dense deformation field.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    template :  str | TemplateBrain | (Nx, Ny, Nz, dx, dy, dz) tuple</span>
<span class="sd">                This defines the bounds and voxel size of the deformation</span>
<span class="sd">                field. Typically, this would correspond to the source space</span>
<span class="sd">                (i.e. the moving image). We can work with:</span>
<span class="sd">                  - str: a filepath to a NRRD file</span>
<span class="sd">                  - TemplateBrain: a navis TemplateBrain object</span>
<span class="sd">                  - a tuple/list/array with (Nx, Ny, Nz, dx, dy, dz)</span>
<span class="sd">                    where N is the number of voxels in each dimension</span>
<span class="sd">                    and d is the voxel size.</span>
<span class="sd">    out :       str, optional</span>
<span class="sd">                NRRD filepath to save the deformation field. If None (default),</span>
<span class="sd">                the deformation field will be returned as numpy array.</span>
<span class="sd">    absolute :  bool</span>
<span class="sd">                Whether to return absolute coordinates or offsets.</span>
<span class="sd">    verbose :   bool</span>
<span class="sd">                Whether to print CMTK output.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dfield :    np.ndarray</span>
<span class="sd">                The dense deformation field as (3, Nx, Ny, Nz) numpy array</span>
<span class="sd">                with either absolute coordinates or offsets where the</span>
<span class="sd">                first dimension contains the x/y/z coordinates. Note that</span>
<span class="sd">                the coordinates stored in the field are in physical space</span>
<span class="sd">                (e.g. microns), not voxel space.</span>
<span class="sd">    header :    dict</span>
<span class="sd">                The NRRD header associated with the deformation field.</span>


<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    CMTKtransform.to_grid_transform</span>
<span class="sd">                Method to directly convert to GridTransform. Please see</span>
<span class="sd">                that method's notes for details on how to handle the</span>
<span class="sd">                deformation field.</span>

<span class="sd">    """</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.templates</span><span class="w"> </span><span class="kn">import</span> <span class="n">TemplateBrain</span>  <span class="c1"># avoid circular import</span>

    <span class="c1"># Translate template info into shape and voxel size</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">TemplateBrain</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="s2">"dims"</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="s2">"voxdims"</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">"TemplateBrain must have `dims` and `voxdims` attributes"</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">voxdims</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">"TemplateBrain `dims` and `voxdims` must be of length 3"</span>
            <span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">voxdims</span><span class="p">)</span>

    <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># track temporary files to clean up later</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># Assume NRRD filepath</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">template</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Template file not found: </span><span class="si">{</span><span class="n">template</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">ref_image</span> <span class="o">=</span> <span class="n">template</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">template</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"`template` tuple/list/array must be of length 6: "</span>
                    <span class="s2">"(Nx, Ny, Nz, dx, dy, dz)"</span>
                <span class="p">)</span>

            <span class="c1"># Create a temporary NRRD file to use as reference</span>
            <span class="c1"># (we're using zeros because that's highly compressible)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">template</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">"space directions"</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]),</span>
                <span class="s2">"kinds"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"domain"</span><span class="p">,</span> <span class="s2">"domain"</span><span class="p">,</span> <span class="s2">"domain"</span><span class="p">],</span>
                <span class="s2">"space units"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"microns"</span><span class="p">,</span> <span class="s2">"microns"</span><span class="p">,</span> <span class="s2">"microns"</span><span class="p">],</span>
                <span class="s2">"space origin"</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                <span class="s2">"labels"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"z"</span><span class="p">],</span>
                <span class="s2">"space dimension"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">".nrrd"</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">tf</span><span class="p">:</span>
                <span class="n">nrrd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
                <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">ref_image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"`template` must be str, TemplateBrain or tuple, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">template</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">".nrrd"</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
            <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">)):</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Invalid output type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Compile the command</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">_cmtkbin</span> <span class="o">/</span> <span class="s2">"xform2dfield"</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">absolute</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">"--output-absolute"</span><span class="p">]</span>

        <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">outfile</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">ref_image</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regargs</span>

        <span class="c1"># run the binary</span>
        <span class="c1"># avoid resourcewarnings with null</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">devnull</span><span class="p">:</span>
            <span class="n">startupinfo</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"Windows"</span><span class="p">:</span>
                <span class="n">startupinfo</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">STARTUPINFO</span><span class="p">()</span>
                <span class="n">startupinfo</span><span class="o">.</span><span class="n">dwFlags</span> <span class="o">|=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">STARTF_USESHOWWINDOW</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="c1"># in debug mode print the output</span>
                <span class="n">stdout</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stdout</span> <span class="o">=</span> <span class="n">devnull</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">config</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"executing: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>
            <span class="n">check_call</span><span class="p">(</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>
                <span class="n">startupinfo</span><span class="o">=</span><span class="n">startupinfo</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Return transformed image</span>
            <span class="k">return</span> <span class="n">nrrd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Transformed image saved to </span><span class="si">{</span><span class="n">outfile</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Clean up temporary files</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.CMTKtransform.to_grid_transform" class="doc doc-heading"> <code class="highlight language-python"><span class="n">to_grid_transform</span></code> <a href="#navis.transforms.CMTKtransform.to_grid_transform" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Convert to GridTransform via dense deformation field.</p> <table> <thead> <tr> <th><span class="doc-section-title">PARAMETER</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>template</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>    This defines the bounds and voxel size of the deformation
    field. Typically, this would correspond to the source space
    (i.e. the moving image). We can work with:
      - str: a filepath to a NRRD file
      - TemplateBrain: a navis TemplateBrain object
      - a tuple/list/array with (Nx, Ny, Nz, dx, dy, dz)
        where N is the number of voxels in each dimension
        and d is the voxel size.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> str | TemplateBrain | (Nx, Ny, Nz, dx, dy, dz) tuple</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>absolute</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>    Whether to return absolute coordinates or offsets.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> bool</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>True</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>verbose</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>    Whether to print CMTK output.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> bool</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>False</code> </span> </p> </td> </tr> </tbody> </table> <table> <thead> <tr> <th><span class="doc-section-title">RETURNS</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>transform</code> </td> <td class="doc-returns-details"> <div class="doc-md-description"> <p>A few notes on using the resulting GridTransform: 1. The transform will expect input coordinates in voxel space. See the returned <code>voxel_size</code> array! 2. The transformed coordinates, on the other hand, will already be in physical space (e.g. microns).</p> </div> <p> <span class="doc-returns-annotation"> <b>TYPE:</b> <code><a class="autorefs autorefs-internal" title="navis.transforms.GridTransform (navis.transforms.grid.GridTransform)" href="#navis.transforms.GridTransform">GridTransform</a></code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>voxel_size</code> </td> <td class="doc-returns-details"> <div class="doc-md-description"> <p>The voxel size of the input space. This is important because the GridTransform will expect input coordinates in voxel space.</p> </div> <p> <span class="doc-returns-annotation"> <b>TYPE:</b> <code>(3,) numpy array</code> </span> </p> </td> </tr> </tbody> </table> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/cmtk.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_grid_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">absolute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Convert to GridTransform via dense deformation field.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    template :  str | TemplateBrain | (Nx, Ny, Nz, dx, dy, dz) tuple</span>
<span class="sd">                This defines the bounds and voxel size of the deformation</span>
<span class="sd">                field. Typically, this would correspond to the source space</span>
<span class="sd">                (i.e. the moving image). We can work with:</span>
<span class="sd">                  - str: a filepath to a NRRD file</span>
<span class="sd">                  - TemplateBrain: a navis TemplateBrain object</span>
<span class="sd">                  - a tuple/list/array with (Nx, Ny, Nz, dx, dy, dz)</span>
<span class="sd">                    where N is the number of voxels in each dimension</span>
<span class="sd">                    and d is the voxel size.</span>
<span class="sd">    absolute :  bool</span>
<span class="sd">                Whether to return absolute coordinates or offsets.</span>
<span class="sd">    verbose :   bool</span>
<span class="sd">                Whether to print CMTK output.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    transform:  GridTransform</span>
<span class="sd">                A few notes on using the resulting GridTransform:</span>
<span class="sd">                  1. The transform will expect input coordinates in voxel space.</span>
<span class="sd">                     See the returned `voxel_size` array!</span>
<span class="sd">                  2. The transformed coordinates, on the other hand, will already</span>
<span class="sd">                     be in physical space (e.g. microns).</span>
<span class="sd">    voxel_size :   (3,) numpy array</span>
<span class="sd">                The voxel size of the input space. This is important because</span>
<span class="sd">                the GridTransform will expect input coordinates in voxel</span>
<span class="sd">                space.</span>
<span class="sd">    """</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.grid</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridTransform</span>

    <span class="n">dfield</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dfield</span><span class="p">(</span>
        <span class="n">template</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">absolute</span><span class="o">=</span><span class="n">absolute</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
    <span class="p">)</span>

    <span class="c1"># Generate the transform</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="n">GridTransform</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">dfield</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">"coordinates"</span> <span class="k">if</span> <span class="n">absolute</span> <span class="k">else</span> <span class="s2">"offsets"</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Get voxel size from header - note that the first row is for the 4th dimension</span>
    <span class="c1"># (i.e. the vector dimension of the offsets/coordinates) which we don't care about</span>
    <span class="n">space_dir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">"space directions"</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>

    <span class="k">return</span> <span class="n">transform</span><span class="p">,</span> <span class="n">space_dir</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.CMTKtransform.xform" class="doc doc-heading"> <code class="highlight language-python"><span class="n">xform</span></code> <a href="#navis.transforms.CMTKtransform.xform" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Xform data.</p> <table> <thead> <tr> <th><span class="doc-section-title">PARAMETER</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>points</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>            Points to xform. DataFrame must have x/y/z columns.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> (N, 3) numpy array | pandas.DataFrame</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>affine_only</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>            Whether to apply only the non-rigid affine
            transform. This is useful if points are outside
            the deformation field and would therefore not
            transform properly.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> bool</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>False</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>affine_fallback</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>            If True and some points did not transform during the
            non-rigid part of the transformation, we will apply
            only the affine transformation to those points.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> bool</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>False</code> </span> </p> </td> </tr> </tbody> </table> <table> <thead> <tr> <th><span class="doc-section-title">RETURNS</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>pointsxf</code> </td> <td class="doc-returns-details"> <div class="doc-md-description"> <p>Transformed points. Points that failed to transform will be <code>np.nan</code>.</p> </div> <p> <span class="doc-returns-annotation"> <b>TYPE:</b> <code>(N, 3) numpy array</code> </span> </p> </td> </tr> </tbody> </table> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/cmtk.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">xform</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">affine_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">affine_fallback</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Xform data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    points :            (N, 3) numpy array | pandas.DataFrame</span>
<span class="sd">                        Points to xform. DataFrame must have x/y/z columns.</span>
<span class="sd">    affine_only :       bool</span>
<span class="sd">                        Whether to apply only the non-rigid affine</span>
<span class="sd">                        transform. This is useful if points are outside</span>
<span class="sd">                        the deformation field and would therefore not</span>
<span class="sd">                        transform properly.</span>
<span class="sd">    affine_fallback :   bool</span>
<span class="sd">                        If True and some points did not transform during the</span>
<span class="sd">                        non-rigid part of the transformation, we will apply</span>
<span class="sd">                        only the affine transformation to those points.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pointsxf :      (N, 3) numpy array</span>
<span class="sd">                    Transformed points. Points that failed to transform will</span>
<span class="sd">                    be `np.nan`.</span>

<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_if_possible</span><span class="p">(</span><span class="n">on_error</span><span class="o">=</span><span class="s2">"raise"</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="c1"># Make sure x/y/z columns are present</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">points</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"z"</span><span class="p">]]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"points DataFrame must have x/y/z columns."</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">points</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="p">):</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"z"</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">"`points` must be numpy array of shape (N, 3) or "</span>
            <span class="s2">"pandas DataFrame with x/y/z columns"</span>
        <span class="p">)</span>

    <span class="c1"># Generate the result</span>
    <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_args</span><span class="p">(</span><span class="n">affine_only</span><span class="o">=</span><span class="n">affine_only</span><span class="p">)</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>

    <span class="c1"># Pipe in the points</span>
    <span class="n">points_str</span> <span class="o">=</span> <span class="n">points</span><span class="p">[[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"z"</span><span class="p">]]</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Do not use proc.stdin.write to avoid output buffer becoming full</span>
    <span class="c1"># before we finish piping in stdin.</span>
    <span class="c1"># proc.stdin.write(points_str.encode())</span>
    <span class="c1"># output = proc.communicate()</span>

    <span class="c1"># Read out results</span>
    <span class="c1"># This is equivalent to e.g.:</span>
    <span class="c1"># $ streamxform -args &lt;&lt;&lt; "10, 10, 10"</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">points_str</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

    <span class="c1"># If no output, something went wrong</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">utils</span><span class="o">.</span><span class="n">CMTKError</span><span class="p">(</span><span class="s2">"CMTK produced no output. Check points?"</span><span class="p">)</span>

    <span class="c1"># Xformed points</span>
    <span class="n">xf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_cmtk_output</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">fail_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="c1"># Check if any points not xformed</span>
    <span class="k">if</span> <span class="n">affine_fallback</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">affine_only</span><span class="p">:</span>
        <span class="n">not_xf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">xf</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">not_xf</span><span class="p">):</span>
            <span class="n">xf</span><span class="p">[</span><span class="n">not_xf</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xform</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">not_xf</span><span class="p">],</span> <span class="n">affine_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">xf</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.CMTKtransform.xform_image" class="doc doc-heading"> <code class="highlight language-python"><span class="n">xform_image</span></code> <a href="#navis.transforms.CMTKtransform.xform_image" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Transform an image using CMTK's reformatx.</p> <table> <thead> <tr> <th><span class="doc-section-title">PARAMETER</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>im</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>    The floating image to transform.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> 3D numpy array | filepath</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>target</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>    Defines the target image: dimensions in voxels (N), the voxel size (d) and optionally
    an origin (0) for the target image. Can be provided as a string (name of a template),
    a TemplateBrain object, a tuple/list/array with the target specs.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> str | TemplateBrain | (Nx, Ny, Nz, dx, dy, dz) | (Nx, Ny, Nz, dx, dy, dz, Ox, Oy, Oz)</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>out</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>    The filepath to save the transformed image. If None (default), will return the
    transformed image as np.ndarray.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> str</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>None</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>interpolation</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>    The interpolation method to use.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code><span title="linear">linear</span> | <span title="nn">nn</span> | <span title="cubic">cubic</span> | <span title="pv">pv</span> | <span title="sinc">sinc</span> - <span title="cosine">cosine</span> | <span title="sinc">sinc</span> - <span title="hamming">hamming</span></code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>'linear'</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>verbose</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>    Whether to print CMTK output.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> bool</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>False</code> </span> </p> </td> </tr> </tbody> </table> <table> <thead> <tr> <th><span class="doc-section-title">RETURNS</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <span class="doc-returns-annotation"> <code><a class="autorefs autorefs-external" title="numpy" href="https://numpy.org/doc/stable/reference/index.html#module-numpy">np</a>.<a class="autorefs autorefs-external" title="numpy.ndarray" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray">ndarray</a> | None</code> </span> </td> <td class="doc-returns-details"> <div class="doc-md-description"> <p>If out is None, returns the transformed image as np.ndarray. Otherwise, None.</p> </div> </td> </tr> </tbody> </table> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/cmtk.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">xform_image</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">im</span><span class="p">,</span>
    <span class="n">target</span><span class="p">,</span>
    <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">interpolation</span><span class="o">=</span><span class="s2">"linear"</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">"""Transform an image using CMTK's reformatx.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    im :        3D numpy array | filepath</span>
<span class="sd">                The floating image to transform.</span>
<span class="sd">    target :    str | TemplateBrain | (Nx, Ny, Nz, dx, dy, dz) | (Nx, Ny, Nz, dx, dy, dz, Ox, Oy, Oz)</span>
<span class="sd">                Defines the target image: dimensions in voxels (N), the voxel size (d) and optionally</span>
<span class="sd">                an origin (0) for the target image. Can be provided as a string (name of a template),</span>
<span class="sd">                a TemplateBrain object, a tuple/list/array with the target specs.</span>
<span class="sd">    out :       str, optional</span>
<span class="sd">                The filepath to save the transformed image. If None (default), will return the</span>
<span class="sd">                transformed image as np.ndarray.</span>
<span class="sd">    interpolation : "linear" | "nn" | "cubic" | "pv" | "sinc-cosine" | "sinc-hamming"</span>
<span class="sd">                The interpolation method to use.</span>
<span class="sd">    verbose :   bool</span>
<span class="sd">                Whether to print CMTK output.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray | None</span>
<span class="sd">                If out is None, returns the transformed image as np.ndarray. Otherwise, None.</span>

<span class="sd">    """</span>
    <span class="k">assert</span> <span class="n">interpolation</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="s2">"linear"</span><span class="p">,</span>
        <span class="s2">"nn"</span><span class="p">,</span>
        <span class="s2">"cubic"</span><span class="p">,</span>
        <span class="s2">"pv"</span><span class="p">,</span>
        <span class="s2">"sinc-cosine"</span><span class="p">,</span>
        <span class="s2">"sinc-hamming"</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># `reformatx` expects this format:</span>
    <span class="c1"># ./reformatx --floating {INPUT_FILE} -o {OUTPUT_FILE} {REFERENCE_SPECS} {TRANSFORMS}</span>
    <span class="c1"># where:</span>
    <span class="c1"># - {INPUT_FILE} is the image to transform</span>
    <span class="c1"># - {OUTPUT_FILE} is where the output will be saved</span>
    <span class="c1"># - {REFERENCE_SPECS} defines the target space; this needs to be either a NRRD</span>
    <span class="c1">#   file from which CMTK can extract the target grid or the actual specs:</span>
    <span class="c1">#   "--target-grid Nx,Ny,Nz:dX,dY,dZ:[Ox,Oy,Oz]" where N is the number of</span>
    <span class="c1">#   voxels in each dimension and d is the voxel size. The optional O is the</span>
    <span class="c1">#   origin of the image. If not provided, it is assumed to be (0, 0, 0).</span>
    <span class="c1"># - {TRANSFORMS} are the CMTK transform(s) to apply; prefix with "--inverse" to invert</span>
    <span class="c1"># Below command works to convert JFRC2 to FCWB:</span>
    <span class="c1"># /opt/local/lib/cmtk/bin/reformatx --verbose --floating JFRC2.nrrd -o JFRC2_xf.nrrd FCWB.nrrd ~/flybrain-data/BridgingRegistrations/FCWB_JFRC2.list</span>
    <span class="c1"># This took 2min 28s - should check if that is actually faster than the look-up approach we use in `images.py`</span>
    <span class="c1"># Note that inversion of transforms always comes with an overhead! When using the inverse transform instead, the above command took 2h 40min!</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">((</span><span class="n">d</span> <span class="o">==</span> <span class="s2">"inverse "</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">directions</span><span class="p">)):</span>
        <span class="n">config</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">"Using inverse CMTK transforms with reformatx can be very slow! If possible, consider using only forward transforms."</span>
        <span class="p">)</span>

    <span class="n">target_specs</span> <span class="o">=</span> <span class="n">parse_target_specs</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">)):</span>
        <span class="n">floating</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">im</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Image file not found: </span><span class="si">{</span><span class="n">im</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">im</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="c1"># Save to temporary file</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">".nrrd"</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">tf</span><span class="p">:</span>
            <span class="n">nrrd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">im</span><span class="p">)</span>
            <span class="n">floating</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">name</span>
            <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Invalid image type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">im</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">".nrrd"</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
        <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">)):</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Invalid output type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Compile the command</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">_cmtkbin</span> <span class="o">/</span> <span class="s2">"reformatx"</span><span class="p">)]</span>
    <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"-o </span><span class="si">{</span><span class="n">outfile</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span>
    <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"--floating </span><span class="si">{</span><span class="n">floating</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span>
    <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"--</span><span class="si">{</span><span class="n">interpolation</span><span class="si">}</span><span class="s2">"</span><span class="p">]</span>
    <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="n">target_specs</span><span class="p">]</span>

    <span class="c1"># Add the regargs</span>
    <span class="n">args</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regargs</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># run the binary</span>
        <span class="c1"># avoid resourcewarnings with null</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">devnull</span><span class="p">:</span>
            <span class="n">startupinfo</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"Windows"</span><span class="p">:</span>
                <span class="n">startupinfo</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">STARTUPINFO</span><span class="p">()</span>
                <span class="n">startupinfo</span><span class="o">.</span><span class="n">dwFlags</span> <span class="o">|=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">STARTF_USESHOWWINDOW</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="c1"># in debug mode print the output</span>
                <span class="n">stdout</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stdout</span> <span class="o">=</span> <span class="n">devnull</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">config</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"executing: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>
            <span class="n">check_call</span><span class="p">(</span>
                <span class="n">args</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>
                <span class="n">startupinfo</span><span class="o">=</span><span class="n">startupinfo</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Return transformed image</span>
            <span class="k">return</span> <span class="n">nrrd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Transformed image saved to </span><span class="si">{</span><span class="n">outfile</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Clean up temporary files</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> </div> </div> </div> <div class="doc doc-object doc-class"> <h2 id="navis.transforms.ElastixTransform" class="doc doc-heading"> <code>navis.transforms.ElastixTransform</code> <a href="#navis.transforms.ElastixTransform" class="headerlink" title="Permanent link">#</a></h2> <div class="doc doc-contents first"> <p>Elastix transforms of 3D spatial data.</p> <p>Requires <a href="https://github.com/SuperElastix/elastix/">Elastix</a>. Based on code by Jasper Phelps (<a href="https://github.com/jasper-tms/pytransformix">https://github.com/jasper-tms/pytransformix</a>).</p> <p>Note that elastix transforms can not be inverted!</p> <table> <thead> <tr> <th><span class="doc-section-title">PARAMETER</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>file</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>            Filepath to elastix transformation file.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> str</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>copy_files</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>            Any files that need to be copied into the temporary
            directory where we perform the transform. These are
            typically files supplemental to the main transform
            file (e.g. defining an additional affine transform).
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> filepath | list</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>[]</code> </span> </p> </td> </tr> </tbody> </table> <p><span class="doc-section-title">Examples:</span></p> <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">navis</span><span class="w"> </span><span class="kn">import</span> <span class="n">transforms</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">tr</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">ElastixTransform</span><span class="p">(</span><span class="s1">'/path/to/transform/transform'</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">tr</span><span class="o">.</span><span class="n">xform</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
</code></pre></div> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/elastix.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ElastixTransform</span><span class="p">(</span><span class="n">BaseTransform</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Elastix transforms of 3D spatial data.</span>

<span class="sd">    Requires [Elastix](https://github.com/SuperElastix/elastix/). Based on</span>
<span class="sd">    code by Jasper Phelps (&lt;https://github.com/jasper-tms/pytransformix&gt;).</span>

<span class="sd">    Note that elastix transforms can not be inverted!</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file :              str</span>
<span class="sd">                        Filepath to elastix transformation file.</span>
<span class="sd">    copy_files :        filepath | list, optional</span>
<span class="sd">                        Any files that need to be copied into the temporary</span>
<span class="sd">                        directory where we perform the transform. These are</span>
<span class="sd">                        typically files supplemental to the main transform</span>
<span class="sd">                        file (e.g. defining an additional affine transform).</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from navis import transforms</span>
<span class="sd">    &gt;&gt;&gt; tr = transforms.ElastixTransform('/path/to/transform/transform')</span>
<span class="sd">    &gt;&gt;&gt; tr.xform(points) # doctest: +SKIP</span>

<span class="sd">    """</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">copy_files</span><span class="o">=</span><span class="p">[]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copy_files</span> <span class="o">=</span> <span class="n">copy_files</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">"ElastixTransform"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Implement equality comparison."""</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ElastixTransform</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">file</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_if_possible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on_error</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"raise"</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Check if this transform is possible."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_elastixbin</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">"Folder with elastix binaries not found. Make sure the "</span>
                <span class="s2">"directory is in your PATH environment variable."</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">on_error</span> <span class="o">==</span> <span class="s2">"raise"</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">BaseException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">msg</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"Transformation file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="si">}</span><span class="s2"> not found."</span>
            <span class="k">if</span> <span class="n">on_error</span> <span class="o">==</span> <span class="s2">"raise"</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">BaseException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">msg</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"ElastixTransform"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return copy."""</span>
        <span class="c1"># Attributes not to copy</span>
        <span class="n">no_copy</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Generate new empty transform</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
        <span class="c1"># Override with this neuron's data</span>
        <span class="n">x</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">no_copy</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">write_input_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Write a numpy array in format required by transformix."""</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"point</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">z</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">read_output_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Load output file.</span>

<span class="sd">        Parameter</span>
<span class="sd">        ---------</span>
<span class="sd">        filepath :      str</span>
<span class="sd">                        Filepath to output file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pointsxf :      (N, 3) numpy array</span>
<span class="sd">                        The parse transformed points.</span>

<span class="sd">        """</span>
        <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"OutputPoint = [ "</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" ]"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" "</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">xform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">return_logs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Xform data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        points :        (N, 3) numpy array | pandas.DataFrame</span>
<span class="sd">                        Points to xform. DataFrame must have x/y/z columns.</span>
<span class="sd">        return_logs :   bool</span>
<span class="sd">                        If True, will return logs instead of transformed points.</span>
<span class="sd">                        Really only useful for debugging.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pointsxf :      (N, 3) numpy array</span>
<span class="sd">                        Transformed points.</span>

<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_if_possible</span><span class="p">(</span><span class="n">on_error</span><span class="o">=</span><span class="s2">"raise"</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="c1"># Make sure x/y/z columns are present</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">points</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"z"</span><span class="p">]]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"points DataFrame must have x/y/z columns."</span><span class="p">)</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="p">[[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"z"</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">points</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">"`points` must be numpy array of shape (N, 3) or "</span>
                <span class="s2">"pandas DataFrame with x/y/z columns"</span>
            <span class="p">)</span>

        <span class="c1"># Everything happens in a temporary directory</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tempdir</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">tempdir</span><span class="p">)</span>

            <span class="c1"># If required, copy additional files into the temporary directory</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy_files</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">make_iterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">copy_files</span><span class="p">):</span>
                    <span class="n">_</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>

            <span class="c1"># Write points to file</span>
            <span class="n">in_file</span> <span class="o">=</span> <span class="n">p</span> <span class="o">/</span> <span class="s2">"inputpoints.txt"</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_input_file</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">in_file</span><span class="p">)</span>

            <span class="n">out_file</span> <span class="o">=</span> <span class="n">p</span> <span class="o">/</span> <span class="s2">"outputpoints.txt"</span>

            <span class="c1"># Prepare the command</span>
            <span class="n">command</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">_elastixbin</span> <span class="o">/</span> <span class="s2">"transformix"</span><span class="p">,</span>
                <span class="s2">"-out"</span><span class="p">,</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">),</span>
                <span class="s2">"-tp"</span><span class="p">,</span>
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">),</span>
                <span class="s2">"-def"</span><span class="p">,</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">in_file</span><span class="p">),</span>
            <span class="p">]</span>

            <span class="c1"># Keep track of current working directory</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Change working directory to the temporary directory</span>
                <span class="c1"># This is apparently required because elastix stupidly expects</span>
                <span class="c1"># any secondary transform files to be in the current directory</span>
                <span class="c1"># (as opposed to where the main transform is)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="c1"># Run the actual transform</span>
                <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># This makes sure we land on our feet even in case of an error</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">return_logs</span><span class="p">:</span>
                <span class="n">logfile</span> <span class="o">=</span> <span class="n">p</span> <span class="o">/</span> <span class="s2">"transformix.log"</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">logfile</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">"No log file found."</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">logfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">logs</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">logs</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">out_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                    <span class="s2">"Elastix transform did not produce any "</span>
                    <span class="sa">f</span><span class="s2">"output:</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span>
                <span class="p">)</span>

            <span class="n">points_xf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_output_file</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">points_xf</span>
</code></pre></div></td></tr></tbody></table></div> </details> <div class="doc doc-children"> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.ElastixTransform.check_if_possible" class="doc doc-heading"> <code class="highlight language-python"><span class="n">check_if_possible</span></code> <a href="#navis.transforms.ElastixTransform.check_if_possible" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Check if this transform is possible.</p> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/elastix.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">check_if_possible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on_error</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"raise"</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Check if this transform is possible."""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_elastixbin</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">"Folder with elastix binaries not found. Make sure the "</span>
            <span class="s2">"directory is in your PATH environment variable."</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">on_error</span> <span class="o">==</span> <span class="s2">"raise"</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">BaseException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">msg</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"Transformation file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="si">}</span><span class="s2"> not found."</span>
        <span class="k">if</span> <span class="n">on_error</span> <span class="o">==</span> <span class="s2">"raise"</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">BaseException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">msg</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.ElastixTransform.copy" class="doc doc-heading"> <code class="highlight language-python"><span class="n">copy</span></code> <a href="#navis.transforms.ElastixTransform.copy" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Return copy.</p> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/elastix.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"ElastixTransform"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return copy."""</span>
    <span class="c1"># Attributes not to copy</span>
    <span class="n">no_copy</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Generate new empty transform</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
    <span class="c1"># Override with this neuron's data</span>
    <span class="n">x</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">no_copy</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.ElastixTransform.read_output_file" class="doc doc-heading"> <code class="highlight language-python"><span class="n">read_output_file</span></code> <a href="#navis.transforms.ElastixTransform.read_output_file" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Load output file.</p> <details class="parameter" open> <summary>Parameter</summary> <p>filepath : str Filepath to output file.</p> </details> <table> <thead> <tr> <th><span class="doc-section-title">RETURNS</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>pointsxf</code> </td> <td class="doc-returns-details"> <div class="doc-md-description"> <p>The parse transformed points.</p> </div> <p> <span class="doc-returns-annotation"> <b>TYPE:</b> <code>(N, 3) numpy array</code> </span> </p> </td> </tr> </tbody> </table> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/elastix.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">read_output_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Load output file.</span>

<span class="sd">    Parameter</span>
<span class="sd">    ---------</span>
<span class="sd">    filepath :      str</span>
<span class="sd">                    Filepath to output file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pointsxf :      (N, 3) numpy array</span>
<span class="sd">                    The parse transformed points.</span>

<span class="sd">    """</span>
    <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"OutputPoint = [ "</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" ]"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" "</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.ElastixTransform.write_input_file" class="doc doc-heading"> <code class="highlight language-python"><span class="n">write_input_file</span></code> <a href="#navis.transforms.ElastixTransform.write_input_file" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Write a numpy array in format required by transformix.</p> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/elastix.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">write_input_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Write a numpy array in format required by transformix."""</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"point</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">y</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">z</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.ElastixTransform.xform" class="doc doc-heading"> <code class="highlight language-python"><span class="n">xform</span></code> <a href="#navis.transforms.ElastixTransform.xform" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Xform data.</p> <table> <thead> <tr> <th><span class="doc-section-title">PARAMETER</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>points</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        Points to xform. DataFrame must have x/y/z columns.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> (N, 3) numpy array | pandas.DataFrame</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>return_logs</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        If True, will return logs instead of transformed points.
        Really only useful for debugging.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> bool</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>False</code> </span> </p> </td> </tr> </tbody> </table> <table> <thead> <tr> <th><span class="doc-section-title">RETURNS</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>pointsxf</code> </td> <td class="doc-returns-details"> <div class="doc-md-description"> <p>Transformed points.</p> </div> <p> <span class="doc-returns-annotation"> <b>TYPE:</b> <code>(N, 3) numpy array</code> </span> </p> </td> </tr> </tbody> </table> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/elastix.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">xform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">return_logs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Xform data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    points :        (N, 3) numpy array | pandas.DataFrame</span>
<span class="sd">                    Points to xform. DataFrame must have x/y/z columns.</span>
<span class="sd">    return_logs :   bool</span>
<span class="sd">                    If True, will return logs instead of transformed points.</span>
<span class="sd">                    Really only useful for debugging.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pointsxf :      (N, 3) numpy array</span>
<span class="sd">                    Transformed points.</span>

<span class="sd">    """</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_if_possible</span><span class="p">(</span><span class="n">on_error</span><span class="o">=</span><span class="s2">"raise"</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="c1"># Make sure x/y/z columns are present</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">points</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"z"</span><span class="p">]]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"points DataFrame must have x/y/z columns."</span><span class="p">)</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="p">[[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"z"</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">points</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">"`points` must be numpy array of shape (N, 3) or "</span>
            <span class="s2">"pandas DataFrame with x/y/z columns"</span>
        <span class="p">)</span>

    <span class="c1"># Everything happens in a temporary directory</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tempdir</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">tempdir</span><span class="p">)</span>

        <span class="c1"># If required, copy additional files into the temporary directory</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy_files</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">make_iterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">copy_files</span><span class="p">):</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>

        <span class="c1"># Write points to file</span>
        <span class="n">in_file</span> <span class="o">=</span> <span class="n">p</span> <span class="o">/</span> <span class="s2">"inputpoints.txt"</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_input_file</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">in_file</span><span class="p">)</span>

        <span class="n">out_file</span> <span class="o">=</span> <span class="n">p</span> <span class="o">/</span> <span class="s2">"outputpoints.txt"</span>

        <span class="c1"># Prepare the command</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">_elastixbin</span> <span class="o">/</span> <span class="s2">"transformix"</span><span class="p">,</span>
            <span class="s2">"-out"</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">),</span>
            <span class="s2">"-tp"</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">),</span>
            <span class="s2">"-def"</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">in_file</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="c1"># Keep track of current working directory</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Change working directory to the temporary directory</span>
            <span class="c1"># This is apparently required because elastix stupidly expects</span>
            <span class="c1"># any secondary transform files to be in the current directory</span>
            <span class="c1"># (as opposed to where the main transform is)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="c1"># Run the actual transform</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># This makes sure we land on our feet even in case of an error</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_logs</span><span class="p">:</span>
            <span class="n">logfile</span> <span class="o">=</span> <span class="n">p</span> <span class="o">/</span> <span class="s2">"transformix.log"</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">logfile</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">"No log file found."</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">logfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">logs</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">logs</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">out_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="s2">"Elastix transform did not produce any "</span>
                <span class="sa">f</span><span class="s2">"output:</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span>
            <span class="p">)</span>

        <span class="n">points_xf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_output_file</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">points_xf</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> </div> </div> </div> <div class="doc doc-object doc-class"> <h2 id="navis.transforms.FunctionTransform" class="doc doc-heading"> <code>navis.transforms.FunctionTransform</code> <a href="#navis.transforms.FunctionTransform" class="headerlink" title="Permanent link">#</a></h2> <div class="doc doc-contents first"> <p>Apply custom function as transform.</p> <table> <thead> <tr> <th><span class="doc-section-title">PARAMETER</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>func</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>    Function that accepts and returns an (N, 3) array.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> callable</code> </span> </p> </td> </tr> </tbody> </table> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/base.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FunctionTransform</span><span class="p">(</span><span class="n">BaseTransform</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Apply custom function as transform.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    func :      callable</span>
<span class="sd">                Function that accepts and returns an (N, 3) array.</span>

<span class="sd">    """</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Initialize."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">'`func` must be callable'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Check if the same."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">FunctionTransform</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">func</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Return copy."""</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>
        <span class="n">x</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">xform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Xform data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        points :        (N, 3) numpy array | pandas.DataFrame</span>
<span class="sd">                        Points to xform. DataFrame must have x/y/z columns.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pointsxf :      (N, 3) numpy array</span>
<span class="sd">                        Transformed points.</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="c1"># Make sure x/y/z columns are present</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">points</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'x'</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">,</span> <span class="s1">'z'</span><span class="p">]]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'points DataFrame must have x/y/z columns.'</span><span class="p">)</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="p">[[</span><span class="s1">'x'</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">,</span> <span class="s1">'z'</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">points</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">'`points` must be numpy array of shape (N, 3) or '</span>
                            <span class="s1">'pandas DataFrame with x/y/z columns'</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</code></pre></div></td></tr></tbody></table></div> </details> <div class="doc doc-children"> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.FunctionTransform.__init__" class="doc doc-heading"> <code class="highlight language-python"><span class="fm">__init__</span></code> <a href="#navis.transforms.FunctionTransform.__init__" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Initialize.</p> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/base.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Initialize."""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">'`func` must be callable'</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.FunctionTransform.copy" class="doc doc-heading"> <code class="highlight language-python"><span class="n">copy</span></code> <a href="#navis.transforms.FunctionTransform.copy" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Return copy.</p> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/base.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Return copy."""</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>
    <span class="n">x</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.FunctionTransform.xform" class="doc doc-heading"> <code class="highlight language-python"><span class="n">xform</span></code> <a href="#navis.transforms.FunctionTransform.xform" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Xform data.</p> <table> <thead> <tr> <th><span class="doc-section-title">PARAMETER</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>points</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        Points to xform. DataFrame must have x/y/z columns.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> (N, 3) numpy array | pandas.DataFrame</code> </span> </p> </td> </tr> </tbody> </table> <table> <thead> <tr> <th><span class="doc-section-title">RETURNS</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>pointsxf</code> </td> <td class="doc-returns-details"> <div class="doc-md-description"> <p>Transformed points.</p> </div> <p> <span class="doc-returns-annotation"> <b>TYPE:</b> <code>(N, 3) numpy array</code> </span> </p> </td> </tr> </tbody> </table> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/base.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">xform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Xform data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    points :        (N, 3) numpy array | pandas.DataFrame</span>
<span class="sd">                    Points to xform. DataFrame must have x/y/z columns.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pointsxf :      (N, 3) numpy array</span>
<span class="sd">                    Transformed points.</span>

<span class="sd">    """</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="c1"># Make sure x/y/z columns are present</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">points</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'x'</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">,</span> <span class="s1">'z'</span><span class="p">]]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'points DataFrame must have x/y/z columns.'</span><span class="p">)</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="p">[[</span><span class="s1">'x'</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">,</span> <span class="s1">'z'</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">points</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">'`points` must be numpy array of shape (N, 3) or '</span>
                        <span class="s1">'pandas DataFrame with x/y/z columns'</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> </div> </div> </div> <div class="doc doc-object doc-class"> <h2 id="navis.transforms.GridTransform" class="doc doc-heading"> <code>navis.transforms.GridTransform</code> <a href="#navis.transforms.GridTransform" class="headerlink" title="Permanent link">#</a></h2> <div class="doc doc-contents first"> <p>Deformation or coordinate field transform of 3D spatial data.</p> <p>This is effectively a simpler version of the H5transform class and only supports deformation fields stored as numpy arrays in memory.</p> <table> <thead> <tr> <th><span class="doc-section-title">PARAMETER</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>field</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        Deformation/coordinate field. The last dimension must
        contain the x/y/z coordinates.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> (Nx, Ny, Nz, 3) numpy array</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>type</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        Whether the field contains absolute coordinates or offsets/displacements.
        Offsets are added to the input coordinates, while
        coordinates returned as is.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> "offsets" | "coordinates"</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>'offsets'</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>spacing</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        Spacing of the deformation field in x/y/z. If not provided,
        spacing of 1 is assumed.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> tuple | list | numpy array</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>None</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>offset</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        Offset of the deformation field in x/y/z. If not provided,
        offset of 0 is assumed. N.B. offsets are applied _after_ spacing,
        i.e. need to be provided in voxel space of the deformation field.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> tuple | list | numpy array</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>None</code> </span> </p> </td> </tr> </tbody> </table> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/grid.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GridTransform</span><span class="p">(</span><span class="n">BaseTransform</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Deformation or coordinate field transform of 3D spatial data.</span>

<span class="sd">    This is effectively a simpler version of the H5transform class and</span>
<span class="sd">    only supports deformation fields stored as numpy arrays in memory.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    field :         (Nx, Ny, Nz, 3) numpy array</span>
<span class="sd">                    Deformation/coordinate field. The last dimension must</span>
<span class="sd">                    contain the x/y/z coordinates.</span>
<span class="sd">    type :          "offsets" | "coordinates"</span>
<span class="sd">                    Whether the field contains absolute coordinates or offsets/displacements.</span>
<span class="sd">                    Offsets are added to the input coordinates, while</span>
<span class="sd">                    coordinates returned as is.</span>
<span class="sd">    spacing :       tuple | list | numpy array, optional</span>
<span class="sd">                    Spacing of the deformation field in x/y/z. If not provided,</span>
<span class="sd">                    spacing of 1 is assumed.</span>
<span class="sd">    offset :        tuple | list | numpy array, optional</span>
<span class="sd">                    Offset of the deformation field in x/y/z. If not provided,</span>
<span class="sd">                    offset of 0 is assumed. N.B. offsets are applied _after_ spacing,</span>
<span class="sd">                    i.e. need to be provided in voxel space of the deformation field.</span>

<span class="sd">    """</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"offsets"</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">"""Init class."""</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">field</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="p">),</span> <span class="s2">"Field must be a 4D numpy array with the last dimension of size 3."</span>
        <span class="k">assert</span> <span class="nb">type</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">"coordinates"</span><span class="p">,</span>
            <span class="s2">"offsets"</span><span class="p">,</span>
        <span class="p">),</span> <span class="s2">"type must be 'coordinates' or 'offsets'."</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span> <span class="o">=</span> <span class="n">spacing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Compare with other Transform."""</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">GridTransform</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">field</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"GridTransform"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Invert direction."""</span>
        <span class="c1"># Note to future self: we could implement this by computing the inverse</span>
        <span class="c1"># deformation field using fixed-point iteration, but that's</span>
        <span class="c1"># non-trivial and not needed right now.</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"Inversion of GridTransform is not implemented."</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">spacing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spacing</span>

    <span class="nd">@spacing</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">spacing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spacing</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">value</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">3</span>
            <span class="p">),</span> <span class="s2">"spacing must be a tuple/list/array of size 3."</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spacing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span>

    <span class="nd">@offset</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">value</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">3</span>
            <span class="p">),</span> <span class="s2">"offset must be a tuple/list/array of size 3."</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">affine</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AffineTransform</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return affine part of the transform."""</span>
        <span class="c1"># We're delaying the calculation of the affine part until it's needed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_affine"</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_affine</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return shape of the deformation field."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_affine</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Calculate affine part of the transform."""</span>
        <span class="c1"># The strategy here is this:</span>
        <span class="c1"># 1. Take the 8 corners of the deformation field</span>
        <span class="c1"># 2. Transform them using the deformation field</span>
        <span class="c1"># 3. Treat them as landmarks and compute the affine transform using morphops</span>

        <span class="n">mx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># max indices in each dimension</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mx</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">mx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">mx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mx</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
                <span class="p">[</span><span class="n">mx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="n">mx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mx</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
                <span class="p">[</span><span class="n">mx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="n">mx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mx</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">points</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">points</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>

        <span class="n">points_xf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xform</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">affine_fallback</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">TPStransform</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">points_xf</span><span class="p">)</span><span class="o">.</span><span class="n">matrix_rigid</span>

        <span class="c1"># Calculate the affine part as the mean displacement across the field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_affine</span> <span class="o">=</span> <span class="n">AffineTransform</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"GridTransform"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return copy."""</span>
        <span class="k">if</span> <span class="n">copy_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">GridTransform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="nb">type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">GridTransform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"GridTransform"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Create GridTransform a file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file :          str</span>
<span class="sd">                        Path to file. Currently supported formats:</span>
<span class="sd">                          - NRRD files with deformation fields</span>
<span class="sd">                          - Numpy .npy files with deformation fields</span>
<span class="sd">                          - Nifti files (.nii, .nii.gz) with deformation fields</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        GridTransform instance.</span>

<span class="sd">        """</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filepath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"File </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2"> does not exist."</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">".npy"</span><span class="p">]:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">filepath</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">".nii"</span><span class="p">,</span> <span class="s2">".nii.gz"</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">nibabel</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nib</span>
            <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                    <span class="s2">"`nibabel` package is required to read Nifti files (.nii, .nii.gz)"</span>
                <span class="p">)</span>

            <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">filepath</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">".nrrd"</span><span class="p">]:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">nrrd</span>

            <span class="n">field</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">nrrd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"Unsupported file format: </span><span class="si">{</span><span class="n">filepath</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">. "</span>
                <span class="s2">"Supported formats are: .npy, .nii, .nii.gz, .nrrd"</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_warpfield</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">warpfield</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Create GridTransform from a Warpfield deformation field.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        warpfield :     warpfield.WarpMap | str</span>
<span class="sd">                        Warpfield WarpMap instance or path to a WarpMap h5 file.</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">warpfield</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>

            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">warpfield</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
                <span class="n">wm</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="s2">"warp_map"</span><span class="p">]</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">wm</span><span class="p">[</span><span class="s2">"warp_field"</span><span class="p">][:]</span>
                <span class="n">block_size</span> <span class="o">=</span> <span class="n">wm</span><span class="p">[</span><span class="s2">"block_size"</span><span class="p">][:]</span>
                <span class="n">block_stride</span> <span class="o">=</span> <span class="n">wm</span><span class="p">[</span><span class="s2">"block_stride"</span><span class="p">][:]</span>
                <span class="c1"># mov_shape = wm["moving_shape"][:]</span>
                <span class="c1"># ref_shape = wm["ref_shape"][:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">warpfield</span><span class="o">.</span><span class="n">warp_field</span>
            <span class="n">block_size</span> <span class="o">=</span> <span class="n">warpfield</span><span class="o">.</span><span class="n">block_size</span>
            <span class="n">block_stride</span> <span class="o">=</span> <span class="n">warpfield</span><span class="o">.</span><span class="n">block_stride</span>
            <span class="c1"># mov_shape = warpfield.mov_shape</span>
            <span class="c1"># ref_shape = warpfield.ref_shape</span>

        <span class="c1"># Reshape the field from (3, X, Y, Z) to (X, Y, Z, 3)</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">spacing</span> <span class="o">=</span> <span class="n">block_stride</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="o">-</span><span class="n">block_size</span> <span class="o">/</span> <span class="n">block_stride</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="c1"># Note to self regarding the offset: this code is taken straight from warpfield.</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">"offsets"</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="n">spacing</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">xform</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">affine_fallback</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Xform data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        points :            (N, 3) numpy array | pandas.DataFrame</span>
<span class="sd">                            Points to xform. DataFrame must have x/y/z columns.</span>
<span class="sd">        affine_fallback :   bool</span>
<span class="sd">                            If True, points that are outside the deformation field</span>
<span class="sd">                            will be transformed using an affine transform defined by</span>
<span class="sd">                            the affine part of the deformation field.</span>
<span class="sd">                            If False, points outside the field will be set to np.nan.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pointsxf :          (N, 3) numpy.ndarray</span>
<span class="sd">                            Transformed points. Will contain `np.nan` for points</span>
<span class="sd">                            that did not transform.</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="c1"># Make sure x/y/z columns are present</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">points</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"z"</span><span class="p">]]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"points DataFrame must have x/y/z columns."</span><span class="p">)</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="p">[[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"z"</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">points</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span>
            <span class="ow">or</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">"`points` must be numpy array of shape (N, 3) or "</span>
                <span class="s2">"pandas DataFrame with x/y/z columns"</span>
            <span class="p">)</span>

        <span class="n">points_vxl</span> <span class="o">=</span> <span class="n">points</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">points_vxl</span> <span class="o">=</span> <span class="n">points_vxl</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">points_vxl</span> <span class="o">=</span> <span class="n">points_vxl</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>

        <span class="c1"># For interpolation, we need to split the offsets into their x, y</span>
        <span class="c1"># and z component</span>
        <span class="n">xgrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">ygrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">zgrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Prepare points for interpolation</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">zz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># The RegularGridInterpolator is the fastest but the results are</span>
        <span class="c1"># are ever so slightly (4th decimal) different from the Java implementation</span>
        <span class="n">xinterp</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">(</span>
            <span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">),</span> <span class="n">xgrid</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        <span class="n">yinterp</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">(</span>
            <span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">),</span> <span class="n">ygrid</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        <span class="n">zinterp</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">(</span>
            <span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">),</span> <span class="n">zgrid</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="c1"># Before we interpolate check how many points are outside the deformation field</span>
        <span class="n">is_out</span> <span class="o">=</span> <span class="p">(</span><span class="n">points_vxl</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">points_vxl</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Prepare output array</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">"coordinates"</span><span class="p">:</span>
            <span class="n">points_xf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># offsets</span>
            <span class="n">points_xf</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_out</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">affine_fallback</span><span class="p">:</span>
                <span class="n">points_xf</span><span class="p">[</span><span class="n">is_out</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Apply affine part to out-of-bounds points</span>
                <span class="n">points_xf</span><span class="p">[</span><span class="n">is_out</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">affine</span><span class="o">.</span><span class="n">xform</span><span class="p">(</span>
                    <span class="n">points</span><span class="p">[</span><span class="n">is_out</span><span class="p">,</span> <span class="p">:],</span>
                <span class="p">)</span>

        <span class="c1"># Interpolate coordinates, re-combine to an x/y/z array and</span>
        <span class="c1"># add to the input points (if coordinates, the points are zeroed out above)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_out</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">points_xf</span><span class="p">[</span><span class="o">~</span><span class="n">is_out</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">xinterp</span><span class="p">(</span><span class="n">points_vxl</span><span class="p">[</span><span class="o">~</span><span class="n">is_out</span><span class="p">,</span> <span class="p">:],</span> <span class="n">method</span><span class="o">=</span><span class="s2">"linear"</span><span class="p">),</span>
                    <span class="n">yinterp</span><span class="p">(</span><span class="n">points_vxl</span><span class="p">[</span><span class="o">~</span><span class="n">is_out</span><span class="p">,</span> <span class="p">:],</span> <span class="n">method</span><span class="o">=</span><span class="s2">"linear"</span><span class="p">),</span>
                    <span class="n">zinterp</span><span class="p">(</span><span class="n">points_vxl</span><span class="p">[</span><span class="o">~</span><span class="n">is_out</span><span class="p">,</span> <span class="p">:],</span> <span class="n">method</span><span class="o">=</span><span class="s2">"linear"</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">points_xf</span>
</code></pre></div></td></tr></tbody></table></div> </details> <div class="doc doc-children"> <div class="doc doc-object doc-attribute"> <h3 id="navis.transforms.GridTransform.affine" class="doc doc-heading"> <code class="highlight language-python"><span class="n">affine</span><span class="p">:</span> <span class="n">AffineTransform</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> </span> <a href="#navis.transforms.GridTransform.affine" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Return affine part of the transform.</p> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id="navis.transforms.GridTransform.shape" class="doc doc-heading"> <code class="highlight language-python"><span class="n">shape</span><span class="p">:</span> <span class="nb">tuple</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> </span> <a href="#navis.transforms.GridTransform.shape" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Return shape of the deformation field.</p> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.GridTransform.__init__" class="doc doc-heading"> <code class="highlight language-python"><span class="fm">__init__</span></code> <a href="#navis.transforms.GridTransform.__init__" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Init class.</p> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/grid.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"offsets"</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">"""Init class."""</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">field</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="p">),</span> <span class="s2">"Field must be a 4D numpy array with the last dimension of size 3."</span>
    <span class="k">assert</span> <span class="nb">type</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="s2">"coordinates"</span><span class="p">,</span>
        <span class="s2">"offsets"</span><span class="p">,</span>
    <span class="p">),</span> <span class="s2">"type must be 'coordinates' or 'offsets'."</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">dtype</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span> <span class="o">=</span> <span class="n">spacing</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.GridTransform.calculate_affine" class="doc doc-heading"> <code class="highlight language-python"><span class="n">calculate_affine</span></code> <a href="#navis.transforms.GridTransform.calculate_affine" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Calculate affine part of the transform.</p> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/grid.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">calculate_affine</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Calculate affine part of the transform."""</span>
    <span class="c1"># The strategy here is this:</span>
    <span class="c1"># 1. Take the 8 corners of the deformation field</span>
    <span class="c1"># 2. Transform them using the deformation field</span>
    <span class="c1"># 3. Treat them as landmarks and compute the affine transform using morphops</span>

    <span class="n">mx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># max indices in each dimension</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mx</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">mx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">mx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mx</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
            <span class="p">[</span><span class="n">mx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="n">mx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mx</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
            <span class="p">[</span><span class="n">mx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span>
            <span class="p">[</span><span class="n">mx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mx</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">points</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">points</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>

    <span class="n">points_xf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xform</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">affine_fallback</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">TPStransform</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">points_xf</span><span class="p">)</span><span class="o">.</span><span class="n">matrix_rigid</span>

    <span class="c1"># Calculate the affine part as the mean displacement across the field</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_affine</span> <span class="o">=</span> <span class="n">AffineTransform</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.GridTransform.copy" class="doc doc-heading"> <code class="highlight language-python"><span class="n">copy</span></code> <a href="#navis.transforms.GridTransform.copy" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Return copy.</p> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/grid.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"GridTransform"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Return copy."""</span>
    <span class="k">if</span> <span class="n">copy_data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">GridTransform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="nb">type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">GridTransform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.GridTransform.from_file" class="doc doc-heading"> <code class="highlight language-python"><span class="n">from_file</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small> </span> <a href="#navis.transforms.GridTransform.from_file" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Create GridTransform a file.</p> <table> <thead> <tr> <th><span class="doc-section-title">PARAMETER</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>file</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        Path to file. Currently supported formats:
          - NRRD files with deformation fields
          - Numpy .npy files with deformation fields
          - Nifti files (.nii, .nii.gz) with deformation fields
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> str</code> </span> </p> </td> </tr> </tbody> </table> <table> <thead> <tr> <th><span class="doc-section-title">RETURNS</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <span class="doc-returns-annotation"> <code>GridTransform instance.</code> </span> </td> <td class="doc-returns-details"> <div class="doc-md-description"> </div> </td> </tr> </tbody> </table> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/grid.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"GridTransform"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Create GridTransform a file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file :          str</span>
<span class="sd">                    Path to file. Currently supported formats:</span>
<span class="sd">                      - NRRD files with deformation fields</span>
<span class="sd">                      - Numpy .npy files with deformation fields</span>
<span class="sd">                      - Nifti files (.nii, .nii.gz) with deformation fields</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    GridTransform instance.</span>

<span class="sd">    """</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">filepath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"File </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2"> does not exist."</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">".npy"</span><span class="p">]:</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">filepath</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">".nii"</span><span class="p">,</span> <span class="s2">".nii.gz"</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">nibabel</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nib</span>
        <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">"`nibabel` package is required to read Nifti files (.nii, .nii.gz)"</span>
            <span class="p">)</span>

        <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">filepath</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">".nrrd"</span><span class="p">]:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">nrrd</span>

        <span class="n">field</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">nrrd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"Unsupported file format: </span><span class="si">{</span><span class="n">filepath</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">. "</span>
            <span class="s2">"Supported formats are: .npy, .nii, .nii.gz, .nrrd"</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.GridTransform.from_warpfield" class="doc doc-heading"> <code class="highlight language-python"><span class="n">from_warpfield</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small> </span> <a href="#navis.transforms.GridTransform.from_warpfield" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Create GridTransform from a Warpfield deformation field.</p> <table> <thead> <tr> <th><span class="doc-section-title">PARAMETER</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>warpfield</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        Warpfield WarpMap instance or path to a WarpMap h5 file.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> warpfield.WarpMap | str</code> </span> </p> </td> </tr> </tbody> </table> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/grid.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_warpfield</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">warpfield</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Create GridTransform from a Warpfield deformation field.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    warpfield :     warpfield.WarpMap | str</span>
<span class="sd">                    Warpfield WarpMap instance or path to a WarpMap h5 file.</span>

<span class="sd">    """</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">warpfield</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>

        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">warpfield</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
            <span class="n">wm</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="s2">"warp_map"</span><span class="p">]</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">wm</span><span class="p">[</span><span class="s2">"warp_field"</span><span class="p">][:]</span>
            <span class="n">block_size</span> <span class="o">=</span> <span class="n">wm</span><span class="p">[</span><span class="s2">"block_size"</span><span class="p">][:]</span>
            <span class="n">block_stride</span> <span class="o">=</span> <span class="n">wm</span><span class="p">[</span><span class="s2">"block_stride"</span><span class="p">][:]</span>
            <span class="c1"># mov_shape = wm["moving_shape"][:]</span>
            <span class="c1"># ref_shape = wm["ref_shape"][:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">warpfield</span><span class="o">.</span><span class="n">warp_field</span>
        <span class="n">block_size</span> <span class="o">=</span> <span class="n">warpfield</span><span class="o">.</span><span class="n">block_size</span>
        <span class="n">block_stride</span> <span class="o">=</span> <span class="n">warpfield</span><span class="o">.</span><span class="n">block_stride</span>
        <span class="c1"># mov_shape = warpfield.mov_shape</span>
        <span class="c1"># ref_shape = warpfield.ref_shape</span>

    <span class="c1"># Reshape the field from (3, X, Y, Z) to (X, Y, Z, 3)</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">spacing</span> <span class="o">=</span> <span class="n">block_stride</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="o">-</span><span class="n">block_size</span> <span class="o">/</span> <span class="n">block_stride</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="c1"># Note to self regarding the offset: this code is taken straight from warpfield.</span>

    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">"offsets"</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="n">spacing</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.GridTransform.xform" class="doc doc-heading"> <code class="highlight language-python"><span class="n">xform</span></code> <a href="#navis.transforms.GridTransform.xform" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Xform data.</p> <table> <thead> <tr> <th><span class="doc-section-title">PARAMETER</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>points</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>            Points to xform. DataFrame must have x/y/z columns.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> (N, 3) numpy array | pandas.DataFrame</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>affine_fallback</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>            If True, points that are outside the deformation field
            will be transformed using an affine transform defined by
            the affine part of the deformation field.
            If False, points outside the field will be set to np.nan.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> bool</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>False</code> </span> </p> </td> </tr> </tbody> </table> <table> <thead> <tr> <th><span class="doc-section-title">RETURNS</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>pointsxf</code> </td> <td class="doc-returns-details"> <div class="doc-md-description"> <p>Transformed points. Will contain <code>np.nan</code> for points that did not transform.</p> </div> <p> <span class="doc-returns-annotation"> <b>TYPE:</b> <code>(N, 3) numpy.ndarray</code> </span> </p> </td> </tr> </tbody> </table> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/grid.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">xform</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">affine_fallback</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Xform data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    points :            (N, 3) numpy array | pandas.DataFrame</span>
<span class="sd">                        Points to xform. DataFrame must have x/y/z columns.</span>
<span class="sd">    affine_fallback :   bool</span>
<span class="sd">                        If True, points that are outside the deformation field</span>
<span class="sd">                        will be transformed using an affine transform defined by</span>
<span class="sd">                        the affine part of the deformation field.</span>
<span class="sd">                        If False, points outside the field will be set to np.nan.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pointsxf :          (N, 3) numpy.ndarray</span>
<span class="sd">                        Transformed points. Will contain `np.nan` for points</span>
<span class="sd">                        that did not transform.</span>

<span class="sd">    """</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="c1"># Make sure x/y/z columns are present</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">points</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"z"</span><span class="p">]]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"points DataFrame must have x/y/z columns."</span><span class="p">)</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="p">[[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"z"</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">points</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span>
        <span class="ow">or</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">"`points` must be numpy array of shape (N, 3) or "</span>
            <span class="s2">"pandas DataFrame with x/y/z columns"</span>
        <span class="p">)</span>

    <span class="n">points_vxl</span> <span class="o">=</span> <span class="n">points</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">points_vxl</span> <span class="o">=</span> <span class="n">points_vxl</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacing</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">points_vxl</span> <span class="o">=</span> <span class="n">points_vxl</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># For interpolation, we need to split the offsets into their x, y</span>
    <span class="c1"># and z component</span>
    <span class="n">xgrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">ygrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">zgrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Prepare points for interpolation</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">zz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1"># The RegularGridInterpolator is the fastest but the results are</span>
    <span class="c1"># are ever so slightly (4th decimal) different from the Java implementation</span>
    <span class="n">xinterp</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">(</span>
        <span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">),</span> <span class="n">xgrid</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>
    <span class="n">yinterp</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">(</span>
        <span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">),</span> <span class="n">ygrid</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>
    <span class="n">zinterp</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">(</span>
        <span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">),</span> <span class="n">zgrid</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>

    <span class="c1"># Before we interpolate check how many points are outside the deformation field</span>
    <span class="n">is_out</span> <span class="o">=</span> <span class="p">(</span><span class="n">points_vxl</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">points_vxl</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Prepare output array</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">"coordinates"</span><span class="p">:</span>
        <span class="n">points_xf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># offsets</span>
        <span class="n">points_xf</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_out</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">affine_fallback</span><span class="p">:</span>
            <span class="n">points_xf</span><span class="p">[</span><span class="n">is_out</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Apply affine part to out-of-bounds points</span>
            <span class="n">points_xf</span><span class="p">[</span><span class="n">is_out</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">affine</span><span class="o">.</span><span class="n">xform</span><span class="p">(</span>
                <span class="n">points</span><span class="p">[</span><span class="n">is_out</span><span class="p">,</span> <span class="p">:],</span>
            <span class="p">)</span>

    <span class="c1"># Interpolate coordinates, re-combine to an x/y/z array and</span>
    <span class="c1"># add to the input points (if coordinates, the points are zeroed out above)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_out</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">points_xf</span><span class="p">[</span><span class="o">~</span><span class="n">is_out</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">xinterp</span><span class="p">(</span><span class="n">points_vxl</span><span class="p">[</span><span class="o">~</span><span class="n">is_out</span><span class="p">,</span> <span class="p">:],</span> <span class="n">method</span><span class="o">=</span><span class="s2">"linear"</span><span class="p">),</span>
                <span class="n">yinterp</span><span class="p">(</span><span class="n">points_vxl</span><span class="p">[</span><span class="o">~</span><span class="n">is_out</span><span class="p">,</span> <span class="p">:],</span> <span class="n">method</span><span class="o">=</span><span class="s2">"linear"</span><span class="p">),</span>
                <span class="n">zinterp</span><span class="p">(</span><span class="n">points_vxl</span><span class="p">[</span><span class="o">~</span><span class="n">is_out</span><span class="p">,</span> <span class="p">:],</span> <span class="n">method</span><span class="o">=</span><span class="s2">"linear"</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">points_xf</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> </div> </div> </div> <div class="doc doc-object doc-class"> <h2 id="navis.transforms.H5transform" class="doc doc-heading"> <code>navis.transforms.H5transform</code> <a href="#navis.transforms.H5transform" class="headerlink" title="Permanent link">#</a></h2> <div class="doc doc-contents first"> <p>Hdf5 transform of 3D spatial data.</p> <p>See <a href="https://github.com/saalfeldlab/template-building/wiki/Hdf5-Deformation-fields">here</a> for specifications of the format.</p> <table> <thead> <tr> <th><span class="doc-section-title">PARAMETER</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>f</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        Path to Hdf5 transformation.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> str</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>direction</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        Direction of transformation.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> "forward" | "inverse"</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>'forward'</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>level</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        For Hdf5 files with deformation fields at multiple
        resolutions: what level of detail to use. Negative values
        go backwards from the highest available resolution
        (-1 = highest, -2 = second highest, etc). Ignored if only a
        single deformation field present.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> int</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>-1</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>cache</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        If True, we will cache the deformation field for subsequent
        future transforms. This will speed up future calculations
        in the future but comes at a memory cost.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> bool</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>False</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>full_ingest</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        If True, will read and cache the full deformation field at
        initialization. This additional upfront cost can pay off if
        you are about to make many transforms across the volume.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> bool</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>False</code> </span> </p> </td> </tr> </tbody> </table> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/h5reg.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">H5transform</span><span class="p">(</span><span class="n">BaseTransform</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Hdf5 transform of 3D spatial data.</span>

<span class="sd">    See [here](https://github.com/saalfeldlab/template-building/wiki/Hdf5-Deformation-fields)</span>
<span class="sd">    for specifications of the format.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    f :             str</span>
<span class="sd">                    Path to Hdf5 transformation.</span>
<span class="sd">    direction :     "forward" | "inverse"</span>
<span class="sd">                    Direction of transformation.</span>
<span class="sd">    level :         int, optional</span>
<span class="sd">                    For Hdf5 files with deformation fields at multiple</span>
<span class="sd">                    resolutions: what level of detail to use. Negative values</span>
<span class="sd">                    go backwards from the highest available resolution</span>
<span class="sd">                    (-1 = highest, -2 = second highest, etc). Ignored if only a</span>
<span class="sd">                    single deformation field present.</span>
<span class="sd">    cache :         bool</span>
<span class="sd">                    If True, we will cache the deformation field for subsequent</span>
<span class="sd">                    future transforms. This will speed up future calculations</span>
<span class="sd">                    in the future but comes at a memory cost.</span>
<span class="sd">    full_ingest :   bool</span>
<span class="sd">                    If True, will read and cache the full deformation field at</span>
<span class="sd">                    initialization. This additional upfront cost can pay off if</span>
<span class="sd">                    you are about to make many transforms across the volume.</span>

<span class="sd">    """</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">f</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"forward"</span><span class="p">,</span>
        <span class="n">level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">full_ingest</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">"""Init class."""</span>
        <span class="k">assert</span> <span class="n">direction</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">"forward"</span><span class="p">,</span> <span class="s2">"inverse"</span><span class="p">),</span> <span class="p">(</span>
            <span class="s1">'`direction` must be "forward"'</span> <span class="sa">f</span><span class="s1">'or "inverse", not "</span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s1">"'</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"forward"</span><span class="p">:</span> <span class="s2">"dfield"</span><span class="p">,</span> <span class="s2">"inverse"</span><span class="p">:</span> <span class="s2">"invdfield"</span><span class="p">}[</span><span class="n">direction</span><span class="p">]</span>

        <span class="c1"># Trying to avoid the file repeatedly so we are making these initial</span>
        <span class="c1"># adjustments all in one go even though it would be more Pythonic to</span>
        <span class="c1"># delegate to property getter/setter methods</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
            <span class="c1"># Get the available levels</span>
            <span class="n">available_levels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">h5</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">available_levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="n">available_levels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">available_levels</span><span class="p">)</span>

            <span class="c1"># Check if there are indeed deformation fields at various resolutions</span>
            <span class="k">if</span> <span class="n">available_levels</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
                    <span class="n">level</span> <span class="o">=</span> <span class="n">available_levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ix</span> <span class="o">=</span> <span class="n">level</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">level</span> <span class="o">=</span> <span class="n">available_levels</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>

                <span class="c1"># Set level</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_level</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

                <span class="c1"># Shape of deformation field</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>

                <span class="c1"># Data type of deformation field</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="ow">in</span> <span class="n">h5</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c1"># Set level</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_level</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># Shape of deformation field</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>

                <span class="c1"># Data type of deformation field</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"Unable to parse deformation fields from "</span> <span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="si">}</span><span class="s2">."</span>
                <span class="p">)</span>

        <span class="c1"># Prepare cache if applicable</span>
        <span class="k">if</span> <span class="n">full_ingest</span><span class="p">:</span>
            <span class="c1"># Ingest the whole deformation field</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">full_ingest</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_cache</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Compare with other Transform."""</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">H5transform</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">file</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">direction</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">level</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"H5transform"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Invert direction."""</span>
        <span class="c1"># Swap direction</span>
        <span class="n">new_direction</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"forward"</span><span class="p">:</span> <span class="s2">"inverse"</span><span class="p">,</span> <span class="s2">"inverse"</span><span class="p">:</span> <span class="s2">"forward"</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="p">]</span>
        <span class="c1"># We will re-iniatialize</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">H5transform</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span>
            <span class="n">direction</span><span class="o">=</span><span class="n">new_direction</span><span class="p">,</span>
            <span class="n">level</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_cache</span><span class="p">,</span>
            <span class="n">full_ingest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">level</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_level</span>

    <span class="nd">@level</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"`level` cannot be changed after initialization."</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Shape of the deformation field.</span>

<span class="sd">        Note that the deformation field is likely to be (z, y, x, 3) where</span>
<span class="sd">        the last dimension contains the x/y/z offsets.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span>

    <span class="nd">@shape</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"`shape` cannot be changed after initialization."</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">spacing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Voxel spacing of the deformation field (z, y, x)."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_spacing"</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_spacing</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"spacing"</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_spacing</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"spacing"</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spacing</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">quantization_multiplier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Quantization multiplier of the deformation field."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_quantization_multiplier"</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_quantization_multiplier</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">][</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">field</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"quantization_multiplier"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_quantization_multiplier</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">"quantization_multiplier"</span><span class="p">,</span> <span class="mi">1</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quantization_multiplier</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">use_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Whether to cache the deformation field."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_use_cache"</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_use_cache</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_cache</span>

    <span class="nd">@use_cache</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">use_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Set whether to cache the deformation field."""</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>

        <span class="c1"># If was False and now set to True, build the cache</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_use_cache"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="p">:</span>
            <span class="c1"># This is the actual cache</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="c1"># This is a mask that tells us which values have already been cached</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cached</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_use_cache</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># If was True and now is set to False, deconstruct cache</span>
        <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_use_cache"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_use_cache</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_fully_ingested"</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fully_ingested</span>

        <span class="c1"># Note: should explore whether we can use sparse N-dimensional</span>
        <span class="c1"># arrays for caching to save memory</span>
        <span class="c1"># See https://github.com/pydata/sparse/</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Return copy."""</span>
        <span class="k">return</span> <span class="n">H5transform</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span>
            <span class="n">direction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span>
            <span class="n">level</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_cache</span><span class="p">,</span>
            <span class="n">full_ingest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">full_ingest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Fully ingest the deformation field."""</span>
        <span class="c1"># Skip if already ingested</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_fully_ingested"</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
            <span class="c1"># Read in the entire field</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="c1"># Keep a flag of this</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fully_ingested</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># We set `cached` to True instead of using a mask</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cached</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># Keep track of the caching</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_use_cache</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">precache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bbox</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Cache deformation field for given bounding box.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bbox :      list | array</span>
<span class="sd">                    Must be `[[x1, x2], [y1, y2], [z1, z2]]`.</span>
<span class="sd">        padding :   bool</span>
<span class="sd">                    If True, will add the (required!) padding to the bounding</span>
<span class="sd">                    box.</span>

<span class="sd">        """</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bbox</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">bbox</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Expected (3, 2) bounding box, got </span><span class="si">{</span><span class="n">bbox</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Set use_cache=True -&gt; this also prepares the cache array(s)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_cache</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">:</span>
                <span class="n">spacing</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"spacing"</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">spacing</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"spacing"</span><span class="p">]</span>

            <span class="c1"># Note that we invert because spacing is given in (z, y, x)</span>
            <span class="n">bbox_vxl</span> <span class="o">=</span> <span class="p">(</span><span class="n">bbox</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">spacing</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="c1"># Digitize into voxels</span>
            <span class="n">bbox_vxl</span> <span class="o">=</span> <span class="n">bbox_vxl</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">padding</span><span class="p">:</span>
                <span class="n">bbox_vxl</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">2</span>
                <span class="n">bbox_vxl</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span>

            <span class="c1"># Make sure we are within bounds</span>
            <span class="n">bbox_vxl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">bbox_vxl</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

            <span class="c1"># Extract values</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">bbox_vxl</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

            <span class="c1"># Cache values in this bounding box</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">:</span>
                <span class="n">read_from</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">read_from</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">z1</span><span class="p">:</span><span class="n">z2</span><span class="p">,</span> <span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_from</span><span class="p">[</span><span class="n">z1</span><span class="p">:</span><span class="n">z2</span><span class="p">,</span> <span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cached</span><span class="p">[</span><span class="n">z1</span><span class="p">:</span><span class="n">z2</span><span class="p">,</span> <span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"H5transform"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Generate H5transform from file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath :  str</span>
<span class="sd">                    Path to H5 transform.</span>
<span class="sd">        **kwargs</span>
<span class="sd">                    Keyword arguments passed to H5transform.__init__</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        H5transform</span>

<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">H5transform</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">xform</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">affine_fallback</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">force_deform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Xform data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        points :            (N, 3) numpy array | pandas.DataFrame</span>
<span class="sd">                            Points to xform. DataFrame must have x/y/z columns.</span>
<span class="sd">        affine_fallback :   bool</span>
<span class="sd">                            If False, points outside the deformation field will</span>
<span class="sd">                            be returned as `np.nan`. If True, these points will</span>
<span class="sd">                            only receive the affine part of the transformation.</span>
<span class="sd">        force_deform :      bools</span>
<span class="sd">                            If True, points outside the deformation field be</span>
<span class="sd">                            deformed using the closest point inside the</span>
<span class="sd">                            deformation field. Ignored if `affine_fallback` is</span>
<span class="sd">                            `False`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pointsxf :      (N, 3) numpy array</span>
<span class="sd">                        Transformed points. Points outside the deformation field</span>
<span class="sd">                        will have only the affine part of the transform applied.</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="c1"># Make sure x/y/z columns are present</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">points</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"z"</span><span class="p">]]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"points DataFrame must have x/y/z columns."</span><span class="p">)</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="p">[[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"z"</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">points</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span>
            <span class="ow">or</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">"`points` must be numpy array of shape (N, 3) or "</span>
                <span class="s2">"pandas DataFrame with x/y/z columns"</span>
            <span class="p">)</span>

        <span class="c1"># Read the file</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">:</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span>

            <span class="c1"># We need the field to be (z, y, x, offsets) with `offsets` being</span>
            <span class="c1"># three values - for example: (293, 470, 1010, 3)</span>
            <span class="c1"># If that's not the case, something is fishy!</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">"Expected the deformation field to be of shape "</span>
                    <span class="sa">f</span><span class="s2">"(z, y, x, 3), got </span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">."</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="s2">"affine"</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="c1"># The affine part of the transform is a 4 x 4 matrix where the upper</span>
                <span class="c1"># 3 x 4 part (row x columns) is an attribute of the h5 dataset</span>
                <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"affine"</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                <span class="n">affine</span> <span class="o">=</span> <span class="n">AffineTransform</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">affine</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Get quantization multiplier for later use</span>
            <span class="n">quantization_multiplier</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"quantization_multiplier"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># For inverse direction, the affine part is applied first</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="s2">"inverse"</span> <span class="ow">and</span> <span class="n">affine</span><span class="p">:</span>
                <span class="n">xf</span> <span class="o">=</span> <span class="n">affine</span><span class="o">.</span><span class="n">xform</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xf</span> <span class="o">=</span> <span class="n">points</span>

            <span class="c1"># Translate points into voxel space</span>
            <span class="n">spacing</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"spacing"</span><span class="p">]</span>
            <span class="c1"># Note that we invert because spacing is given in (z, y, x)</span>
            <span class="n">xf_voxel</span> <span class="o">=</span> <span class="n">xf</span> <span class="o">/</span> <span class="n">spacing</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># Digitize points into voxels</span>
            <span class="n">xf_indices</span> <span class="o">=</span> <span class="n">xf_voxel</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="c1"># Determine the bounding box of the deformation vectors we need</span>
            <span class="c1"># Note that we are grabbing a bit more than required - this is</span>
            <span class="c1"># necessary for interpolation later down the line</span>
            <span class="n">mn</span> <span class="o">=</span> <span class="n">xf_indices</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="n">mx</span> <span class="o">=</span> <span class="n">xf_indices</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>

            <span class="c1"># Make sure we are within bounds</span>
            <span class="c1"># Note that we clip `mn` at 0 and `mx` at 2 at the lower end?</span>
            <span class="c1"># This is to make sure we have enough of the deformation field</span>
            <span class="c1"># to interpolate later on `offsets`</span>
            <span class="n">mn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">mn</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="n">mx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">mx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>

            <span class="c1"># Check if we can use cached values</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_cache</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_fully_ingested"</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cached</span><span class="p">[</span><span class="n">mn</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="p">):</span>
                <span class="n">offsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">mn</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Load the deformation values for this bounding box</span>
                <span class="c1"># This is faster than grabbing individual voxels and</span>
                <span class="n">offsets</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="n">mn</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_cache</span><span class="p">:</span>
                    <span class="c1"># Write these offsets to cache</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">mn</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">offsets</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cached</span><span class="p">[</span><span class="n">mn</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># For interpolation, we need to split the offsets into their x, y</span>
        <span class="c1"># and z component</span>
        <span class="n">xgrid</span> <span class="o">=</span> <span class="n">offsets</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">ygrid</span> <span class="o">=</span> <span class="n">offsets</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">zgrid</span> <span class="o">=</span> <span class="n">offsets</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span>

        <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mx</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">zz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mn</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mx</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># The RegularGridInterpolator is the fastest one but the results are</span>
        <span class="c1"># are ever so slightly (4th decimal) different from the Java implementation</span>
        <span class="n">xinterp</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">(</span>
            <span class="p">(</span><span class="n">zz</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="p">),</span> <span class="n">xgrid</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        <span class="n">yinterp</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">(</span>
            <span class="p">(</span><span class="n">zz</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="p">),</span> <span class="n">ygrid</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        <span class="n">zinterp</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">(</span>
            <span class="p">(</span><span class="n">zz</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="p">),</span> <span class="n">zgrid</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="c1"># Before we interpolate check how many points are outside the</span>
        <span class="c1"># deformation field -&gt; these will only receive the affine part of the</span>
        <span class="c1"># transform</span>
        <span class="n">is_out</span> <span class="o">=</span> <span class="p">(</span><span class="n">xf_voxel</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
            <span class="n">xf_voxel</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>

        <span class="c1"># If more than 20% (arbitrary number) of voxels are out, there is</span>
        <span class="c1"># something suspicious going on</span>
        <span class="n">frac_out</span> <span class="o">=</span> <span class="n">is_out</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">xf_voxel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">frac_out</span> <span class="o">&gt;</span> <span class="mf">0.2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_silenced_large_out_warning"</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"A suspiciously large fraction (</span><span class="si">{</span><span class="n">frac_out</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">) "</span>
                <span class="sa">f</span><span class="s2">"of </span><span class="si">{</span><span class="n">xf_voxel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> points appear to be outside "</span>
                <span class="s2">"the H5 deformation field. Please make doubly sure "</span>
                <span class="s2">"that the input coordinates are in the correct "</span>
                <span class="s2">"space/units"</span>
            <span class="p">)</span>
        <span class="c1"># If all points are outside the volume, the interpolation complains</span>
        <span class="k">if</span> <span class="n">frac_out</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="n">force_deform</span> <span class="ow">and</span> <span class="n">affine_fallback</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">force_deform</span><span class="p">:</span>
                <span class="c1"># For the purpose of finding offsets, we will snap points</span>
                <span class="c1"># outside the deformation field to the closest inside voxel</span>
                <span class="n">q_voxel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
                    <span class="n">xf_voxel</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">q_voxel</span> <span class="o">=</span> <span class="n">xf_voxel</span>

            <span class="c1"># Interpolate coordinates and re-combine to an x/y/z array</span>
            <span class="n">offset_vxl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">xinterp</span><span class="p">(</span><span class="n">q_voxel</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s2">"linear"</span><span class="p">),</span>
                    <span class="n">yinterp</span><span class="p">(</span><span class="n">q_voxel</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s2">"linear"</span><span class="p">),</span>
                    <span class="n">zinterp</span><span class="p">(</span><span class="n">q_voxel</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s2">"linear"</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">T</span>

            <span class="c1"># Turn offsets into real-world coordinates</span>
            <span class="n">offset_real</span> <span class="o">=</span> <span class="n">offset_vxl</span> <span class="o">*</span> <span class="n">quantization_multiplier</span>

            <span class="c1"># Apply offsets</span>
            <span class="c1"># Please note that we must not use += here</span>
            <span class="c1"># That's to avoid running into data type errors where numpy</span>
            <span class="c1"># will refuse to add e.g. float64 to int64.</span>
            <span class="c1"># By using "+" instead of "+=" we are creating a new array that</span>
            <span class="c1"># is potentially upcast from e.g. int64 to float64</span>
            <span class="n">xf</span> <span class="o">=</span> <span class="n">xf</span> <span class="o">+</span> <span class="n">offset_real</span>

        <span class="c1"># For forward direction, the affine part is applied last</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="s2">"forward"</span> <span class="ow">and</span> <span class="n">affine</span><span class="p">:</span>
            <span class="n">xf</span> <span class="o">=</span> <span class="n">affine</span><span class="o">.</span><span class="n">xform</span><span class="p">(</span><span class="n">xf</span><span class="p">)</span>

        <span class="c1"># If no affine_fallback, set outside points to np.nan</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">affine_fallback</span><span class="p">:</span>
            <span class="n">xf</span><span class="p">[</span><span class="n">is_out</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">return</span> <span class="n">xf</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">xform_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">image_res</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
        <span class="n">out_res</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">out_shape</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">order</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"constant"</span><span class="p">,</span>
        <span class="n">cval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Transform a 3D image using backward mapping.</span>

<span class="sd">        If available, this method will use `numba` to accelerate the</span>
<span class="sd">        transformation. This is highly recommended as it can speed up</span>
<span class="sd">        the transformation by several orders of magnitude:</span>

<span class="sd">          pip install numba</span>

<span class="sd">        Note though that the numba-accelerated path only supports linear</span>
<span class="sd">        interpolation and constant-mode boundary handling (default).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        image :         (N, M, K) numpy array</span>
<span class="sd">                        Image to be transformed.</span>
<span class="sd">        image_res :     (3, ) tuple | list</span>
<span class="sd">                        Voxel resolution of the input image.</span>
<span class="sd">        out_res :       (3, ) tuple | list, optional</span>
<span class="sd">                        Voxel resolution of the output image. If None, assumed</span>
<span class="sd">                        to be the same as `image_res`.</span>
<span class="sd">        out_shape :     (3, ) tuple | list, optional</span>
<span class="sd">                        Shape of the output image in voxels. If None, uses the</span>
<span class="sd">                        shape of the deformation field. This works as long as</span>
<span class="sd">                        the deformation field fully samples the target space.</span>
<span class="sd">        order :         int</span>
<span class="sd">                        The order of the spline interpolation, default is 1</span>
<span class="sd">                        (linear). The order has to be in the range 0-5.</span>
<span class="sd">        mode :          str</span>
<span class="sd">                        How to handle values outside the image bounds.</span>
<span class="sd">                        Default is 'constant' (pad with cval).</span>
<span class="sd">        cval :          float</span>
<span class="sd">                        Value used for points outside the boundaries when</span>
<span class="sd">                        mode='constant'.</span>
<span class="sd">        chunk_size :    int</span>
<span class="sd">                        Size of chunks to process along each dimension.</span>
<span class="sd">                        Larger chunks are faster but use more memory.</span>
<span class="sd">                        Only relevant for Python (not numba) path.</span>
<span class="sd">        cache :         bool</span>
<span class="sd">                        If True, we will cache the deformation field for</span>
<span class="sd">                        subsequent future transforms. This is generally</span>
<span class="sd">                        recommended unless memory is very tight or the</span>
<span class="sd">                        deformation field is huge.</span>
<span class="sd">        progress :      bool</span>
<span class="sd">                        Whether to show a progress bar during processing.</span>
<span class="sd">                        Not available (and probably not necessary) if</span>
<span class="sd">                        numba-accelerated path is used.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        transformed :   (N, M, K) numpy array</span>
<span class="sd">                        Transformed image in target space. The shape is</span>
<span class="sd">                        determined by `out_shape` and `out_res`.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method uses backward mapping: for each output chunk, we compute</span>
<span class="sd">        where the voxels came from in the source image using the transformation,</span>
<span class="sd">        then interpolate the source image at those locations. So if your</span>
<span class="sd">        transform goes from A -&gt; B, this method actually uses the inverse transform</span>
<span class="sd">        under the hood to figure out where in A the voxels in B come from.</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"`image` must be a 3D numpy array"</span><span class="p">)</span>

        <span class="c1"># Because we are using backward mapping, we need to invert the transform,</span>
        <span class="c1"># i.e. we're taking points in the target space, mapping them back to the</span>
        <span class="c1"># source space and sampling the source image at those locations)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_inverted_copy"</span><span class="p">):</span>
            <span class="c1"># We're tracking the copy so that we can use the cache for subsequent</span>
            <span class="c1"># transformations instead of having to re-read the file and re-ingest</span>
            <span class="c1"># the deformation field</span>
            <span class="n">reg_inv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inverted_copy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reg_inv</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span>
            <span class="c1"># If cache, track the inverted copy (and the deformation field)</span>
            <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
                <span class="n">reg_inv</span><span class="o">.</span><span class="n">use_cache</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_inverted_copy</span> <span class="o">=</span> <span class="n">reg_inv</span>

        <span class="k">if</span> <span class="n">out_res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out_res</span> <span class="o">=</span> <span class="n">image_res</span>

        <span class="k">if</span> <span class="n">out_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Bounds in physical space</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">reg_inv</span><span class="o">.</span><span class="n">shape</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">reg_inv</span><span class="o">.</span><span class="n">spacing</span>
            <span class="c1"># Back to voxel space in output resolution</span>
            <span class="n">out_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">bounds</span> <span class="o">/</span> <span class="n">out_res</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Generate the empty output array</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">out_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">.h5reg_numba</span><span class="w"> </span><span class="kn">import</span> <span class="n">h5reg_warp_image_linear_constant</span>

            <span class="n">nb_available</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
            <span class="n">nb_available</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Numba path: linear interpolation + constant mode only but much faster</span>
        <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">"constant"</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">nb_available</span><span class="p">:</span>
                <span class="k">global</span> <span class="n">NUMBA_WARNING</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">NUMBA_WARNING</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">"For faster transforming of images, please install numba:</span><span class="se">\n</span><span class="s2">"</span>
                        <span class="s2">"  pip install numba"</span>
                    <span class="p">)</span>
                    <span class="n">NUMBA_WARNING</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reg_inv</span><span class="o">.</span><span class="n">full_ingest</span><span class="p">()</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">reg_inv</span><span class="o">.</span><span class="n">cache</span>

                <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">reg_inv</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">reg_inv</span><span class="o">.</span><span class="n">level</span><span class="p">:</span>
                        <span class="n">ds</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="n">reg_inv</span><span class="o">.</span><span class="n">level</span><span class="p">][</span><span class="n">reg_inv</span><span class="o">.</span><span class="n">field</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ds</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="n">reg_inv</span><span class="o">.</span><span class="n">field</span><span class="p">]</span>

                    <span class="n">spacing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"spacing"</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                    <span class="n">qmult</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"quantization_multiplier"</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

                    <span class="k">if</span> <span class="s2">"affine"</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                        <span class="n">affine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                        <span class="n">affine</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"affine"</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                        <span class="n">apply_affine</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">reg_inv</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="s2">"inverse"</span> <span class="k">else</span> <span class="mi">2</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">affine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                        <span class="n">apply_affine</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">return</span> <span class="n">h5reg_warp_image_linear_constant</span><span class="p">(</span>
                    <span class="n">image</span><span class="p">,</span>
                    <span class="n">field</span><span class="p">,</span>
                    <span class="n">spacing</span><span class="p">,</span>
                    <span class="n">qmult</span><span class="p">,</span>
                    <span class="n">affine</span><span class="p">,</span>
                    <span class="n">apply_affine</span><span class="p">,</span>
                    <span class="n">out</span><span class="p">,</span>
                    <span class="n">out_res</span><span class="p">,</span>
                    <span class="n">image_res</span><span class="p">,</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">cval</span><span class="p">),</span>
                <span class="p">)</span>

        <span class="c1"># Pre-compute prefilter if needed for higher order interpolation</span>
        <span class="k">if</span> <span class="n">order</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">spline_filter</span>

            <span class="n">image</span> <span class="o">=</span> <span class="n">spline_filter</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">trange</span><span class="p">(</span>
            <span class="n">out_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">progress</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">pbar_hide</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">"Warping image"</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="c1"># Generate a grid of points in target voxel space for this z-slice</span>
            <span class="n">chunk_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span>
                <span class="mi">0</span> <span class="p">:</span> <span class="n">out_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">out_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z</span> <span class="p">:</span> <span class="n">z</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="p">]</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">chunk_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                    <span class="n">chunk_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                    <span class="n">chunk_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="p">],</span>
                <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Convert to physical space</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">*</span> <span class="n">out_res</span>

            <span class="c1"># Transform points to source space using the inverse transform</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">reg_inv</span><span class="o">.</span><span class="n">_silenced_large_out_warning</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">points_xf</span> <span class="o">=</span> <span class="n">reg_inv</span><span class="o">.</span><span class="n">xform</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">reg_inv</span><span class="o">.</span><span class="n">_silenced_large_out_warning</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">raise</span> <span class="n">e</span>

            <span class="c1"># Convert back to voxel space in source image</span>
            <span class="n">points_xf_vox</span> <span class="o">=</span> <span class="n">points_xf</span> <span class="o">/</span> <span class="n">image_res</span>

            <span class="c1"># Sample the source image at these transformed coordinates</span>
            <span class="n">sampled_values</span> <span class="o">=</span> <span class="n">map_coordinates</span><span class="p">(</span>
                <span class="n">image</span><span class="p">,</span>
                <span class="p">[</span><span class="n">points_xf_vox</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">points_xf_vox</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">points_xf_vox</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]],</span>
                <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">"constant"</span><span class="p">,</span>
                <span class="n">cval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Reshape back to 2D and assign to this slice of the output image</span>
            <span class="n">out</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="n">sampled_values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">out_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">out_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></tbody></table></div> </details> <div class="doc doc-children"> <div class="doc doc-object doc-attribute"> <h3 id="navis.transforms.H5transform.quantization_multiplier" class="doc doc-heading"> <code class="highlight language-python"><span class="n">quantization_multiplier</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> </span> <a href="#navis.transforms.H5transform.quantization_multiplier" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Quantization multiplier of the deformation field.</p> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id="navis.transforms.H5transform.shape" class="doc doc-heading"> <code class="highlight language-python"><span class="n">shape</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> <small class="doc doc-label doc-label-writable"><code>writable</code></small> </span> <a href="#navis.transforms.H5transform.shape" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Shape of the deformation field.</p> <p>Note that the deformation field is likely to be (z, y, x, 3) where the last dimension contains the x/y/z offsets.</p> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id="navis.transforms.H5transform.spacing" class="doc doc-heading"> <code class="highlight language-python"><span class="n">spacing</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> </span> <a href="#navis.transforms.H5transform.spacing" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Voxel spacing of the deformation field (z, y, x).</p> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id="navis.transforms.H5transform.use_cache" class="doc doc-heading"> <code class="highlight language-python"><span class="n">use_cache</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> <small class="doc doc-label doc-label-writable"><code>writable</code></small> </span> <a href="#navis.transforms.H5transform.use_cache" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Whether to cache the deformation field.</p> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.H5transform.__init__" class="doc doc-heading"> <code class="highlight language-python"><span class="fm">__init__</span></code> <a href="#navis.transforms.H5transform.__init__" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Init class.</p> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/h5reg.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">f</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"forward"</span><span class="p">,</span>
    <span class="n">level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">full_ingest</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">"""Init class."""</span>
    <span class="k">assert</span> <span class="n">direction</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">"forward"</span><span class="p">,</span> <span class="s2">"inverse"</span><span class="p">),</span> <span class="p">(</span>
        <span class="s1">'`direction` must be "forward"'</span> <span class="sa">f</span><span class="s1">'or "inverse", not "</span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s1">"'</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">f</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"forward"</span><span class="p">:</span> <span class="s2">"dfield"</span><span class="p">,</span> <span class="s2">"inverse"</span><span class="p">:</span> <span class="s2">"invdfield"</span><span class="p">}[</span><span class="n">direction</span><span class="p">]</span>

    <span class="c1"># Trying to avoid the file repeatedly so we are making these initial</span>
    <span class="c1"># adjustments all in one go even though it would be more Pythonic to</span>
    <span class="c1"># delegate to property getter/setter methods</span>
    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
        <span class="c1"># Get the available levels</span>
        <span class="n">available_levels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">h5</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">available_levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="n">available_levels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">available_levels</span><span class="p">)</span>

        <span class="c1"># Check if there are indeed deformation fields at various resolutions</span>
        <span class="k">if</span> <span class="n">available_levels</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
                <span class="n">level</span> <span class="o">=</span> <span class="n">available_levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ix</span> <span class="o">=</span> <span class="n">level</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">level</span> <span class="o">=</span> <span class="n">available_levels</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>

            <span class="c1"># Set level</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_level</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

            <span class="c1"># Shape of deformation field</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>

            <span class="c1"># Data type of deformation field</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="ow">in</span> <span class="n">h5</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># Set level</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_level</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Shape of deformation field</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>

            <span class="c1"># Data type of deformation field</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">"Unable to parse deformation fields from "</span> <span class="sa">f</span><span class="s2">" </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="si">}</span><span class="s2">."</span>
            <span class="p">)</span>

    <span class="c1"># Prepare cache if applicable</span>
    <span class="k">if</span> <span class="n">full_ingest</span><span class="p">:</span>
        <span class="c1"># Ingest the whole deformation field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_ingest</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">cache</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_cache</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.H5transform.copy" class="doc doc-heading"> <code class="highlight language-python"><span class="n">copy</span></code> <a href="#navis.transforms.H5transform.copy" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Return copy.</p> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/h5reg.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Return copy."""</span>
    <span class="k">return</span> <span class="n">H5transform</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span>
        <span class="n">direction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span>
        <span class="n">level</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_cache</span><span class="p">,</span>
        <span class="n">full_ingest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.H5transform.from_file" class="doc doc-heading"> <code class="highlight language-python"><span class="n">from_file</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small> </span> <a href="#navis.transforms.H5transform.from_file" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Generate H5transform from file.</p> <table> <thead> <tr> <th><span class="doc-section-title">PARAMETER</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>filepath</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>    Path to H5 transform.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> str</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>**kwargs</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>    Keyword arguments passed to H5transform.__init__
</code></pre></div> </div> <p> <span class="doc-param-default"> <b>DEFAULT:</b> <code>{}</code> </span> </p> </td> </tr> </tbody> </table> <table> <thead> <tr> <th><span class="doc-section-title">RETURNS</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <span class="doc-returns-annotation"> <code><a class="autorefs autorefs-internal" title="navis.transforms.H5transform (navis.transforms.h5reg.H5transform)" href="#navis.transforms.H5transform">H5transform</a></code> </span> </td> <td class="doc-returns-details"> <div class="doc-md-description"> </div> </td> </tr> </tbody> </table> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/h5reg.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"H5transform"</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Generate H5transform from file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filepath :  str</span>
<span class="sd">                Path to H5 transform.</span>
<span class="sd">    **kwargs</span>
<span class="sd">                Keyword arguments passed to H5transform.__init__</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    H5transform</span>

<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">H5transform</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.H5transform.full_ingest" class="doc doc-heading"> <code class="highlight language-python"><span class="n">full_ingest</span></code> <a href="#navis.transforms.H5transform.full_ingest" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Fully ingest the deformation field.</p> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/h5reg.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">full_ingest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Fully ingest the deformation field."""</span>
    <span class="c1"># Skip if already ingested</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_fully_ingested"</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
        <span class="c1"># Read in the entire field</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="c1"># Keep a flag of this</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fully_ingested</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># We set `cached` to True instead of using a mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cached</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Keep track of the caching</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_cache</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.H5transform.precache" class="doc doc-heading"> <code class="highlight language-python"><span class="n">precache</span></code> <a href="#navis.transforms.H5transform.precache" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Cache deformation field for given bounding box.</p> <table> <thead> <tr> <th><span class="doc-section-title">PARAMETER</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>bbox</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>    Must be `[[x1, x2], [y1, y2], [z1, z2]]`.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> list | array</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>padding</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>    If True, will add the (required!) padding to the bounding
    box.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> bool</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>True</code> </span> </p> </td> </tr> </tbody> </table> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/h5reg.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">precache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bbox</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Cache deformation field for given bounding box.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bbox :      list | array</span>
<span class="sd">                Must be `[[x1, x2], [y1, y2], [z1, z2]]`.</span>
<span class="sd">    padding :   bool</span>
<span class="sd">                If True, will add the (required!) padding to the bounding</span>
<span class="sd">                box.</span>

<span class="sd">    """</span>
    <span class="n">bbox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bbox</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">bbox</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Expected (3, 2) bounding box, got </span><span class="si">{</span><span class="n">bbox</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="c1"># Set use_cache=True -&gt; this also prepares the cache array(s)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use_cache</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">:</span>
            <span class="n">spacing</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"spacing"</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spacing</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"spacing"</span><span class="p">]</span>

        <span class="c1"># Note that we invert because spacing is given in (z, y, x)</span>
        <span class="n">bbox_vxl</span> <span class="o">=</span> <span class="p">(</span><span class="n">bbox</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">spacing</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="c1"># Digitize into voxels</span>
        <span class="n">bbox_vxl</span> <span class="o">=</span> <span class="n">bbox_vxl</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">padding</span><span class="p">:</span>
            <span class="n">bbox_vxl</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">2</span>
            <span class="n">bbox_vxl</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span>

        <span class="c1"># Make sure we are within bounds</span>
        <span class="n">bbox_vxl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">bbox_vxl</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Extract values</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">bbox_vxl</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="c1"># Cache values in this bounding box</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">:</span>
            <span class="n">read_from</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">read_from</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">z1</span><span class="p">:</span><span class="n">z2</span><span class="p">,</span> <span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_from</span><span class="p">[</span><span class="n">z1</span><span class="p">:</span><span class="n">z2</span><span class="p">,</span> <span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cached</span><span class="p">[</span><span class="n">z1</span><span class="p">:</span><span class="n">z2</span><span class="p">,</span> <span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.H5transform.xform" class="doc doc-heading"> <code class="highlight language-python"><span class="n">xform</span></code> <a href="#navis.transforms.H5transform.xform" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Xform data.</p> <table> <thead> <tr> <th><span class="doc-section-title">PARAMETER</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>points</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>            Points to xform. DataFrame must have x/y/z columns.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> (N, 3) numpy array | pandas.DataFrame</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>affine_fallback</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>            If False, points outside the deformation field will
            be returned as `np.nan`. If True, these points will
            only receive the affine part of the transformation.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> bool</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>True</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>force_deform</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>            If True, points outside the deformation field be
            deformed using the closest point inside the
            deformation field. Ignored if `affine_fallback` is
            `False`.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> bools</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>True</code> </span> </p> </td> </tr> </tbody> </table> <table> <thead> <tr> <th><span class="doc-section-title">RETURNS</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>pointsxf</code> </td> <td class="doc-returns-details"> <div class="doc-md-description"> <p>Transformed points. Points outside the deformation field will have only the affine part of the transform applied.</p> </div> <p> <span class="doc-returns-annotation"> <b>TYPE:</b> <code>(N, 3) numpy array</code> </span> </p> </td> </tr> </tbody> </table> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/h5reg.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">xform</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">affine_fallback</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">force_deform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Xform data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    points :            (N, 3) numpy array | pandas.DataFrame</span>
<span class="sd">                        Points to xform. DataFrame must have x/y/z columns.</span>
<span class="sd">    affine_fallback :   bool</span>
<span class="sd">                        If False, points outside the deformation field will</span>
<span class="sd">                        be returned as `np.nan`. If True, these points will</span>
<span class="sd">                        only receive the affine part of the transformation.</span>
<span class="sd">    force_deform :      bools</span>
<span class="sd">                        If True, points outside the deformation field be</span>
<span class="sd">                        deformed using the closest point inside the</span>
<span class="sd">                        deformation field. Ignored if `affine_fallback` is</span>
<span class="sd">                        `False`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pointsxf :      (N, 3) numpy array</span>
<span class="sd">                    Transformed points. Points outside the deformation field</span>
<span class="sd">                    will have only the affine part of the transform applied.</span>

<span class="sd">    """</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="c1"># Make sure x/y/z columns are present</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">points</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"z"</span><span class="p">]]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"points DataFrame must have x/y/z columns."</span><span class="p">)</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="p">[[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"z"</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">points</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span>
        <span class="ow">or</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">"`points` must be numpy array of shape (N, 3) or "</span>
            <span class="s2">"pandas DataFrame with x/y/z columns"</span>
        <span class="p">)</span>

    <span class="c1"># Read the file</span>
    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">]</span>

        <span class="c1"># We need the field to be (z, y, x, offsets) with `offsets` being</span>
        <span class="c1"># three values - for example: (293, 470, 1010, 3)</span>
        <span class="c1"># If that's not the case, something is fishy!</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">"Expected the deformation field to be of shape "</span>
                <span class="sa">f</span><span class="s2">"(z, y, x, 3), got </span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">."</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="s2">"affine"</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="c1"># The affine part of the transform is a 4 x 4 matrix where the upper</span>
            <span class="c1"># 3 x 4 part (row x columns) is an attribute of the h5 dataset</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
            <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"affine"</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">affine</span> <span class="o">=</span> <span class="n">AffineTransform</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">affine</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Get quantization multiplier for later use</span>
        <span class="n">quantization_multiplier</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"quantization_multiplier"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># For inverse direction, the affine part is applied first</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="s2">"inverse"</span> <span class="ow">and</span> <span class="n">affine</span><span class="p">:</span>
            <span class="n">xf</span> <span class="o">=</span> <span class="n">affine</span><span class="o">.</span><span class="n">xform</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xf</span> <span class="o">=</span> <span class="n">points</span>

        <span class="c1"># Translate points into voxel space</span>
        <span class="n">spacing</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"spacing"</span><span class="p">]</span>
        <span class="c1"># Note that we invert because spacing is given in (z, y, x)</span>
        <span class="n">xf_voxel</span> <span class="o">=</span> <span class="n">xf</span> <span class="o">/</span> <span class="n">spacing</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Digitize points into voxels</span>
        <span class="n">xf_indices</span> <span class="o">=</span> <span class="n">xf_voxel</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="c1"># Determine the bounding box of the deformation vectors we need</span>
        <span class="c1"># Note that we are grabbing a bit more than required - this is</span>
        <span class="c1"># necessary for interpolation later down the line</span>
        <span class="n">mn</span> <span class="o">=</span> <span class="n">xf_indices</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="n">mx</span> <span class="o">=</span> <span class="n">xf_indices</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>

        <span class="c1"># Make sure we are within bounds</span>
        <span class="c1"># Note that we clip `mn` at 0 and `mx` at 2 at the lower end?</span>
        <span class="c1"># This is to make sure we have enough of the deformation field</span>
        <span class="c1"># to interpolate later on `offsets`</span>
        <span class="n">mn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">mn</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="n">mx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">mx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>

        <span class="c1"># Check if we can use cached values</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_cache</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_fully_ingested"</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cached</span><span class="p">[</span><span class="n">mn</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="p">):</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">mn</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Load the deformation values for this bounding box</span>
            <span class="c1"># This is faster than grabbing individual voxels and</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="n">mn</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_cache</span><span class="p">:</span>
                <span class="c1"># Write these offsets to cache</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">mn</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">offsets</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cached</span><span class="p">[</span><span class="n">mn</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">mx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># For interpolation, we need to split the offsets into their x, y</span>
    <span class="c1"># and z component</span>
    <span class="n">xgrid</span> <span class="o">=</span> <span class="n">offsets</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">ygrid</span> <span class="o">=</span> <span class="n">offsets</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">zgrid</span> <span class="o">=</span> <span class="n">offsets</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mx</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">zz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mn</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mx</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1"># The RegularGridInterpolator is the fastest one but the results are</span>
    <span class="c1"># are ever so slightly (4th decimal) different from the Java implementation</span>
    <span class="n">xinterp</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">(</span>
        <span class="p">(</span><span class="n">zz</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="p">),</span> <span class="n">xgrid</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>
    <span class="n">yinterp</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">(</span>
        <span class="p">(</span><span class="n">zz</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="p">),</span> <span class="n">ygrid</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>
    <span class="n">zinterp</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">(</span>
        <span class="p">(</span><span class="n">zz</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="p">),</span> <span class="n">zgrid</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>

    <span class="c1"># Before we interpolate check how many points are outside the</span>
    <span class="c1"># deformation field -&gt; these will only receive the affine part of the</span>
    <span class="c1"># transform</span>
    <span class="n">is_out</span> <span class="o">=</span> <span class="p">(</span><span class="n">xf_voxel</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
        <span class="n">xf_voxel</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="c1"># If more than 20% (arbitrary number) of voxels are out, there is</span>
    <span class="c1"># something suspicious going on</span>
    <span class="n">frac_out</span> <span class="o">=</span> <span class="n">is_out</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">xf_voxel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">frac_out</span> <span class="o">&gt;</span> <span class="mf">0.2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_silenced_large_out_warning"</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"A suspiciously large fraction (</span><span class="si">{</span><span class="n">frac_out</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">) "</span>
            <span class="sa">f</span><span class="s2">"of </span><span class="si">{</span><span class="n">xf_voxel</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> points appear to be outside "</span>
            <span class="s2">"the H5 deformation field. Please make doubly sure "</span>
            <span class="s2">"that the input coordinates are in the correct "</span>
            <span class="s2">"space/units"</span>
        <span class="p">)</span>
    <span class="c1"># If all points are outside the volume, the interpolation complains</span>
    <span class="k">if</span> <span class="n">frac_out</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="n">force_deform</span> <span class="ow">and</span> <span class="n">affine_fallback</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">force_deform</span><span class="p">:</span>
            <span class="c1"># For the purpose of finding offsets, we will snap points</span>
            <span class="c1"># outside the deformation field to the closest inside voxel</span>
            <span class="n">q_voxel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
                <span class="n">xf_voxel</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q_voxel</span> <span class="o">=</span> <span class="n">xf_voxel</span>

        <span class="c1"># Interpolate coordinates and re-combine to an x/y/z array</span>
        <span class="n">offset_vxl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">xinterp</span><span class="p">(</span><span class="n">q_voxel</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s2">"linear"</span><span class="p">),</span>
                <span class="n">yinterp</span><span class="p">(</span><span class="n">q_voxel</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s2">"linear"</span><span class="p">),</span>
                <span class="n">zinterp</span><span class="p">(</span><span class="n">q_voxel</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s2">"linear"</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># Turn offsets into real-world coordinates</span>
        <span class="n">offset_real</span> <span class="o">=</span> <span class="n">offset_vxl</span> <span class="o">*</span> <span class="n">quantization_multiplier</span>

        <span class="c1"># Apply offsets</span>
        <span class="c1"># Please note that we must not use += here</span>
        <span class="c1"># That's to avoid running into data type errors where numpy</span>
        <span class="c1"># will refuse to add e.g. float64 to int64.</span>
        <span class="c1"># By using "+" instead of "+=" we are creating a new array that</span>
        <span class="c1"># is potentially upcast from e.g. int64 to float64</span>
        <span class="n">xf</span> <span class="o">=</span> <span class="n">xf</span> <span class="o">+</span> <span class="n">offset_real</span>

    <span class="c1"># For forward direction, the affine part is applied last</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="s2">"forward"</span> <span class="ow">and</span> <span class="n">affine</span><span class="p">:</span>
        <span class="n">xf</span> <span class="o">=</span> <span class="n">affine</span><span class="o">.</span><span class="n">xform</span><span class="p">(</span><span class="n">xf</span><span class="p">)</span>

    <span class="c1"># If no affine_fallback, set outside points to np.nan</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">affine_fallback</span><span class="p">:</span>
        <span class="n">xf</span><span class="p">[</span><span class="n">is_out</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">return</span> <span class="n">xf</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.H5transform.xform_image" class="doc doc-heading"> <code class="highlight language-python"><span class="n">xform_image</span></code> <a href="#navis.transforms.H5transform.xform_image" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Transform a 3D image using backward mapping.</p> <p>If available, this method will use <code>numba</code> to accelerate the transformation. This is highly recommended as it can speed up the transformation by several orders of magnitude:</p> <p>pip install numba</p> <p>Note though that the numba-accelerated path only supports linear interpolation and constant-mode boundary handling (default).</p> <table> <thead> <tr> <th><span class="doc-section-title">PARAMETER</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>image</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        Image to be transformed.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> (N, M, K) numpy array</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>image_res</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        Voxel resolution of the input image.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> (3, ) tuple | list</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>out_res</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        Voxel resolution of the output image. If None, assumed
        to be the same as `image_res`.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> (3, ) tuple | list</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>None</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>out_shape</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        Shape of the output image in voxels. If None, uses the
        shape of the deformation field. This works as long as
        the deformation field fully samples the target space.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> (3, ) tuple | list</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>None</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>order</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        The order of the spline interpolation, default is 1
        (linear). The order has to be in the range 0-5.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> int</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>1</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>mode</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        How to handle values outside the image bounds.
        Default is 'constant' (pad with cval).
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> str</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>'constant'</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>cval</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        Value used for points outside the boundaries when
        mode='constant'.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> float</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>0</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>chunk_size</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        Size of chunks to process along each dimension.
        Larger chunks are faster but use more memory.
        Only relevant for Python (not numba) path.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> int</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>cache</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        If True, we will cache the deformation field for
        subsequent future transforms. This is generally
        recommended unless memory is very tight or the
        deformation field is huge.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> bool</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>True</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>progress</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>        Whether to show a progress bar during processing.
        Not available (and probably not necessary) if
        numba-accelerated path is used.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> bool</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>True</code> </span> </p> </td> </tr> </tbody> </table> <table> <thead> <tr> <th><span class="doc-section-title">RETURNS</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>transformed</code> </td> <td class="doc-returns-details"> <div class="doc-md-description"> <p>Transformed image in target space. The shape is determined by <code>out_shape</code> and <code>out_res</code>.</p> </div> <p> <span class="doc-returns-annotation"> <b>TYPE:</b> <code>(N, M, K) numpy array</code> </span> </p> </td> </tr> </tbody> </table> <details class="note" open> <summary>Notes</summary> <p>This method uses backward mapping: for each output chunk, we compute where the voxels came from in the source image using the transformation, then interpolate the source image at those locations. So if your transform goes from A -&gt; B, this method actually uses the inverse transform under the hood to figure out where in A the voxels in B come from.</p> </details> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/h5reg.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">xform_image</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">image_res</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span>
    <span class="n">out_res</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">out_shape</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">order</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"constant"</span><span class="p">,</span>
    <span class="n">cval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Transform a 3D image using backward mapping.</span>

<span class="sd">    If available, this method will use `numba` to accelerate the</span>
<span class="sd">    transformation. This is highly recommended as it can speed up</span>
<span class="sd">    the transformation by several orders of magnitude:</span>

<span class="sd">      pip install numba</span>

<span class="sd">    Note though that the numba-accelerated path only supports linear</span>
<span class="sd">    interpolation and constant-mode boundary handling (default).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image :         (N, M, K) numpy array</span>
<span class="sd">                    Image to be transformed.</span>
<span class="sd">    image_res :     (3, ) tuple | list</span>
<span class="sd">                    Voxel resolution of the input image.</span>
<span class="sd">    out_res :       (3, ) tuple | list, optional</span>
<span class="sd">                    Voxel resolution of the output image. If None, assumed</span>
<span class="sd">                    to be the same as `image_res`.</span>
<span class="sd">    out_shape :     (3, ) tuple | list, optional</span>
<span class="sd">                    Shape of the output image in voxels. If None, uses the</span>
<span class="sd">                    shape of the deformation field. This works as long as</span>
<span class="sd">                    the deformation field fully samples the target space.</span>
<span class="sd">    order :         int</span>
<span class="sd">                    The order of the spline interpolation, default is 1</span>
<span class="sd">                    (linear). The order has to be in the range 0-5.</span>
<span class="sd">    mode :          str</span>
<span class="sd">                    How to handle values outside the image bounds.</span>
<span class="sd">                    Default is 'constant' (pad with cval).</span>
<span class="sd">    cval :          float</span>
<span class="sd">                    Value used for points outside the boundaries when</span>
<span class="sd">                    mode='constant'.</span>
<span class="sd">    chunk_size :    int</span>
<span class="sd">                    Size of chunks to process along each dimension.</span>
<span class="sd">                    Larger chunks are faster but use more memory.</span>
<span class="sd">                    Only relevant for Python (not numba) path.</span>
<span class="sd">    cache :         bool</span>
<span class="sd">                    If True, we will cache the deformation field for</span>
<span class="sd">                    subsequent future transforms. This is generally</span>
<span class="sd">                    recommended unless memory is very tight or the</span>
<span class="sd">                    deformation field is huge.</span>
<span class="sd">    progress :      bool</span>
<span class="sd">                    Whether to show a progress bar during processing.</span>
<span class="sd">                    Not available (and probably not necessary) if</span>
<span class="sd">                    numba-accelerated path is used.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    transformed :   (N, M, K) numpy array</span>
<span class="sd">                    Transformed image in target space. The shape is</span>
<span class="sd">                    determined by `out_shape` and `out_res`.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This method uses backward mapping: for each output chunk, we compute</span>
<span class="sd">    where the voxels came from in the source image using the transformation,</span>
<span class="sd">    then interpolate the source image at those locations. So if your</span>
<span class="sd">    transform goes from A -&gt; B, this method actually uses the inverse transform</span>
<span class="sd">    under the hood to figure out where in A the voxels in B come from.</span>

<span class="sd">    """</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"`image` must be a 3D numpy array"</span><span class="p">)</span>

    <span class="c1"># Because we are using backward mapping, we need to invert the transform,</span>
    <span class="c1"># i.e. we're taking points in the target space, mapping them back to the</span>
    <span class="c1"># source space and sampling the source image at those locations)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"_inverted_copy"</span><span class="p">):</span>
        <span class="c1"># We're tracking the copy so that we can use the cache for subsequent</span>
        <span class="c1"># transformations instead of having to re-read the file and re-ingest</span>
        <span class="c1"># the deformation field</span>
        <span class="n">reg_inv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inverted_copy</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">reg_inv</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span>
        <span class="c1"># If cache, track the inverted copy (and the deformation field)</span>
        <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
            <span class="n">reg_inv</span><span class="o">.</span><span class="n">use_cache</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inverted_copy</span> <span class="o">=</span> <span class="n">reg_inv</span>

    <span class="k">if</span> <span class="n">out_res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out_res</span> <span class="o">=</span> <span class="n">image_res</span>

    <span class="k">if</span> <span class="n">out_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Bounds in physical space</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">reg_inv</span><span class="o">.</span><span class="n">shape</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">reg_inv</span><span class="o">.</span><span class="n">spacing</span>
        <span class="c1"># Back to voxel space in output resolution</span>
        <span class="n">out_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">bounds</span> <span class="o">/</span> <span class="n">out_res</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Generate the empty output array</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">out_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.h5reg_numba</span><span class="w"> </span><span class="kn">import</span> <span class="n">h5reg_warp_image_linear_constant</span>

        <span class="n">nb_available</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
        <span class="n">nb_available</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Numba path: linear interpolation + constant mode only but much faster</span>
    <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">"constant"</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nb_available</span><span class="p">:</span>
            <span class="k">global</span> <span class="n">NUMBA_WARNING</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">NUMBA_WARNING</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">"For faster transforming of images, please install numba:</span><span class="se">\n</span><span class="s2">"</span>
                    <span class="s2">"  pip install numba"</span>
                <span class="p">)</span>
                <span class="n">NUMBA_WARNING</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reg_inv</span><span class="o">.</span><span class="n">full_ingest</span><span class="p">()</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">reg_inv</span><span class="o">.</span><span class="n">cache</span>

            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">reg_inv</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">reg_inv</span><span class="o">.</span><span class="n">level</span><span class="p">:</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="n">reg_inv</span><span class="o">.</span><span class="n">level</span><span class="p">][</span><span class="n">reg_inv</span><span class="o">.</span><span class="n">field</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">h5</span><span class="p">[</span><span class="n">reg_inv</span><span class="o">.</span><span class="n">field</span><span class="p">]</span>

                <span class="n">spacing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"spacing"</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                <span class="n">qmult</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"quantization_multiplier"</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

                <span class="k">if</span> <span class="s2">"affine"</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                    <span class="n">affine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                    <span class="n">affine</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"affine"</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
                    <span class="n">apply_affine</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">reg_inv</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="s2">"inverse"</span> <span class="k">else</span> <span class="mi">2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">affine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                    <span class="n">apply_affine</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">return</span> <span class="n">h5reg_warp_image_linear_constant</span><span class="p">(</span>
                <span class="n">image</span><span class="p">,</span>
                <span class="n">field</span><span class="p">,</span>
                <span class="n">spacing</span><span class="p">,</span>
                <span class="n">qmult</span><span class="p">,</span>
                <span class="n">affine</span><span class="p">,</span>
                <span class="n">apply_affine</span><span class="p">,</span>
                <span class="n">out</span><span class="p">,</span>
                <span class="n">out_res</span><span class="p">,</span>
                <span class="n">image_res</span><span class="p">,</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">cval</span><span class="p">),</span>
            <span class="p">)</span>

    <span class="c1"># Pre-compute prefilter if needed for higher order interpolation</span>
    <span class="k">if</span> <span class="n">order</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">spline_filter</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">spline_filter</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">trange</span><span class="p">(</span>
        <span class="n">out_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="n">disable</span><span class="o">=</span><span class="ow">not</span> <span class="n">progress</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">pbar_hide</span><span class="p">,</span>
        <span class="n">desc</span><span class="o">=</span><span class="s2">"Warping image"</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># Generate a grid of points in target voxel space for this z-slice</span>
        <span class="n">chunk_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span>
            <span class="mi">0</span> <span class="p">:</span> <span class="n">out_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">out_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z</span> <span class="p">:</span> <span class="n">z</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">]</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">chunk_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="n">chunk_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="n">chunk_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
            <span class="p">],</span>
            <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Convert to physical space</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">*</span> <span class="n">out_res</span>

        <span class="c1"># Transform points to source space using the inverse transform</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">reg_inv</span><span class="o">.</span><span class="n">_silenced_large_out_warning</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">points_xf</span> <span class="o">=</span> <span class="n">reg_inv</span><span class="o">.</span><span class="n">xform</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">reg_inv</span><span class="o">.</span><span class="n">_silenced_large_out_warning</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="c1"># Convert back to voxel space in source image</span>
        <span class="n">points_xf_vox</span> <span class="o">=</span> <span class="n">points_xf</span> <span class="o">/</span> <span class="n">image_res</span>

        <span class="c1"># Sample the source image at these transformed coordinates</span>
        <span class="n">sampled_values</span> <span class="o">=</span> <span class="n">map_coordinates</span><span class="p">(</span>
            <span class="n">image</span><span class="p">,</span>
            <span class="p">[</span><span class="n">points_xf_vox</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">points_xf_vox</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">points_xf_vox</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]],</span>
            <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">"constant"</span><span class="p">,</span>
            <span class="n">cval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Reshape back to 2D and assign to this slice of the output image</span>
        <span class="n">out</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="n">sampled_values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">out_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">out_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">out</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> </div> </div> </div> <div class="doc doc-object doc-class"> <h2 id="navis.transforms.TPStransform" class="doc doc-heading"> <code>navis.transforms.TPStransform</code> <a href="#navis.transforms.TPStransform" class="headerlink" title="Permanent link">#</a></h2> <div class="doc doc-contents first"> <p>Thin Plate Spline transforms of 3D spatial data.</p> <details class="note" open> <summary>Notes</summary> <p>At least in my hands, <code>TPStransforms</code> are significantly faster than <code>MovingLeastSquaresTransforms</code>. The results are similar but not identical, so make sure to use the one that works best for your use case.</p> </details> <table> <thead> <tr> <th><span class="doc-section-title">PARAMETER</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>landmarks_source</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>            Source landmarks as x/y/z coordinates.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> (M, 3) numpy array</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>landmarks_target</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>            Target landmarks as x/y/z coordinates.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> (M, 3) numpy array</code> </span> </p> </td> </tr> <tr class="doc-section-item"> <td> <code>batch_size</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>            Batch size for transforming points. The
            thin-plate spline generating a (N, M) distance
            matrix, where N is the number of points and M
            is the number of source landmarks. Because
            this can get prohibitively expensive, we're
            batching the transformation by default.
            Please note that the the overhead from batching
            seems negligible.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> int</code> </span> <span class="doc-param-default"> <b>DEFAULT:</b> <code>100000</code> </span> </p> </td> </tr> </tbody> </table> <p><span class="doc-section-title">Examples:</span></p> <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">navis</span><span class="w"> </span><span class="kn">import</span> <span class="n">transforms</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Generate some mock landmarks</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">src</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="p">[</span><span class="mi">80</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">trg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">21</span><span class="p">],</span> <span class="p">[</span><span class="mi">80</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">120</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">80</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">tr</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">thinplate</span><span class="o">.</span><span class="n">TPStransform</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">trg</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">tr</span><span class="o">.</span><span class="n">xform</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
<span class="go">array([[ 1.        , 15.        ,  5.        ],</span>
<span class="go">       [40.55555556, 54.        , 65.        ]])</span>
</code></pre></div> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/thinplate.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TPStransform</span><span class="p">(</span><span class="n">BaseTransform</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Thin Plate Spline transforms of 3D spatial data.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    At least in my hands, `TPStransforms` are significantly faster than</span>
<span class="sd">    `MovingLeastSquaresTransforms`. The results are similar but not identical,</span>
<span class="sd">    so make sure to use the one that works best for your use case.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    landmarks_source :  (M, 3) numpy array</span>
<span class="sd">                        Source landmarks as x/y/z coordinates.</span>
<span class="sd">    landmarks_target :  (M, 3) numpy array</span>
<span class="sd">                        Target landmarks as x/y/z coordinates.</span>
<span class="sd">    batch_size :        int, optional</span>
<span class="sd">                        Batch size for transforming points. The</span>
<span class="sd">                        thin-plate spline generating a (N, M) distance</span>
<span class="sd">                        matrix, where N is the number of points and M</span>
<span class="sd">                        is the number of source landmarks. Because</span>
<span class="sd">                        this can get prohibitively expensive, we're</span>
<span class="sd">                        batching the transformation by default.</span>
<span class="sd">                        Please note that the the overhead from batching</span>
<span class="sd">                        seems negligible.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from navis import transforms</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; # Generate some mock landmarks</span>
<span class="sd">    &gt;&gt;&gt; src = np.array([[0, 0, 0], [10, 10, 10], [100, 100, 100], [80, 10, 30]])</span>
<span class="sd">    &gt;&gt;&gt; trg = np.array([[1, 15, 5], [9, 18, 21], [80, 99, 120], [5, 10, 80]])</span>
<span class="sd">    &gt;&gt;&gt; tr = transforms.thinplate.TPStransform(src, trg)</span>
<span class="sd">    &gt;&gt;&gt; points = np.array([[0, 0, 0], [50, 50, 50]])</span>
<span class="sd">    &gt;&gt;&gt; tr.xform(points)</span>
<span class="sd">    array([[ 1.        , 15.        ,  5.        ],</span>
<span class="sd">           [40.55555556, 54.        , 65.        ]])</span>

<span class="sd">    """</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">landmarks_source</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">landmarks_target</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100_000</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">"""Initialize class."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">landmarks_source</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">landmarks_target</span><span class="p">)</span>

        <span class="c1"># Some checks</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Expected (N, 3) array, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Expected (N, 3) array, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">"Number of source landmarks must match number of target landmarks."</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_W</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_A</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Implement equality comparison."""</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">TPStransform</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">source</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">target</span><span class="p">):</span>
                        <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"TPStransform"</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Invert direction."""</span>
        <span class="c1"># Switch source and target</span>
        <span class="k">return</span> <span class="n">TPStransform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calc_tps_coefs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Calculate thinplate coefficients</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_W</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_A</span> <span class="o">=</span> <span class="n">mops</span><span class="o">.</span><span class="n">tps_coefs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">W</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_W</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
            <span class="c1"># Calculate coefficients</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calc_tps_coefs</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_W</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">A</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_A</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
            <span class="c1"># Calculate coefficients</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calc_tps_coefs</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_A</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">matrix_rigid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Return the rigid transformation matrix."""</span>
        <span class="c1"># The first row in self.A is the translation vector</span>
        <span class="c1"># The next 3x3 block is the rotation matrix</span>
        <span class="c1"># Let's combine these into a typical 4x4 transformation matrix</span>
        <span class="c1"># where the last row is [0, 0, 0, 1]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">m</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">m</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Make copy."""</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">TPStransform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>

        <span class="n">x</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">xform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Transform points.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        points :    (N, 3) array</span>
<span class="sd">                    Points to transform.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pointsxf :  (N, 3) array</span>
<span class="sd">                    Transformed points.</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">points</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"z"</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"DataFrame must have x/y/z columns."</span><span class="p">)</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="p">[[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"z"</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="k">else</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">points_xf</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="c1"># Get the current batch of points</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>

            <span class="c1"># N.B. U is of shape (N, M) where N is the number of points and M is the</span>
            <span class="c1"># number of source landmarks. This can get fairly expensive</span>
            <span class="c1"># (which is precisely why we batch the transformation)!</span>
            <span class="n">U</span> <span class="o">=</span> <span class="n">mops</span><span class="o">.</span><span class="n">K_matrix</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">mops</span><span class="o">.</span><span class="n">P_matrix</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="c1"># The warped pts are the affine part + the non-uniform part</span>
            <span class="n">points_xf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">))</span>

        <span class="c1"># Concatenate all batches</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">points_xf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div> </details> <div class="doc doc-children"> <div class="doc doc-object doc-attribute"> <h3 id="navis.transforms.TPStransform.matrix_rigid" class="doc doc-heading"> <code class="highlight language-python"><span class="n">matrix_rigid</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> </span> <a href="#navis.transforms.TPStransform.matrix_rigid" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Return the rigid transformation matrix.</p> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.TPStransform.__init__" class="doc doc-heading"> <code class="highlight language-python"><span class="fm">__init__</span></code> <a href="#navis.transforms.TPStransform.__init__" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Initialize class.</p> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/thinplate.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">landmarks_source</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">landmarks_target</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100_000</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">"""Initialize class."""</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">landmarks_source</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">landmarks_target</span><span class="p">)</span>

    <span class="c1"># Some checks</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Expected (N, 3) array, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Expected (N, 3) array, got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">"Number of source landmarks must match number of target landmarks."</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_W</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_A</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.TPStransform.copy" class="doc doc-heading"> <code class="highlight language-python"><span class="n">copy</span></code> <a href="#navis.transforms.TPStransform.copy" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Make copy.</p> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/thinplate.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Make copy."""</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">TPStransform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>

    <span class="n">x</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id="navis.transforms.TPStransform.xform" class="doc doc-heading"> <code class="highlight language-python"><span class="n">xform</span></code> <a href="#navis.transforms.TPStransform.xform" class="headerlink" title="Permanent link">#</a></h3> <div class="doc doc-contents "> <p>Transform points.</p> <table> <thead> <tr> <th><span class="doc-section-title">PARAMETER</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>points</code> </td> <td class="doc-param-details"> <div class="doc-md-description"> <div class="highlight"><pre><span></span><code>    Points to transform.
</code></pre></div> </div> <p> <span class="doc-param-annotation"> <b>TYPE:</b> <code> (N, 3) array</code> </span> </p> </td> </tr> </tbody> </table> <table> <thead> <tr> <th><span class="doc-section-title">RETURNS</span></th> <th><span>DESCRIPTION</span></th> </tr> </thead> <tbody> <tr class="doc-section-item"> <td> <code>pointsxf</code> </td> <td class="doc-returns-details"> <div class="doc-md-description"> <p>Transformed points.</p> </div> <p> <span class="doc-returns-annotation"> <b>TYPE:</b> <code>(N, 3) array</code> </span> </p> </td> </tr> </tbody> </table> <details class="mkdocstrings-source"> <summary>Source code in <code>navis/transforms/thinplate.py</code></summary> <div class="highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">xform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Transform points.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    points :    (N, 3) array</span>
<span class="sd">                Points to transform.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pointsxf :  (N, 3) array</span>
<span class="sd">                Transformed points.</span>

<span class="sd">    """</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">points</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"z"</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"DataFrame must have x/y/z columns."</span><span class="p">)</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="p">[[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">,</span> <span class="s2">"z"</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="k">else</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">points_xf</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="c1"># Get the current batch of points</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>

        <span class="c1"># N.B. U is of shape (N, M) where N is the number of points and M is the</span>
        <span class="c1"># number of source landmarks. This can get fairly expensive</span>
        <span class="c1"># (which is precisely why we batch the transformation)!</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">mops</span><span class="o">.</span><span class="n">K_matrix</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">mops</span><span class="o">.</span><span class="n">P_matrix</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="c1"># The warped pts are the affine part + the non-uniform part</span>
        <span class="n">points_xf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">))</span>

    <span class="c1"># Concatenate all batches</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">points_xf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></td></tr></tbody></table></div> </details> </div> </div> </div> </div> </div> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class="md-footer"> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class="md-copyright"> Made with <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener"> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class="md-dialog" data-md-component="dialog"> <div class="md-dialog__inner md-typeset"></div> </div> <div class="md-progress" data-md-component="progress" role="progressbar"></div> <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["content.tabs.link", "content.code.annotate", "navigation.indexes", "navigation.instant", "navigation.instant.progress", "navigation.tabs", "navigation.tabs.sticky", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script> <script src="../../../assets/_markdown_exec_pyodide.js"></script> <script src="../../../javascripts/katex.js"></script> <script src="../../../assets/external/unpkg.com/katex@0/dist/katex.min.js"></script> <script src="../../../assets/external/unpkg.com/katex@0/dist/contrib/auto-render.min.js"></script> <script src="../../../assets/external/unpkg.com/mermaid@11/dist/mermaid.min.js"></script>  <script id="init-glightbox">document.querySelectorAll('.glightbox').forEach(function(element) {
    try {
        var img = element.querySelector('img');
        if (img && img.src) {
            element.setAttribute('href', img.src);
        } else {
            console.log('No img element with src attribute found');
        }
    } catch (error) {
        console.log('Error:', error);
    }
});
const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>